(globalThis.webpackChunk_croquet_microverse=globalThis.webpackChunk_croquet_microverse||[]).push([[128],{3128:(e,t,s)=>{"use strict";s.d(t,{q:()=>MultiBlaster});var i=s(4200),o=s(3654);class MultiBlaster extends o.Z4{get pawn(){return MultiBlasterDisplay}init(e){super.init(e),this.beWellKnownAs("multiBlaster"),this.ships=new Map,this.asteroids=new Set,this.blasts=new Set,this.subscribe(this.sessionId,"view-join",this.viewJoined),this.subscribe(this.sessionId,"view-exit",this.viewExited),this.subscribe(this.sessionId,"switch-pause",this.switchPause),Asteroid.create({}),this.active=!0,this.mainLoop()}switchPause(){console.log("switchPaused!!!!"),this.active=!this.active}viewJoined(e){const t=Ship.create({viewId:e});this.ships.set(e,t)}viewExited(e){const t=this.ships.get(e);this.ships.delete(e),t.destroy()}checkCollisions(){for(const e of this.asteroids){if(e.wasHit)continue;const t=e.x-e.size,s=e.x+e.size,i=e.y-e.size,o=e.y+e.size;for(const r of this.blasts)if(r.x>t&&r.x<s&&r.y>i&&r.y<o){e.hitBy(r);break}for(const r of this.ships.values())if(!r.wasHit&&r.x+10>t&&r.x-10<s&&r.y+10>i&&r.y-10<o){if(!r.score&&Math.abs(r.x-512)+Math.abs(r.y-512)<40)continue;r.hitBy(e);break}}}mainLoop(){if(this.active){for(const e of this.ships.values())e.move();for(const e of this.asteroids)e.move();for(const e of this.blasts)e.move();this.checkCollisions()}this.future(50).mainLoop()}}MultiBlaster.register("MultiBlaster");class Ship extends i.Actor{init({viewId:e}){super.init(),this.viewId=e,this.reset(),this.subscribe(e,"left-thruster",this.leftThruster),this.subscribe(e,"right-thruster",this.rightThruster),this.subscribe(e,"forward-thruster",this.forwardThruster),this.subscribe(e,"fire-blaster",this.fireBlaster)}reset(){this.x=512,this.y=512,this.a=-Math.PI/2,this.dx=0,this.dy=0,this.left=!1,this.right=!1,this.forward=!1,this.score=0,this.wasHit=0}leftThruster(e){this.wasHit||(this.left=e)}rightThruster(e){this.wasHit||(this.right=e)}forwardThruster(e){this.wasHit||(this.forward=e)}fireBlaster(){if(this.wasHit)return;const e=20*Math.cos(this.a),t=20*Math.sin(this.a),s=this.x+e,i=this.y+t;Blast.create({x:s,y:i,dx:e,dy:t,ship:this})}move(){this.wasHit?++this.wasHit>60&&this.reset():(this.forward&&(this.dx+=.5*Math.cos(this.a),this.dy+=.5*Math.sin(this.a),this.dx>10&&(this.dx=10),this.dx<-10&&(this.dx=-10),this.dy>10&&(this.dy=10),this.dy<-10&&(this.dy=-10)),this.left&&(this.a-=.2),this.right&&(this.a+=.2),this.a<0&&(this.a+=2*Math.PI),this.a>2*Math.PI&&(this.a-=2*Math.PI)),this.x+=this.dx,this.y+=this.dy,this.x<0&&(this.x+=1024),this.x>1024&&(this.x-=1024),this.y<0&&(this.y+=1024),this.y>1024&&(this.y-=1024)}hitBy(e){this.wasHit=1,e.wasHit=1}}Ship.register("Ship");class Asteroid extends i.Actor{init({size:e,x:t,y:s,a:i,dx:o,dy:r,da:a}){if(super.init(),e)this.size=e,this.x=t,this.y=s,this.a=i,this.dx=o,this.dy=r,this.da=a;else{this.size=40,this.x=400*Math.random()-200,this.y=400*Math.random()-200,this.a=Math.random()*Math.PI*2;const e=4*Math.random()+1;this.dx=Math.cos(this.a)*e,this.dy=Math.sin(this.a)*e,this.da=(.02+.03*Math.random())*(Math.random()<.5?1:-1),this.wasHit=0,this.move()}this.wellKnownModel("multiBlaster").asteroids.add(this)}move(){this.wasHit&&++this.wasHit>this.size&&this.destroy(),this.x+=this.dx,this.y+=this.dy,this.x<0&&(this.x+=1024),this.x>1024&&(this.x-=1024),this.y<0&&(this.y+=1024),this.y>1024&&(this.y-=1024),this.wasHit||(this.a+=this.da,this.a<0&&(this.a+=2*Math.PI),this.a>2*Math.PI&&(this.a-=2*Math.PI))}hitBy(e){e.ship.wasHit||e.ship.score++,this.size>20?(this.size*=.7,this.da*=1.5,this.dx=10*-e.dy/this.size,this.dy=10*e.dx/this.size,Asteroid.create({size:this.size,x:this.x,y:this.y,a:this.a,dx:-this.dx,dy:-this.dy,da:this.da})):this.wasHit=1,e.destroy()}destroy(){const e=this.wellKnownModel("multiBlaster").asteroids;e.delete(this),super.destroy(),e.size<5&&Asteroid.create({})}}Asteroid.register("Asteroid");class Blast extends i.Actor{init({x:e,y:t,dx:s,dy:i,ship:o}){super.init(),this.ship=o,this.x=e,this.y=t,this.dx=s,this.dy=i,this.t=0,this.wellKnownModel("multiBlaster").blasts.add(this)}move(){++this.t<30?(this.x+=this.dx,this.y+=this.dy,this.x<0&&(this.x+=1024),this.x>1024&&(this.x-=1024),this.y<0&&(this.y+=1024),this.y>1024&&(this.y-=1024)):this.destroy()}destroy(){this.wellKnownModel("multiBlaster").blasts.delete(this),super.destroy()}}Blast.register("Blast");class MultiBlasterDisplay extends o.Df{constructor(e){super(e),this.addEventListener("pointerDown","onPointerDown"),this.addEventListener("pointerMove","onPointerMove"),this.addEventListener("pointerUp","onPointerUp"),this.addEventListener("keyDown","onKeyDown"),this.addEventListener("keyUp","onKeyUp"),this.smoothing=new WeakMap,this.context=this.canvas.getContext("2d"),this.future(50).doUpdate()}onPointerDown(e){e.uv&&(this.joystick=this.uv2xy(e.uv),this.knob=this.joystick)}onPointerMove(e){if(!e.uv)return;this.knob=this.uv2xy(e.uv);let t=this.knob[0]-this.joystick[0],s=this.knob[1]-this.joystick[1];t>30?this.right||(this.publish(this.viewId,"right-thruster",!0),this.right=!0):this.right&&(this.publish(this.viewId,"right-thruster",!1),this.right=!1),t<-30?this.left||(this.publish(this.viewId,"left-thruster",!0),this.left=!0):this.left&&(this.publish(this.viewId,"left-thruster",!1),this.left=!1),s<-30?this.forward||(this.publish(this.viewId,"forward-thruster",!0),this.forward=!0):this.forward&&(this.publish(this.viewId,"forward-thruster",!1),this.forward=!1)}onPointerUp(e){e.uv&&(this.right||this.left||this.forward||this.publish(this.viewId,"fire-blaster"),this.right&&(this.publish(this.viewId,"right-thruster",this.false),this.right=!1),this.left&&(this.publish(this.viewId,"left-thruster",!1),this.left=!1),this.forward&&(this.publish(this.viewId,"forward-thruster",!1),this.forward=!1),this.joystick=null,this.knob=null)}onPointerCancel(e){this.onPointerUp(e)}onKeyDown(e){if(!e.repeat)switch(e.key){case"a":case"A":case"ArrowLeft":this.publish(this.viewId,"left-thruster",!0);break;case"d":case"D":case"ArrowRight":this.publish(this.viewId,"right-thruster",!0);break;case"w":case"W":case"ArrowUp":this.publish(this.viewId,"forward-thruster",!0);break;case" ":this.publish(this.viewId,"fire-blaster");break;case"p":case"P":this.publish(this.actor.sessionId,"switch-pause")}}onKeyUp(e){if(!e.repeat)switch(e.key){case"a":case"A":case"ArrowLeft":this.publish(this.viewId,"left-thruster",!1);break;case"d":case"D":case"ArrowRight":this.publish(this.viewId,"right-thruster",!1);break;case"w":case"W":case"ArrowUp":this.publish(this.viewId,"forward-thruster",!1)}}setup(){}doUpdate(){if(this.actor.active){this.context.clearRect(0,0,1024,1024),this.context.font="40px sans-serif",this.context.fillStyle="rgba(255, 255, 255, 0.5)",this.context.lineWidth=3,this.context.strokeStyle="white";for(const e of this.actor.ships.values()){const{x:t,y:s,a:i}=this.smoothPosAndAngle(e);this.context.save(),this.context.translate(t,s),e.score&&this.context.fillText(e.score,30,15),this.context.rotate(i),e.wasHit?this.drawShipDebris(e.wasHit):this.drawShip(e.forward,e.viewId===this.viewId),this.context.restore()}for(const e of this.actor.asteroids){const{x:t,y:s,a:i}=this.smoothPosAndAngle(e);this.context.save(),this.context.translate(t,s),this.context.rotate(i),e.wasHit?this.drawAsteroidDebris(e.size,2*e.wasHit):this.drawAsteroid(e.size),this.context.restore()}for(const e of this.actor.blasts){const{x:t,y:s}=this.smoothPos(e);this.context.save(),this.context.translate(t,s),this.drawBlast(),this.context.restore()}this.joystick&&this.drawJoystick(),this.texture.needsUpdate=!0}this.future(50).doUpdate()}smoothPos(e){this.smoothing.has(e)||this.smoothing.set(e,{x:e.x,y:e.y,a:e.a});const t=this.smoothing.get(e),s=e.x-t.x,i=e.y-t.y;return Math.abs(s)<50?t.x+=.3*s:t.x=e.x,Math.abs(i)<50?t.y+=.3*i:t.y=e.y,t}smoothPosAndAngle(e){const t=this.smoothPos(e),s=e.a-t.a;return Math.abs(s)<1?t.a+=.3*s:t.a=e.a,t}drawJoystick(){this.drawCircle(this.joystick,50,!1),this.drawCircle(this.knob,25,!0)}drawCircle(e,t,s){this.context.fillStyle="#ffffff",this.context.beginPath(),this.context.arc(e[0],e[1],t,0,2*Math.PI,!0),s?this.context.fill():this.context.stroke()}drawShip(e,t){this.context.beginPath(),this.context.moveTo(20,0),this.context.lineTo(-20,10),this.context.lineTo(-20,-10),this.context.closePath(),this.context.stroke(),t&&this.context.fill(),e&&(this.context.beginPath(),this.context.moveTo(-20,5),this.context.lineTo(-30,0),this.context.lineTo(-20,-5),this.context.stroke())}drawShipDebris(e){this.context.beginPath(),this.context.moveTo(20+e,0+e),this.context.lineTo(-20+e,10+e),this.context.moveTo(-20-1.4*e,10),this.context.lineTo(-20-1.4*e,-10),this.context.moveTo(-20+e,-10-e),this.context.lineTo(20+e,0-e),this.context.stroke()}drawAsteroid(e){this.context.beginPath(),this.context.moveTo(+e,0),this.context.lineTo(0,+e),this.context.lineTo(-e,0),this.context.lineTo(0,-e),this.context.closePath(),this.context.stroke()}drawAsteroidDebris(e,t){this.context.beginPath(),this.context.moveTo(+e+t,0+t),this.context.lineTo(0+t,+e+t),this.context.moveTo(-e-t,0-t),this.context.lineTo(0-t,-e-t),this.context.moveTo(-e-t,0+t),this.context.lineTo(0-t,+e+t),this.context.moveTo(+e+t,0-t),this.context.lineTo(0+t,-e-t),this.context.stroke()}drawBlast(){this.context.beginPath(),this.context.ellipse(0,0,2,2,0,0,2*Math.PI),this.context.closePath(),this.context.stroke()}}},2691:(e,t,s)=>{"use strict";s.d(t,{CN:()=>PM_Pointer,vJ:()=>PM_PointerTarget,w9:()=>AM_PointerTarget});var i=s(4200);const AM_PointerTarget=e=>class extends e{init(e){super.init(e),this.eventListeners=new Map,this.listen("dispatchEvent",this.dispatchEvent)}dispatchEvent(e){let{eventName:t,evt:s}=e,i=this.eventListeners.get(t);i&&i.forEach((e=>{let{moduleName:t,behaviorName:i,listener:o}=e;t&&i?this.call(`${t}$${i}`,o,s):this[o](s)}))}addEventListener(e,t){let s,i,o=t;"function"==typeof t&&(t=t.name);let r=t.indexOf("$");r>=1&&(i=t.slice(0,r),t=t.slice(r+1));let a=t.indexOf(".");a>=1&&(s=t.slice(0,a),t=t.slice(a+1));let n=this._behavior;!i&&n&&(i=n.module.externalName),!s&&n&&(s=n.$behaviorName);let l=this.eventListeners.get(e);l||(l=[],this.eventListeners.set(e,l)),l.findIndex((o=>o.eventName===e&&o.listener===t&&o.moduleName===i&&o.behaviorName===s))>=0&&this.removeEventListener(e,o,!0),l.push({moduleName:i,behaviorName:s,eventName:e,listener:t}),this.say("registerEventListener",{eventName:e,listener:t})}removeEventListener(e,t,s){"function"==typeof t&&(t=t.name);let i=this._behavior.$behaviorName,o=this._behavior.module.externalName,r=this.eventListeners.get(e);if(!r)return;let a=r.findIndex((e=>e.behaviorName===i&&e.moduleName===o&&e.listener===t));a<0||(r.splice(a,1),0===r.length&&(s||this.eventListeners.delete(e),this.say("unregisterEventListener",{eventName:e,listener:t})))}};(0,i.RegisterMixin)(AM_PointerTarget);const PM_PointerTarget=e=>class extends e{constructor(e){super(e),this.eventListeners=new Map,this.modelListeners=new Map,this.listen("registerEventListener","registerEventListener"),this.listen("unregisterEventListener","unregisterEventListener"),this.registerAllEventListeners()}destroy(){let e=this.actor.service("PlayerManager").players.get(this.viewId);const t=(0,i.GetPawn)(e.id);t&&(t.hoverPawn===this&&(t.hoverPawn=null),t.focusPawn===this&&(t.focusPawn=null)),super.destroy()}addEventListener(e,t,s){let i=t;"string"==typeof t?(s=t,t=e=>this[s](e)):s||(s=t.name);let o=this.eventListeners.get(e);o||(o=[],this.eventListeners.set(e,o)),o.find((t=>t.name===s&&t.eventName===e))&&this.removeEventListener(e,i,s),o.push({name:s,eventName:e,listener:t})}removeEventListener(e,t,s){"string"==typeof t?s=t:s||(s=t.name);let i=this.eventListeners.get(e);if(!i)return;let o=i.findIndex((t=>t.name===s&&t.eventName===e));o<0||i.splice(o,1)}registerEventListener(e){let{eventName:t}=e,func=e=>this.say("dispatchEvent",{eventName:t,evt:e});this.modelListeners.set(t,func),this.addEventListener(t,func,`dispatch_${t}`)}unregisterEventListener(e){let{eventName:t,_listener:s}=e,i=this.modelListeners.get(t);i&&this.removeEventListener(t,i,`dispatch_${t}`)}registerAllEventListeners(){if(this.actor.eventListeners)for(let e of this.actor.eventListeners.keys())this.registerEventListener({eventName:e})}},PM_Pointer=e=>class extends e{constructor(e){super(e),this.isMyPlayerPawn&&(this.subscribe("input",{event:"pointerDown",handling:"immediate"},this.doPointerDown),this.subscribe("input",{event:"pointerUp",handling:"immediate"},this.doPointerUp),this.subscribe("input",{event:"pointerMove",handling:"immediate"},this.doPointerMove),this.subscribe("input",{event:"click",handling:"immediate"},this.doPointerClick),this.subscribe("input",{event:"wheel",handling:"immediate"},this.doPointerWheel),this.subscribe("input",{event:"doubleDown",handling:"immediate"},this.doPointerDoubleDown),this.subscribe("input",{event:"tap",handling:"immediate"},this.doPointerTap),this.subscribe("input",{event:"keyDown",handling:"immediate"},this.doKeyDown),this.subscribe("input",{event:"keyUp",handling:"immediate"},this.doKeyUp),this.firstResponders=new Map,this.lastResponders=new Map)}modifierEqual(e,t){return!!e.altKey==!!t.altKey&&!!e.ctrlKey==!!t.ctrlKey&&!!e.metaKey==!!t.metaKey&&!!e.shiftKey==!!t.shiftKey}addResponder(e,t,s,i){i._target&&(i=i._target);let o=["altKey","shiftKey","ctrlKey","metaKey"],r=e.get(t);r||(r=[],e.set(t,r)),function has(){for(let e=0;e<r.length;e++){let t=r[e],a=!0;for(let e=0;e<o.length;e++)a=a&&t.eventMask[o[e]]===s[o[e]];if(t.pawn===i&&a)return!0}return!1}()||(r.forEach((e=>{for(let i=0;i<o.length;i++)if(e.eventMask[o[i]]&&s[o[i]])throw new Error(`${o[i]} is already handled for ${t}`)})),r.unshift({eventMask:s,pawn:i}))}removeResponder(e,t,s,i){i._target&&(i=i._target);let o=e.get(t);if(!o)return;let r=o.findIndex((e=>{let t=["altKey","shiftKey","ctrlKey","metaKey"],i=!0;for(let o=0;o<t.length;o++)e.eventMask[t[o]]&&(i=i&&s[t[o]]);return i}));r>=0&&o[r].pawn===i&&o.splice(r,1)}findResponder(e,t,s,i){let o=e.get(s);if(!o)return null;let r=o.findIndex((e=>{let s=["altKey","shiftKey","ctrlKey","metaKey"],o=!0,r=!1;for(let i=0;i<s.length;i++)t[s[i]]&&(r=!0,o=o&&e.eventMask[s[i]]);return!(!i||0!==Object.keys(e.eventMask).length||r)||!(i&&!r)&&o}));return r>=0?o[r].pawn:null}addFirstResponder(e,t,s){return this.addResponder(this.firstResponders,e,t,s)}removeFirstResponder(e,t,s){return this.removeResponder(this.firstResponders,e,t,s)}findFirstResponder(e,t){return this.findResponder(this.firstResponders,e,t,!0)}addLastResponder(e,t,s){return this.addResponder(this.lastResponders,e,t,s)}removeLastResponder(e,t,s){return this.removeResponder(this.lastResponders,e,t,s)}findLastResponder(e,t){return this.findResponder(this.lastResponders,e,t,!1)}destroy(){super.destroy()}getTargets(e,t){const s=this.service("ThreeRenderManager");return(t?s.threeLayerUnion("pointer","walk"):s.threeLayer("pointer")).filter((t=>{let s=t.wcPawn.eventListeners.get(e);return s&&0!==s.length}))}invokeListeners(e,t,s,i){let o,r=t.eventListeners.get(e);o=s?this.pointerEvent(s,i):i;let a=this.actor._cardData.avatarEventHandler;if(this.has(`${a}$AvatarPawn`,"handlingEvent"))try{this.call(`${a}$AvatarPawn`,"handlingEvent",e,t,o)}catch(e){console.error(e)}r&&r.forEach((e=>{try{e.listener.call(t,o)}catch(e){console.error(e)}}))}pointerCapture(e){this.focusPawn=e}doPointerDown(e){let t="pointerDown",s=this.pointerRaycast(e,this.getTargets(t)),i=this.findFirstResponder(e,t);if(i)this.invokeListeners(t,i,s,e);else if(0===e.button&&(this.isPointerDown=!0,this.focusPawn!==s.pawn&&(this.focusPawn=s.pawn)),this.focusPawn)this.invokeListeners(t,this.focusPawn,s,e);else{let i=this.findLastResponder(e,t);i&&this.invokeListeners(t,i,s,e)}return s}doPointerUp(e){let t="pointerUp",s=this.pointerRaycast(e,this.getTargets(t));this.isPointerDown=!1;let i=this.findFirstResponder(e,t);if(i)this.invokeListeners(t,i,s,e);else if(this.focusPawn)this.invokeListeners(t,this.focusPawn,s,e);else{let i=this.findLastResponder(e,t);i&&this.invokeListeners(t,i,s,e)}return s}doPointerMove(e){let t="pointerMove",s=this.pointerRaycast(e,this.getTargets(t)),i=this.findFirstResponder(e,t);if(i)this.invokeListeners(t,i,s,e);else if(this.hoverPawn!==s.pawn&&(this.hoverPawn&&this.invokeListeners("pointerLeave",this.hoverPawn,s,e),this.hoverPawn=s.pawn,this.hoverPawn&&this.invokeListeners("pointerEnter",this.hoverPawn,s,e)),this.isPointerDown&&this.focusPawn&&this.focusPawn===s.pawn)this.invokeListeners(t,this.focusPawn,s,e);else{let i=this.findLastResponder(e,t);i&&this.invokeListeners(t,i,s,e)}return s}doPointerClick(e){let t="click";const s=this.pointerRaycast(e,this.getTargets(t));let i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(s.pawn)this.invokeListeners(t,s.pawn,s,e);else{let i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doPointerDoubleDown(e){let t="pointerDoubleDown";const s=this.pointerRaycast(e,this.getTargets(t,!0),!0);let i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);s.pawn&&this.invokeListeners(t,s.pawn,s,e)}doPointerWheel(e){let t="pointerWheel";const s=this.pointerRaycast(e,this.getTargets(t,!0),!0);let i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(s.pawn)this.invokeListeners(t,s.pawn,s,e);else{let i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doPointerTap(e){let t="pointerTap",s=this.pointerRaycast(e,this.getTargets(t)),i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(s.pawn)this.invokeListeners(t,s.pawn,s,e);else{let i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doKeyDown(e){let t="keyDown",s=this.findFirstResponder(e,t);if(s)return this.invokeListeners(t,s,null,e);if(this.focusPawn)this.invokeListeners(t,this.focusPawn,null,e);else{let s=this.findLastResponder(e,t);if(s)return this.invokeListeners(t,s,null,e)}}doKeyUp(e){let t="keyUp",s=this.findFirstResponder(e,t);if(s)return this.invokeListeners(t,s,null,e);this.focusPawn&&this.invokeListeners(t,this.focusPawn,null,e);let i=this.findLastResponder(e,t);return i?this.invokeListeners(t,i,null,e):void 0}pointerEvent(e,t){const s={avatarId:this.actor.id};return e.pawn&&(s.targetId=e.pawn.actor.id,s.xyz=e.xyz,s.uv=e.uv,s.normal=e.normal,s.distance=e.distance),s.ctrlKey=t.ctrlKey,s.altKey=t.altKey,s.shiftKey=t.shiftKey,s.metaKey=t.metaKey,s.xy=t.xy,s.id=t.id,s.button=t.button,s.buttons=t.buttons,e.ray&&(s.ray={origin:e.ray.origin.toArray(),direction:e.ray.direction.toArray()}),void 0!==t.deltaY&&(s.deltaY=t.deltaY),s}}},5679:(e,t,s)=>{"use strict";s.r(t),s.d(t,{PM_ThreeCamera:()=>PM_ThreeCamera,PM_ThreeVisible:()=>PM_ThreeVisible,THREE:()=>T,THREE_MESH_BVH:()=>o,ThreeRenderManager:()=>ThreeRenderManager});var i=s(9477),o=s(5919),r=s(2108),a=s(4458),n=s(8304),l=s(1154),h=s(3194),d=s(8025),c=s(9778),u=s(7011),p=s(6023),f=s(1217),m=s(452),g=s(6065),y=s(2854),v=s(1367),w=s(1259),_=s(140),x=s(7157),b=s(1711),M=s(5484),E=s(8939),P=s(9018),S=s(2583),A=s(4200);const PM_ThreeVisible=e=>class extends((0,A.PM_Visible)(e)){constructor(...e){super(...e),this.listen("viewGlobalChanged",this.refreshDrawTransform)}destroy(){super.destroy();const e=this.service("ThreeRenderManager");e&&e.scene&&(this.renderObject&&e.scene.remove(this.renderObject),this.colliderObject&&e.scene.remove(this.colliderObject))}refreshDrawTransform(){this.renderObject&&(this.renderObject.matrix.fromArray(this.global),this.renderObject.matrixWorldNeedsUpdate=!0),this.colliderObject&&(this.colliderObject.matrix.fromArray(this.global),this.colliderObject.matrixWorldNeedsUpdate=!0)}setRenderObject(e){const t=this.service("ThreeRenderManager");t&&t.dirtyAllLayers(),e.wcPawn=this,this.renderObject=e,this.renderObject.matrixAutoUpdate=!1,this.renderObject.matrix.fromArray(this.global),this.renderObject.matrixWorldNeedsUpdate=!0,t&&t.scene&&t.scene.add(this.renderObject),this.onSetRenderObject&&this.onSetRenderObject(e)}setColliderObject(e){const t=this.service("ThreeRenderManager");t&&t.dirtyAllLayers(),e.wcPawn=this,this.colliderObject=e,this.colliderObject.matrixAutoUpdate=!1,this.colliderObject.matrix.fromArray(this.global),this.colliderObject.matrixWorldNeedsUpdate=!0,t&&t.scene&&t.scene.add(this.colliderObject)}},PM_ThreeCamera=e=>class extends((0,A.PM_Camera)(e)){constructor(...e){if(super(...e),this.isMyPlayerPawn){const e=this.service("ThreeRenderManager");e.camera.matrix.fromArray(this.lookGlobal),e.camera.matrixAutoUpdate=!1,e.camera.matrixWorldNeedsUpdate=!0,this.listen("lookGlobalChanged",this.refreshCameraTransform),this.listen("viewGlobalChanged",this.refreshCameraTransform)}}refreshCameraTransform(){const e=this.service("ThreeRenderManager");e.camera.matrix.fromArray(this.lookGlobal),e.camera.matrixWorldNeedsUpdate=!0}setRaycastFrom2D(e){const t=e[0]/window.innerWidth*2-1,s=-e[1]/window.innerHeight*2+1,i=this.service("ThreeRenderManager");return this.raycaster||(this.raycaster=new T.Raycaster),this.raycaster.setFromCamera({x:t,y:s},i.camera),this.raycaster.params.Line={threshold:.2},this.raycaster.params.Point={threshold:.2},this.raycaster}setRaycastFrom3D(e){let t=new T.Vector3(0,0,-1);t.applyEuler(e.rotation),this.raycaster||(this.raycaster=new T.Raycaster),this.raycaster.set(e.position,t)}setRaycastFromRay(e){this.raycaster||(this.raycaster=new T.Raycaster);let{origin:t,direction:s}=e;Array.isArray(t)&&(t=new T.Vector3(...t),s=new T.Vector3(...s)),this.raycaster.set(t,s)}pointerRaycast(e,t,s){if(e.source&&(e=e.source),e.ray)this.setRaycastFromRay(e.ray);else if(e.xy)this.setRaycastFrom2D(e.xy);else if(e.origin)this.setRaycastFromRay(e);else if(Array.isArray(e))this.setRaycastFrom2D(e);else{if(!e.position)throw new Error("Unknown raycast source",e);this.setRaycastFrom3D(e)}const i=this.service("ThreeRenderManager"),o=this.raycaster.intersectObjects(t||i.threeLayer("pointer"));if(0===o.length)return{ray:this.raycaster.ray.clone()};let r,a;if(s)for(let e=0;e<o.length;e++){let t=o[e].object,s=t.wcPawn;for(;!s&&t;)t=t.parent,s=t.wcPawn;if(s){a=s.hitNormal,Array.isArray(a)&&(a=new T.Vector3(...a)),r=o[e];break}}for(let e=0;e<o.length;e++){if(o[e].object.renderOrder>1e3){r=o[e];break}}if(r||(r=o[0]),r.face&&!a&&(a=r.face.normal),a){let e=(new T.Matrix3).getNormalMatrix(r.object.matrixWorld);a=a.clone().applyMatrix3(e).normalize()}return{pawn:this.getPawn(r.object),xyz:r.point.toArray(),uv:r.uv?r.uv.toArray():void 0,normal:a?a.toArray():void 0,distance:r.distance,ray:this.raycaster.ray.clone()}}getPawn(e){let t=e;for(;!t.wcPawn;){if(!t.parent)return null;t=t.parent}return t.wcPawn}};class XRController{constructor(e){this.manager=e,this.controllerModelFactory=new S.i,[0,1].forEach((t=>{let s=`controller${t}`;this[s]=e.renderer.xr.getController(t);let i=this[s];i.addEventListener("selectstart",(t=>function selectStart(t,s){if(e.avatar){let s={type:"xr",button:0,buttons:1,id:1,source:t};e.avatar.doPointerDown(s)}t.userData.pointerDown=!0,t.userData.pointerDownTime=Date.now()}(i))),i.addEventListener("selectend",(t=>function selectEnd(t,s){if(e.avatar){let s={type:"xr",button:0,buttons:1,id:1,source:t};t.userData.pointerDownTime&&Date.now()-t.userData.pointerDownTime<400&&e.avatar.doPointerTap(s),e.avatar.doPointerUp(s)}t.userData.pointerDown=!1,t.userData.pointerDownTime=null}(i))),i.userData.pointerDown=!1,i.addEventListener("connected",(e=>{i.add(this.buildController(e.data,t))})),i.addEventListener("disconnected",(()=>{i.remove(i.children[0]),e.origReferenceSpace=null})),e.scene.add(i);let o=`controllerGrip${t}`;this[o]=e.renderer.xr.getControllerGrip(t);let r=this[o];r.add(this.controllerModelFactory.createControllerModel(r)),e.scene.add(r)})),this.lastDelta=[0,0]}buildController(e,t){let s,i;switch(e.gamepad&&(this[`gamepad${t}`]=e.gamepad),this.manager.origReferenceSpace||(this.manager.origReferenceSpace=this.manager.renderer.xr.getReferenceSpace()),e.targetRayMode){case"tracked-pointer":s=new T.BufferGeometry,s.setAttribute("position",new T.Float32BufferAttribute([0,0,0,0,0,-1],3)),s.setAttribute("color",new T.Float32BufferAttribute([1,1,1,1,1,1,1,0],4)),i=new T.LineBasicMaterial({vertexColors:!0,transparent:!0});let e=new T.Line(s,i);s=new T.BufferGeometry,s.setAttribute("position",new T.Float32BufferAttribute([0,0,0],3));let o=(new T.TextureLoader).load("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAVFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8TExN5eXllZWWmpqb19fUHBwc2Njapqand3d08PDwrKyvx8fHLijeGAAAADnRSTlMA6QVM+caA65JXA5YQrBYZ/8UAAADDSURBVHjalZPZDoIwEAAtUG6mpdzw//9powYBSzbO606y9+MPojjXKkmUzuMoEK7TjJ0sra/xQgHD4trWLQOgilO4rICx682LvhuBqjzEG7CTOTBZaL5GBetsTswrVHt+WDdzYVuh+NSvsLP5Ybaody8pTCbABOlrPhmjCTKSRV6IoQsLHcReyBn6sNAP5F7QLOaGBe0FhbsTHMoLCe2d0JKIgphCLFJsUxyUOGppWeK6pYORTk48WvHs5ceRX09+XpknoLkqeUcuWxIAAAAASUVORK5CYII=");i=new T.PointsMaterial({map:o,size:8,sizeAttenuation:!1,depthTest:!1,transparent:!0});let r=new T.Points(s,i);return r.renderOrder=1e4,r.visible=!1,this[`controllerRay${t}`]=e,this[`controllerHit${t}`]=r,(new T.Group).add(e,r);case"gaze":return s=new T.RingGeometry(.02,.04,32).translate(0,0,-1),i=new T.MeshBasicMaterial({opacity:.5,transparent:!0}),new T.Mesh(s,i)}}update(e){let t,s=0,i=0;if(s+=this.gamepad0?.axes[2]||0,s+=this.gamepad1?.axes[2]||0,i+=this.gamepad0?.axes[3]||0,i+=this.gamepad1?.axes[3]||0,0!==this.lastDelta[0]||0!==this.lastDelta[1]||0===s&&0===i||e.startMotion(),0===s&&0===i||e.updateMotion(80*s,80*i),0===this.lastDelta[0]&&0===this.lastDelta[1]||0!==s||0!==i||e.endMotion(),this.lastDelta=[s,i],this.controller0.userData.pointerDown){let s={type:"xr",button:0,buttons:1,id:1,source:this.controller0};t=e.doPointerMove(s)}else this.controllerHit0&&(t=e.pointerRaycast(this.controller0));if(this.controllerHit0&&(t.pawn&&t.distance?(this.controllerHit0.visible=!0,this.controllerHit0.position.z=-t.distance):this.controllerHit0.visible=!1),this.controller1.userData.pointerDown){let s={type:"xr",button:0,buttons:1,id:1,source:this.controller1};t=e.doPointerMove(s)}else this.controllerHit1&&(t=e.pointerRaycast(this.controller1));this.controllerHit1&&(t.pawn&&t.distance?(this.controllerHit1.visible=!0,this.controllerHit1.position.z=-t.distance):this.controllerHit1.visible=!1)}}class ThreeRenderManager extends A.RenderManager{constructor(e={},t){super(e,t||"ThreeRenderManager"),this.threeLayers={},this.scene=new T.Scene,this.camera=new T.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,1e4),e.canvas||(this.canvas=document.createElement("canvas"),this.canvas.id="ThreeCanvas",this.canvas.style.cssText="position: absolute; left: 0; top: 0; z-index: 0",document.body.insertBefore(this.canvas,null),e.canvas=this.canvas),this.setupRenderer(e)}setupRenderer(e){this.renderer&&this.renderer.dispose(),this.vrButton&&this.vrButton.remove(),this.canvas&&(e.canvas=this.canvas),this.renderer=new T.WebGLRenderer(e),this.renderer.shadowMap.enabled=!0,this.vrButtonStyleSet=!1,this.hasXR().then((e=>{if(e){this.vrButton=P.N.createButton(this.renderer);let styleCallback=(e,t)=>{let s=!1;for(let t=0;t<e.length;t++)if("attributes"===e[t].type){s=!0;break}if(s&&"ENTER VR"===this.vrButton.textContent&&!this.vrButtonStyleSet)if(this.vrButtonStyleSet=!0,this.vrButton.style.removeProperty("left"),window.enterVRButtonStyle)for(let e in window.enterVRButtonStyle){let t=window.enterVRButtonStyle[e];this.vrButton.style.setProperty(e,t)}else this.vrButton.style.setProperty("right","20px")};this.observer&&(this.observer.disconnect(),this.observer=null),this.observer=new MutationObserver(styleCallback),this.observer.observe(this.vrButton,{attributes:!0,attributeFilter:["style"]}),document.body.appendChild(this.vrButton),this.renderer.xr.enabled=!0,this.xrController=new XRController(this)}else this.composer=new r.x(this.renderer),this.renderPass=new a.C(this.scene,this.camera),this.composer.addPass(this.renderPass);this.resize(),this.subscribe("input","resize",(()=>this.resize())),this.setRender(!0)}))}installOutlinePass(){this.outlinePass||(this.outlinePass=new E.f(new T.Vector2(window.innerWidth,window.innerHeight),this.scene,this.camera),this.outlinePass.edgeStrength=3,this.outlinePass.edgeGlow=.1,this.outlinePass.edgeThickness=1.5,this.outlinePass.pulsePeriod=2,this.outlinePass.visibleEdgeColor.set("#88ff88"),this.outlinePass.hiddenEdgeColor.set("#ff0000"),this.outlinePass.selectedObjects=[],this.composer.addPass(this.outlinePass))}addToOutline(e){this.outlinePass||this.installOutlinePass(),this.outlinePass.selectedObjects.push(e)}clearOutline(){this.outlinePass.selectedObjects=[]}setRender(e){this.doRender=e}async hasXR(){try{return await navigator.xr.isSessionSupported("immersive-vr")}catch(e){return!1}}destroy(){super.destroy(),this.renderer.dispose(),this.canvas&&this.canvas.remove(),this.vrButton&&this.vrButton.remove(),this.observer&&this.observer.disconnect()}resize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight),this.composer&&this.composer.setSize(window.innerWidth,window.innerHeight)}dirtyLayer(e){this.threeLayers[e]=null}dirtyAllLayers(){this.threeLayers={}}threeLayer(e){return this.layers[e]?(this.threeLayers[e]||(this.threeLayers[e]=Array.from(this.layers[e]).map((e=>e.colliderObject||e.renderObject))),this.threeLayers[e]):[]}threeLayerUnion(...e){let t=[];for(;e.length>0;){const s=this.threeLayer(e.pop());t=t.concat(s.filter((e=>t.indexOf(e)<0)))}return t}render(){this.composer?this.composer.render():this.renderer.render(this.scene,this.camera)}update(){this.doRender&&this.render(),this.xrController&&this.avatar&&this.xrController.update(this.avatar)}}const T={...i,Pass:n.w,UnrealBloomPass:M.m,CopyShader:l.C,CSMFrustum:h.$,CSMShader:d.G,CSM:c.j,OBJLoader:u.L,MTLLoader:p.v,GLTFLoader:f.E,FBXLoader:m.y,VRMLLoader:g.W,DRACOLoader:y._,SVGLoader:v.u,EXRLoader:w.I,BufferGeometryUtils:_,FontLoader:x.J,Font:x.Z,TextGeometry:b.M}},3782:(e,t,s)=>{"use strict";s.d(t,{Bg:()=>addMeshProperties,Sb:()=>r,bp:()=>normalizeSVG,iF:()=>addTexture,me:()=>AssetManager});let i,o={};function isZip(e){return 80===e[0]&&75===e[1]&&3===e[2]&&4===e[3]}class ImportChecker{constructor(){this.totalSize=0}addItem(e){return!!this.withinLimits&&(this.totalSize+=e.buffer.byteLength,this.withinLimits)}get withinLimits(){return this.totalSize<=104857600}get totalBytes(){return this.totalSize}}class AssetManager{constructor(){this.assetCache={},this.supportedFileTypes=new Set(["zip","glb","obj","fbx","wrl","svg","png","jpeg","jpg","gif","exr","pdf","vrse"])}fetchFile(e){const t=e.getAsFile(),s=this.getFileType(t.name);if(t&&s)return this.fetchSpecForDroppedFile(t,s).then((e=>{if(!this.supportedFileTypes.has(s))throw new Error("unsupported file type");return{type:s,buffer:e.buffer}}));throw new Error("could not read a file")}async handlePasteText(e){for(const t of e)if("string"===t.kind&&"text/plain"===t.type)return new Promise((e=>t.getAsString(e)))}async handleFiles(e){const t=new ImportChecker;e.length>1&&console.warn("multiple files or dirs dropped");const s=e[0],i=s.getAsEntry?s.getAsEntry():s.webkitGetAsEntry?s.webkitGetAsEntry():null;if(i&&i.isDirectory)try{return this.analyzeDirectory(i,t)}catch(e){throw Error("directory could not be zipped")}let o=await this.fetchFile(s);return i&&(o.fileName=i.fullPath),o}async analyzeDirectory(e,t){const s=[{path:e.fullPath,entry:e,depth:0}];let i,o=new JSZip;const processEntries=()=>{const{path:e,entry:r,depth:a}=s.pop();return r.isDirectory?new Promise(((e,t)=>{r.createReader().readEntries((t=>{for(const e of t)s.push({path:e.fullPath,entry:e,depth:a+1});e(!0)}))})):new Promise(((s,n)=>{r.file((async r=>{const n=this.getFileType(r.name),l=await this.fetchSpecForDroppedFile(r,n);if("obj"===l.type&&(i="obj"),l.path=e,l.depth=a,t.addItem(l),!t.withinLimits)throw new Error("directory too large");o.file(e,l.buffer),s(!0)}),(e=>{n(e)}))}))};return new Promise((async(e,t)=>{for(;s.length>0;)await processEntries();e(!0)})).then((()=>({zip:o,type:i})))}getFileType(e){let t=e.lastIndexOf(".");return t>=0?e.slice(t+1).toLowerCase():null}async fetchSpecForDroppedFile(e,t){const s=new FileReader;return new Promise(((t,i)=>{s.onload=()=>t(s.result),s.onerror=i,s.readAsArrayBuffer(e)})).then((s=>({name:e.name,type:t,blob:e,buffer:s}))).catch((e=>{throw console.error(e),new Error("reading a file failed")}))}async drop(e){if([...e.types].includes("Files")){let{zip:t,buffer:s,type:i,fileName:o}=await this.handleFiles(e.items);return t?t.generateAsync({type:"uint8array"}):{fileName:o,type:i,buffer:s}}{let t=await this.handlePasteText(e.items);if(t)return{type:"pastedtext",buffer:t}}return null}setupHandlersOn(e,t){const handleData=async e=>{let s=await this.drop(e);if(!s)return void console.log("not a file");let{buffer:i,fileName:o,type:r}=s;t&&t(i,o,r)};e.ondragover=e=>e.preventDefault(),e.ondrop=e=>{e.preventDefault(),handleData(e.dataTransfer)},e.onpaste=e=>{e.preventDefault(),handleData(e.clipboardData||window.clipboardData)}}setCache(e,t,s){this.assetCache[e]?(this.assetCache[e].ids.delete("0"),this.assetCache[e].ids.add(s)):this.assetCache[e]={data:t,ids:new Set([s])}}getCache(e){let t=this.assetCache[e];return t?t.data:null}fillCacheIfAbsent(e,t,s){let i=this.assetCache[e];return i?(this.assetCache[e].ids.add(s),i.data):(i=t(),this.setCache(e,i,s),i)}revoke(e,t){let s=this.assetCache[e];s&&(s.ids.delete(t),0===s.ids.size&&delete this.assetCache[e])}async load(e,t,s,i){let o={glb:"importGLB",obj:"importOBJ",fbx:"importFBX",wrl:"importVRML",svg:"importSVG",png:"importIMG",jpg:"importIMG",jpeg:"importIMG",gif:"importIMG",exr:"importEXR"};if(isZip(e)){let t=new JSZip,r=await t.loadAsync(e),a=Object.keys(r.files);for(let t in o)if(a.find((e=>e.endsWith(`.${t}`)))){return(new Loader)[o[t]](e,i,s)}throw new Error("unknown file type")}for(let r in o)if(t===r){return(new Loader)[o[r]](e,i,s)}throw new Error("unknown file type")}}class Loader{constructor(){}localName(e){let t=e.lastIndexOf("/");return t>=0?e.slice(t+1):e}imgType(e){return e.endsWith(".png")?"png":e.endsWith(".jpeg")||e.endsWith(".jpg")?"jpeg":null}async setupFilesInZip(e,t){let s=new JSZip,i=await s.loadAsync(e),o={},r=Object.keys(i.files),a=Object.keys(t).map((e=>{let s=t[e],o=r.find((t=>t.endsWith(`.${e}`)));return i.file(o).async(s).then((t=>({type:e,blob:URL.createObjectURL(new Blob([t]))})))})),n={};await Promise.all(a).then((e=>{e.forEach((e=>{n[e.type]=e.blob}))}));let l=r.map((e=>({name:e,type:this.imgType(e)}))).filter((e=>e.type)).map((e=>{let{name:t,type:s}=e,r=this.localName(t);return i.file(t).async("uint8array").then((e=>{let t=new Blob([e],{type:`image/${s}`}),i=new FileReader;return new Promise(((e,s)=>(i.addEventListener("load",(()=>{o[r]=i.result,e(i.result)})),i.readAsDataURL(t))))}))}));return await Promise.all(l),{...n,imgContents:o}}setURLModifierFor(e,t){t&&e.setURLModifier((e=>{if(this.imgType(e)){let s=this.localName(e);return t[s]||""}return e}))}async importOBJ(e,t,s){let i;let o=await(async()=>{if(!isZip(e)){let t={obj:URL.createObjectURL(new Blob([e]))};return Promise.resolve(t)}return this.setupFilesInZip(e,{obj:"string",mtl:"string"})})();const r=new s.LoadingManager;if(this.setURLModifierFor(r,o.imgContents),o.mtl){const e=new s.MTLLoader(r);i=await new Promise(((t,s)=>{e.load(o.mtl,t,null,s)}))}const a=new s.OBJLoader(r);let n=await new Promise(((e,t)=>{i&&a.setMaterials(i),a.load(o.obj,e,null,t)}));return Object.keys(o).forEach((e=>{o[e]&&"imgContents"!==e&&URL.revokeObjectURL(o[e])})),n}async importFBX(e,t,s){let i=await(async()=>{if(!isZip(e)){let t={fbx:URL.createObjectURL(new Blob([e]))};return Promise.resolve(t)}return this.setupFilesInZip(e,{fbx:"ArrayBuffer"})})();const o=new s.LoadingManager;this.setURLModifierFor(o,i.imgContents);const r=new s.FBXLoader(o);let a=await new Promise(((e,t)=>r.load(i.fbx,e,null,t))).then((e=>{if(e.animations.length>0){const t=new s.AnimationMixer(e);e._croquetAnimation={lastTime:0,mixer:t,animations:e.animations}}return e}));return Object.keys(i).forEach((e=>{i[e]&&"imgContents"!==e&&URL.revokeObjectURL(i[e])})),a}async importVRML(e,t,s){let i=await(async()=>{if(!isZip(e)){let t={wrl:URL.createObjectURL(new Blob([e]))};return Promise.resolve(t)}return this.setupFilesInZip(e,{wrl:"ArrayBuffer"})})();const o=new s.LoadingManager;this.setURLModifierFor(o,i.imgContents);const r=new s.VRMLLoader(o);let a=await new Promise(((e,t)=>r.load(i.wrl,e,null,t))).then((e=>{if(e.animations.length>0){const t=new s.AnimationMixer(e);e._croquetAnimation={lastTime:0,mixer:t,animations:e.animations}}return e}));return Object.keys(i).forEach((e=>{i[e]&&"imgContents"!==e&&URL.revokeObjectURL(i[e])})),a}async importGLB(e,t,s){return(async()=>{if(isZip(e)){let t=new JSZip,s=await t.loadAsync(e),i=Object.keys(s.files).find((e=>e.endsWith(".glb")));return s.files[i].async("ArrayBuffer")}return Promise.resolve(e.buffer)})().then((e=>{if(!o.dracoLoader){let e=new s.GLTFLoader,t=new s.DRACOLoader;t.setDecoderConfig({type:"wasm"}),t.setDecoderPath("https://www.gstatic.com/draco/versioned/decoders/1.5.6/"),e.setDRACOLoader(t),o.dracoLoader=e}return new Promise((async(t,s)=>{try{await o.dracoLoader.parse(e,null,t,s)}catch(e){s(e)}})).then((e=>{let{scene:t,animations:i}=e;if(i.length>0){const e=new s.AnimationMixer(t);t._croquetAnimation={lastTime:0,mixer:e,animations:i}}return t}))}))}async importSVG(e,t,s){let i=await(async()=>{let t={svg:URL.createObjectURL(new Blob([e]))};return Promise.resolve(t)})(),o=await new Promise(((e,o)=>{const{fullBright:r,color:a,frameColor:n,depth:l,_shadow:h,_singleSided:d}=t,c=r?s.MeshBasicMaterial:s.MeshStandardMaterial,u=new s.SVGLoader;let p=0;u.load(i.svg,(t=>{const i=t.paths,o=new s.Group;for(let e=0;e<i.length;e++){const t=i[e],r=t.userData.style.fill;if(void 0!==r&&"none"!==r){let e=new c({color:(new s.Color).setStyle(r),opacity:t.userData.style.fillOpacity,side:l?s.FrontSide:s.DoubleSide});a&&(e.color=new s.Color(a)),l&&(e=[e,new s.MeshStandardMaterial({color:n,metalness:1})]);const i=s.SVGLoader.createShapes(t);for(let t=0;t<i.length;t++){const r=i[t];let a;a=l?new s.ExtrudeGeometry(r,{depth:1+p,bevelEnabled:!1}):new s.ShapeGeometry(r);const n=new s.Mesh(a,e);n.position.z+=l,p+=.002,o.add(n)}}const h=t.userData.style.stroke;if(void 0!==h&&"none"!==h){const e=new c({color:(new s.Color).setStyle(h),opacity:t.userData.style.strokeOpacity,side:s.DoubleSide});for(let i=0,r=t.subPaths.length;i<r;i++){const r=t.subPaths[i],a=s.SVGLoader.pointsToStroke(r.getPoints(),t.userData.style);if(a){const t=new s.Mesh(a,e);o.add(t)}}}}e(o)}))}));return Object.keys(i).forEach((e=>{i[e]&&"imgContents"!==e&&URL.revokeObjectURL(i[e])})),o}async importIMG(e,t,s){let i=URL.createObjectURL(new Blob([e])),o=new s.TextureLoader,r=new Promise(((e,t)=>{o.load(i,(t=>{t.width=t.image.width,t.height=t.image.height,e(t)}),null,t)}));return r.then((()=>(URL.revokeObjectURL(i),r)))}async importEXR(e,t,s){let i=await(async()=>{if(!isZip(e)){let t={exr:URL.createObjectURL(new Blob([e]))};return Promise.resolve(t)}return this.setupFilesInZip(e,{exr:"ArrayBuffer"})})(),o=new Promise(((e,t)=>{(new s.EXRLoader).load(i.exr,e,null,t)}));return Object.keys(i).forEach((e=>{i[e]&&"imgContents"!==e&&URL.revokeObjectURL(i[e])})),o}}function addMeshProperties(e,t,s,i,o,r){e.traverse((e=>{if(e.material){if(i&&(e.material.fog=!1),o){let t=e.material;console.log("material",t),e.material=new r.MeshBasicMaterial,e.material.copy(t)}s&&(e.material.side=r.FrontSide),e.material.format=r.RGBAFormat,t&&(e.castShadow=!0,e.receiveShadow=!0)}}))}function normalizeSVG(e,t,s,o){i=o;let r=boundingBox(e),a=function extent3D(e,t){let s=new i.Vector3;t||(t=boundingBox(e));t&&(s.copy(t.max),s.sub(t.min));return s}(e,r),n=function center3D(e,t){let s=new i.Vector3;t||(t=boundingBox(e));t&&(s.copy(t.max),s.add(t.min),s.multiplyScalar(.5));return s}(e,r);e.scale.y*=-1,n.y*=-1;let l=Math.max(a.x,a.y);if(l>0){a.y&&(e.aspect=a.x/a.y),e.position.set(-n.x,-n.y,-n.z);let s=1/l;e.position.multiplyScalar(s);let i=e.scale;t?e.scale.set(i.x*s,i.y*s,t):e.scale.multiplyScale(s)}e.traverse((e=>{e.material&&(!function normalizeUV(e,t,s){let i=[s.max.x-s.min.x,s.max.y-s.min.y];i[0]=i[0]>0?1/i[0]:1,i[1]=i[1]>0?1/i[1]:1;let o=[s.min.x,s.min.y],r=0,a=0;for(let s=0;s<e.length;s++)a+=r,!t[3*a]+2&&(e[s]=(e[s]-o[r])*i[r],r&&(e[s]=1-e[s])),r=0===r?1:0}(e.geometry.attributes.uv.array,e.geometry.attributes.normal.array,r),s&&(e.castShadow=!0,e.receiveShadow=!0))}))}function boundingBox(e,t,s){if(t||(t=new i.Box3,s=0),e.geometry){e.geometry.boundingBox||e.geometry.computeBoundingBox();const s=e.geometry.boundingBox.clone();s.applyMatrix4(e.matrixWorld),t.union(s)}return e.children&&e.children.forEach((e=>boundingBox(e,t,s+1))),t}function addTexture(e,t){e.traverse((e=>{e.material&&(Array.isArray(e.material)?e.material[0].map=t:e.material.map=t)}))}let r=function(){let e,t,s,i,o=[],r={},a=0,n=0,l=0;function floor(e,t){return e instanceof Float32Array?Math.floor(e[t]*a):e instanceof window.Float16Array?Math.floor(e[t]*n):e[t]}function createAttribute(t){const s=new e.BufferAttribute(new t.array.constructor(l*t.itemSize),t.itemSize),i=s.array,r=t.array;switch(t.itemSize){case 1:for(let e=0,t=o.length;e<t;e++)i[e]=r[o[e]];break;case 2:for(let e=0,t=o.length;e<t;e++){const t=2*o[e],s=2*e;i[s]=r[t],i[s+1]=r[t+1]}break;case 3:for(let e=0,t=o.length;e<t;e++){const t=3*o[e],s=3*e;i[s]=r[t],i[s+1]=r[t+1],i[s+2]=r[t+2]}break;case 4:for(let e=0,t=o.length;e<t;e++){const t=4*o[e],s=4*e;i[s]=r[t],i[s+1]=r[t+1],i[s+2]=r[t+2],i[s+3]=r[t+3]}}return s}function hashAttribute(e,t){const s=e.array;switch(e.itemSize){case 1:return floor(s,t);case 2:return floor(s,t)+"_"+floor(s,t+1);case 3:return floor(s,t)+"_"+floor(s,t+1)+"_"+floor(s,t+2);case 4:return floor(s,t)+"_"+floor(s,t+1)+"_"+floor(s,t+2)+"_"+floor(s,t+3)}}function store(e,a){let n="";for(let i=0,o=s.length;i<o;i++){const o=s[i],r=t.attributes[o];n+=hashAttribute(r,r.itemSize*e*3+a*r.itemSize)+"_"}for(let s=0,o=i.length;s<o;s++){const o=i[s],r=t.morphAttributes[o];n+=hashAttribute(r,r.itemSize*e*3+a*r.itemSize)+"_"}return void 0===r[n]&&(r[n]=o.length,o.push(3*e+a)),r[n]}function storeFast(e,t,s,i){const n=Math.floor(e*a)+"_"+Math.floor(t*a)+"_"+Math.floor(s*a);return void 0===r[n]&&(r[n]=o.length,o.push(i)),r[n]}return function(h,d,c,u){e=d,u=u||6,a=Math.pow(10,u),n=Math.pow(10,Math.floor(u/2));const p=new e.BufferGeometry;return function indexBufferGeometry(a,n,h){t=a,s=Object.keys(a.attributes),i=Object.keys(a.morphAttributes);const d=a.attributes.position.array,c=d.length/3/3,u=new(3*c>65536?Uint32Array:Uint16Array)(3*c);if(h)for(let e=0,t=c;e<t;e++)u[3*e]=store(e,0),u[3*e+1]=store(e,1),u[3*e+2]=store(e,2);else for(let e=0,t=c;e<t;e++){const t=9*e;u[3*e]=storeFast(d[t],d[t+1],d[t+2],3*e),u[3*e+1]=storeFast(d[t+3],d[t+4],d[t+5],3*e+1),u[3*e+2]=storeFast(d[t+6],d[t+7],d[t+8],3*e+2)}n.index=new e.BufferAttribute(u,1),l=o.length;for(let e=0,t=s.length;e<t;e++){const t=s[e];n.attributes[t]=createAttribute(a.attributes[t])}for(let e=0,t=i.length;e<t;e++){const t=i[e];n.morphAttributes[t]=createAttribute(a.morphAttributes[t])}a.boundingSphere?n.boundingSphere=a.boundingSphere.clone():(n.boundingSphere=new e.Sphere,n.computeBoundingSphere()),a.boundingBox?n.boundingBox=a.boundingBox.clone():(n.boundingBox=new e.Box3,n.computeBoundingBox());const p=a.groups;for(let e=0,t=p.length;e<t;e++){const t=p[e];n.addGroup(t.start,t.count,t.materialIndex)}r={},o=[],t=null,s=[],i=[]}(h,p,void 0===c||c),p}}()},6567:(e,t,s)=>{"use strict";s.d(t,{b:()=>AvatarActor});var i=s(4200),o=s(5679),r=s(3917),a=s(2691),n=s(3654),l=s(3986),h=s(5072);let d;function startHelpMenu(e){d=e,(0,l.ts)(),function createHelpMenu(){let e='\n    <div id="helpDialog" class="dialogPanel no-select">\n    <button id="close-button" type="button" class="btn btn-danger btn-x topright">x</button>\n        <div id="share-container" class="content-container">\n            <div id="help-title" class="panel-title">Help</div>\n            <div id="table-wrapper">\n                <div id="table-scroll" id="scrollbar">\n                    <table class="help-table">\n                        <tr class="help-row">\n                            <td>\n                                <p class="table-head">Navigate</p>\n                                <p class="table-desc">Move around using the joystick, or WASD keys.</p>\n                            </td>\n                            <td class="icon-column">\n                                <div class="icons">\n                                    <div class="help-pane-icon move-icon"></div>\n                                    <div class="help-pane-icon wasd-icon"></div>\n                                </div>\n                            </td>\n                        </tr>\n                        <tr class="help-row">\n                            <td>\n                                <p class="table-head">Look</p>\n                                <p class="table-desc">Click and drag to change camera look position.</p>\n                            </td>\n                        <td class="icon-column">\n                            <div class="icons"><div class="help-pane-icon look-icon"></div>\n                        </td>\n                    </tr>\n                    <tr class="help-row" id="manipulate-row">\n                        <td>\n                            <p class="table-head">Manipulate</p>\n                            <p class="table-desc">Ctrl + click on an object to open and cycle through the "gizmo" tools. The icon of a multi-pane tool is a button to open the property sheet tool.</p>\n                        </td>\n                        <td class="icon-column">\n                            <div class="icons">\n                                <div class="help-pane-icon ctrlclick-icon"></div>\n                            </div>\n                        </td>\n                    </tr>\n                    <tr class="help-row" id="fullscreen-row">\n                        <td>\n                            <p class="table-head">Fullscreen</p>\n                            <p class="table-desc">Make your browser fullscreen.</p>\n                        </td>\n                        <td class="icon-column"><i class="fas fa-solid fa-expand icons"></i></td>\n                    </tr>\n                    <tr class="help-row">\n                        <td>\n                            <p class="table-head">Home</p>\n                            <p class="table-desc">Reset location back to original landing place.</p>\n                        </td>\n                        <td class="icon-column"><i class="fas fa-solid fa-house-user icons"></i></td>\n                    </tr>\n                    <tr class="help-row">\n                        <td>\n                            <p class="table-head">Gather</p>\n                            <p class="table-desc">Shows how many users in a world. Click to "gather" all users to you.</p>\n                        </td>\n                        <td class="icon-column"><i class="fas fa-solid fa-users icons"></i></td>\n                    </tr>\n                    <tr class="help-row" id="import-row">\n                        <td>\n                            <p class="table-head">Import</p>\n                            <p class="table-desc">Import any of these formats from your desktop directly\n                                 into the Microverse World. Either drag and drop, or choose the import menu item.</p>\n                        </td>\n                        <td class="icon-column">\n                            <div class="icons">\n                                <div class="help-pane-icon import-icon help-menu-icon"></div>\n                            </div>\n                        </td>\n                     </tr>\n                     <tr class="help-row" id="connect-row">\n                         <td>\n                             <p class="table-head">Connect</p>\n                             <p class="table-desc">Click connect to link your text editor to edit behavior files.</p>\n                         </td>\n                         <td class="icon-column">\n                             <div class="icons">\n                                 <div class="help-pane-icon connect-icon help-menu-icon"</div>\n                             </div>\n                         </td>\n                     </tr>\n                     <tr class="help-row">\n                         <td>\n                             <p class="table-head">Invite</p>\n                             <p class="table-desc">Save your Microverse as a .vrse file to share or use the QR code to share the session with others.</p>\n                         </td>\n                         <td class="icon-column">\n                             <div class="icons">\n                                 <div class="help-pane-icon share-icon help-menu-icon"></div>\n                             </div>\n                         </td>\n                     </tr>\n                     <tr class="help-row" id="settings-row">\n                         <td>\n                             <p class="table-head">Settings</p>\n                             <p class="table-desc">Update your in-world nickname, select from default avatars or paste a link to your own.</p>\n                         </td>\n                         <td class="icon-column">\n                             <div class="icons">\n                                 <div class="help-pane-icon settings-icon help-menu-icon"></div>\n                             </div>\n                         </td>\n                    </tr>\n                </table>\n            </div>\n        </div>\n    </div>'.trim(),t=document.createElement("div");t.innerHTML=e;let s=t.querySelector("#helpDialog"),i=s.querySelector("#close-button");(0,l.gA)(s),i.onclick=()=>(0,l.ts)(),d&&["manipulate-row","import-row","connect-row","settings-row"].forEach((e=>{let t=s.querySelector(`#${e}`);t&&t.remove()}));document.body.appendChild(s)}(),(0,l.aP)()}const c=1.676,u=(0,i.m4_rotationY)(Math.PI);let p;class AvatarActor extends((0,i.mix)(n.Z4).with(i.AM_Player)){init(e){let t=e.playerId;delete e.playerId,super.init(e),this._playerId=t,this._layers=e.layers,this.addLayer("avatar"),this.lookPitch=0,this.lookYaw=0,this.lookOffset=(0,i.v3_zero)(),this.fall=!1,this.tug=.05,this.set({tickStep:30}),this.listen("goHome",this.goHome),this.listen("goThere",this.goThere),this.listen("startFalling",this.startFalling),this.listen("avatarLookTo",this.onLookTo),this.listen("comeToMe",this.comeToMe),this.listen("followMeToWorld",this.followMeToWorld),this.listen("continuePresenting",this.continuePresenting),this.listen("continueFollowing",this.continueFollowing),this.listen("stopPresentation",this.stopPresentation),this.listen("inWorldSet",this.inWorldSet),this.listen("nameSet",this.nameSet),this.listen("fileUploaded","fileUploaded"),this.listen("addSticky",this.addSticky),this.listen("textPasted",this.textPasted),this.listen("resetStartPosition",this.resetStartPosition),this.subscribe("playerManager","presentationStarted",this.presentationStarted),this.subscribe("playerManager","presentationStopped",this.presentationStopped),this.subscribe("actorManager","destroyed",this.actorDestroyed),this.listen("leavePresentation",this.leavePresentation),this.listen("setAvatarData","setAvatarData"),this.listen("setWorldState","setWorldState"),this.listen("addOrCycleGizmo","addOrCycleGizmo"),this.listen("removeGizmo","removeGizmo"),this.future(0).tick()}setAndPublish(e){this.set(e),this.publish("playerManager","detailsUpdated")}get pawn(){return AvatarPawnFactory}get lookNormal(){return(0,i.v3_rotate)([0,0,-1],this.rotation)}get collisionRadius(){return this._cardData.collisionRadius||.8}get inWorld(){return!!this._inWorld}ensureNicknameCard(){if(!this.inWorld)return;if(this._cardData.noNicknameCard)return;const e=this._name;if(!e)return void(this.nicknameCard&&(this.nicknameCard.destroy(),this.nicknameCard=null));const t=.005;if(!this.nicknameCard){const e={name:"nickname",behaviorModules:["Billboard"],translation:[0,1,-.1],type:"text",depth:.02,margins:{left:16,top:22.000000000000004},backgroundColor:3145849,frameColor:4194441,fullBright:!0,opacity:.8,runs:[],width:.1,height:.1,textScale:t,readOnly:!0,noDismissButton:!0,noSave:!0,avatarParts:!0,parent:this};this.nicknameCard=this.createCard(e)}const s=this.getTextFieldActorClass().defaultMeasurement(e),i=Math.min(s.width*t+.2,2),o=Math.min(s.height*t+.2,.4);this.nicknameCard.load([{text:e,style:{color:"white"}}]),this.nicknameCard.setExtent({width:i/t,height:o/t})}removeNicknameCard(){this.nicknameCard&&this.nicknameCard.destroy(),this.nicknameCard=null}leavePresentation(){if(!this.follow)return;let e=this.service("PlayerManager");e.presentationMode&&this.follow!==this.playerId&&(this.presentationStopped(),this.say("setLookAngles",{lookOffset:[0,0,0]}),e.leavePresentation(this.playerId))}setWorldState(e){this.set(e)}stopPresentation(){this.service("PlayerManager").stopPresentation()}inWorldSet({o:e,v:t}){!e!=!t&&this.service("PlayerManager").playerInWorldChanged(this),t&&this.ensureNicknameCard()}nameSet({o:e,v:t}){e!==t&&this.ensureNicknameCard()}startFalling(){this.fall=!0}getLookFromAnchor(){let e=this._anchor,t=(0,i.v3_zero)(),s=0,o=0;if(!e||!e._cardData)return{lookOffset:t,lookPitch:s,lookYaw:o};let r=e._cardData;return r.lookOffset&&(t=r.lookOffset),r.lookPitch&&(s=r.lookPitch),r.lookYaw&&(o=r.lookYaw),{lookOffset:t,lookPitch:s,lookYaw:o}}resetStartPosition(){let e=this._anchor;if(!e)return void this.goTo(this.translation,this.rotation,!1);let t=e.translation,s=e.rotation,i=this.getLookFromAnchor();this.goTo(t,s,!1,i)}onLookTo(e){let[t,s,o]=e;void 0!==t&&(this.lookPitch=t),void 0!==s&&(this.lookYaw=s),void 0!==o&&(this.lookOffset=o),this.rotateTo((0,i.q_euler)(0,this.lookYaw,0)),this.restoreTargetId=void 0}goHome(){let e,t;this._anchor?(e=this._anchor.translation,t=this._anchor.rotation):(e=(0,i.v3_zero)(),t=(0,i.q_identity)());let s=this.getLookFromAnchor();this.goTo(e,t,!1,s),this.lookOffset=s.lookOffset,this.lookPitch=s.lookPitch,this.lookYaw=s.lookYaw,this.say("setLookAngles",{pitch:this.lookPitch,yaw:this.lookYaw,lookOffset:this.lookOffset})}goTo(e,t,s,i){this.leavePresentation(),this.vStart=this.translation,this.qStart=this.rotation,this.vEnd=e,this.qEnd=t,this.fall=s,i&&(this.lookStart={lookPitch:this.lookPitch,lookYaw:this.lookYaw,lookOffset:this.lookOffset},this.lookEnd=i),this.goToStep(.1)}goThere(e){if(this.leavePresentation(),this.vStart=this.translation,this.qStart=this.rotation,this.fall||e.targetId!==this.restoreTargetId){this.fall=!1,this.restoreRotation=this.rotation,this.restoreTranslation=this.translation,this.restoreTargetId=e.targetId;let t=[...e.normal||this.lookNormal],s=e.xyz;if(this.vEnd=(0,i.v3_add)(s,(0,i.v3_scale)(t,e.offset||c)),t[1]=0,(0,i.v3_sqrMag)(t)<1e-4)this.qEnd=this.rotation;else{t=(0,i.v3_normalize)(t);let e=Math.atan2(t[0],t[2]);this.qEnd=(0,i.q_euler)(0,e,0)}if(e.look){let e=(0,i.q_pitch)(this.qEnd),t=(0,i.q_yaw)(this.qEnd);this.lookPitch=e,this.lookYaw=t,this.say("setLookAngles",{pitch:e,yaw:t})}}else this.vEnd=this.restoreTranslation,this.qEnd=this.restoreRotation,delete this.restoreRotation,delete this.restoreTranslation,delete this.restoreTargetId;this.goToStep(.1)}comeToMe(){this.service("PlayerManager").startPresentation(this.playerId)}followMeToWorld(e){const t=this.service("PlayerManager");if(t.presentationMode===this.playerId){const s={...e};s.following=s.presenting,delete s.presenting;for(const e of t.followers){if(e===this.playerId)continue;t.player(e).followToWorld(s)}}}followToWorld(e){this.say("followToWorld",{followerTransferData:e})}presentationStarted(){const{presenter:e,followers:t}=this.service("PlayerManager");e.playerId!==this.playerId&&t.has(this.playerId)&&(this._translation=e.translation,this._rotation=e.rotation,this.say("forceOnPosition"),this.follow=e.playerId,this.fall=!1,this._anchor=e._anchor)}presentationStopped(){this.follow=null}continuePresenting(e){this.service("PlayerManager").continuePresenting(this,e)}continueFollowing(e){this.service("PlayerManager").continueFollowing(this,e)}goToStep(e,t){t||(t=e),t>=1&&(t=1);let s=(0,i.v3_lerp)(this.vStart,this.vEnd,t),o=(0,i.q_slerp)(this.qStart,this.qEnd,t);if(this.positionTo({v:s,q:o}),this.lookStart&&this.lookEnd){let e=this.lookStart.lookPitch*(1-t)+this.lookEnd.lookPitch*t,s=this.lookStart.lookYaw*(1-t)+this.lookEnd.lookYaw*t,o=(0,i.v3_lerp)(this.lookStart.lookOffset,this.lookEnd.lookOffset,t);this.say("setLookAngles",{pitch:e,yaw:s,lookOffset:o})}this.say("forceOnPosition"),t<1&&this.future(50).goToStep(e,t+e)}tick(e){if(this.follow){let e=this.service("PlayerManager").players.get(this.follow);e?(this.positionTo({v:e._translation,q:e._rotation}),this.lookOffset=e.lookOffset,this.lookPitch=e.lookPitch,this.lookYaw=e.lookYaw,this.say("setLookAngles",{pitch:e.lookPitch,yaw:e.lookYaw,lookOffset:e.lookOffset})):this.presentationStopped()}this.doomed||this.future(this._tickStep).tick(this._tickStep)}dropPose(e,t){let s=this.lookNormal,o=this.translation,r=this.rotation;if(!t){return{translation:(0,i.v3_add)((0,i.v3_scale)(s,e),o),rotation:r}}let a=(0,i.q_euler)(0,-Math.PI/2,0),n=(0,i.v3_rotate)(s,a),l=(0,i.v3_multiply)(t,n);return{translation:(0,i.v3_add)((0,i.v3_add)((0,i.v3_scale)(s,e),o),l),rotation:r}}fileUploaded(e){let t=this.behaviorManager.lookup("FileDragAndDropHandler","FileDragAndDropActor");if(t)return t.invoke(this,"fileUploaded",e)}textPasted({string:e,translation:t,rotation:s}){e.startsWith("http://")||e.startsWith("https://")?this.createPortal(t,s,e):this.behaviorManager.hasBehavior("StickyNote")&&this.createStickyNote(t,s,e)}addSticky(e){if(!this.behaviorManager.hasBehavior("StickyNote"))return;let t,s=(0,i.v3_add)(e.xyz,(0,i.v3_scale)(e.normal,.1)),o=[...e.normal];if(o[1]=0,(0,i.v3_sqrMag)(o)>1e-4){o=(0,i.v3_normalize)(o);let e=Math.atan2(o[0],o[2]);t=(0,i.q_euler)(0,e,0)}else t=this.rotation,s[1]+=2;this.createStickyNote(s,t)}createStickyNote(e,t,s){let i=[];s||(s=""),i.push({text:s});let o={name:"sticky note",className:"TextFieldActor",behaviorModules:["StickyNote"],translation:e,rotation:t,type:"text",depth:.05,margins:{left:20,top:20,right:20,bottom:20},backgroundColor:16048214,frameColor:16439570,runs:i,width:1,height:1,textScale:.002};this.createCard(o),this.publish(this.sessionId,"triggerPersist")}actorDestroyed(e){this.gizmo?.target?.id===e&&this.removeGizmo()}addOrCycleGizmo(e){let{target:t,viewId:s}=e;if(this.gizmo)this.publish(this.gizmo.id,"cycleModes");else{if(!this.behaviorManager.modules.get("Gizmo"))return;this.gizmo=this.createCard({translation:(0,i.m4_getTranslation)(t.global),name:"gizmo",behaviorModules:["Gizmo"],type:"object",noSave:!0,target:t,targetParent:t.parent,creatorId:s})}}removeGizmo(){this.gizmo?.destroy(),delete this.gizmo,this.say("clearGizmo")}createPortal(e,t,s){let o={name:"portal",className:"PortalActor",translation:e,rotation:t=(0,i.q_multiply)((0,i.q_euler)(0,Math.PI,0),t),type:"2d",layers:["pointer"],color:16737996,frameColor:8947848,width:3,height:3,depth:.2,cornerRadius:.05,portalURL:s,sparkle:!1};this.createCard(o),this.publish(this.sessionId,"triggerPersist")}setAvatarData(e){this.setupAvatarBehavior(e),this.updateOptions(e)}setupAvatarBehavior(e){e.avatarEventHandler||(e.avatarEventHandler="AvatarEventHandler");let t=e.avatarEventHandler,s=this.service("BehaviorModelManager");s&&s.modules.get(t)&&(e.behaviorModules?e.behaviorModules.includes(t)||(e.behaviorModules=[...e.behaviorModules,t]):e.behaviorModules=[t])}destroy(){this.removeGizmo(),super.destroy()}}AvatarActor.register("AvatarActor");class AvatarPawnFactory extends i.View{constructor(e){return super(e),this.viewId===e.playerId?new AvatarPawn(e):new RemoteAvatarPawn(e)}}const PM_SmoothedDriver=e=>class extends e{constructor(e){super(e),this.throttle=125,this.ignore("scaleSet"),this.ignore("rotationSet"),this.ignore("translationSet"),this.ignore("positionSet")}globalChanged(){this._global||!this.renderObject||this.renderObject.matrixWorldNeedsUpdate||(this.refreshDrawTransform(),this.children&&this.children.forEach((e=>e.onGlobalChanged())))}positionTo(e,t,s){if(!this.actor.follow){if(s=s||this.throttle,(0,i.v3_equals)(this.actor.translation,e,0)&&(0,i.q_equals)(this.actor.rotation,t,0))return;this._translation=e,this._rotation=t,this.onLocalChanged(),this.isTranslating=!1,this.isRotating=!1}super.positionTo(e,t,s),this.globalChanged()}scaleTo(e,t){this.actor.follow||(t=t||this.throttle,this._scale=e,this.onLocalChanged(),this.isScaling=!1),super.scaleTo(e,t),this.globalChanged()}rotateTo(e,t){this.actor.follow||(t=t||this.throttle,this._rotation=e,this.onLocalChanged(),this.isRotating=!1),super.rotateTo(e,t),this.globalChanged()}translateTo(e,t){this.actor.follow||(t=t||this.throttle,this._translation=e,this.isTranslating=!1,this.onLocalChanged()),super.translateTo(e,t),this.globalChanged()}};function setModelOpacity(e,t,s){let i=1!==s;e.visible=t,e.traverse((e=>{e.renderOrder=1e4,e.material&&e.material.opacity!==s&&(e.material.opacity=s,e.material.transparent=i,e.material.side=o.THREE.DoubleSide,e.material.needsUpdate=!0)}))}class RemoteAvatarPawn extends((0,i.mix)(n.Df).with(i.PM_Player,o.PM_ThreeVisible)){constructor(e){super(e),this.lastUpdateTime=0,this.spin=(0,i.q_identity)(),this.velocity=[0,0,0],this.lookPitch=this.actor.lookPitch,this.lookYaw=this.actor.lookYaw,this.lookOffset=[0,0,0],this.tug=.06,this.subscribe(this.id,"3dModelLoaded","modelLoaded")}addChild(e){super.addChild(e),delete this.lastOpacity}setOpacity(e){if(!this.shape)return;let t=this.actor._cardData.avatarEventHandler;this.hasBehavior(`${t}$AvatarPawn`,"mapOpacity")&&(e=this.call(`${t}$AvatarPawn`,"mapOpacity",e));let s=1!==e;this.shape.visible=this.actor.inWorld&&0!==e,this.shape.traverse((t=>{t.material&&(t.material.opacity=e,t.material.transparent=s,t.material.side=o.THREE.DoubleSide,t.material.needsUpdate=!0)}))}removeChild(e){super.removeChild(e),delete this.lastOpacity}modelLoaded(){delete this.lastOpacity,delete this.lastInWorld,this.modelLoadTime=Date.now(),setModelOpacity(this.shape.children[0],!0,0)}detach(){delete this.modelLoadTime,super.detach()}}let f=null,m=!0;class AvatarPawn extends((0,i.mix)(n.Df).with(i.PM_Player,PM_SmoothedDriver,o.PM_ThreeVisible,o.PM_ThreeCamera,a.CN)){constructor(e){super(e),this.lastUpdateTime=0,this.lastCollideTime=0,this.lastCollideTranslation=this.actor.translation,this.spin=(0,i.q_identity)(),this.velocity=(0,i.v3_zero)(),this.lookPitch=this.actor.lookPitch,this.lookYaw=this.actor.lookYaw,this.lookOffset=(0,i.v3_zero)(),this._rotation=(0,i.q_euler)(0,this.lookYaw,0),this.portalLookExternal=p,this.isMobile=!!("ontouchstart"in window),this.isFalling=!1;const t=this.service("ThreeRenderManager");this.camera=t.camera,this.scene=t.scene,t.avatar=this,this.lastHeight=c,this.yawDirection=this.isMobile?-1:1,this.pitchDirection=this.isMobile?1:-1,this.portalcaster=new o.THREE.Raycaster(new o.THREE.Vector3,new o.THREE.Vector3,0,.4),this.fadeNearby(),this.fadeNearbyInterval&&(clearInterval(this.fadeNearbyInterval),this.fadeNearbyInterval=null),this.fadeNearbyInterval=setInterval((()=>this.fadeNearby()),100),document.getElementById("homeBtn").onclick=()=>this.goHome(),(0,l.gA)(document.getElementById("homeBtn")),document.getElementById("editModeBtn").setAttribute("mobile",this.isMobile),document.getElementById("editModeBtn").setAttribute("pressed",!1);let s=document.getElementById("editModeBtn");s.onpointerdown=e=>this.setEditMode(e),s.onpointerup=e=>this.clearEditMode(e),(0,l.TV)(this,i.App,this.sessionId),window.myAvatar=this,this.eyeHeight=c,this.fallDistance=c/12,this.maxFall=-15,this.service("WalkManager").setupDefaultWalkers(),this.actor.behaviorManager.hasBehavior("FileDragAndDropHandler")&&this.service("AssetManager").assetManager.setupHandlersOn(document,((e,t,s)=>{"pastedtext"===s?this.pasteText(e):"vrse"===s?this.loadvrse(e):this.analyzeAndUploadFile(new Uint8Array(e),t,s)})),this.isPrimary=r.isPrimaryFrame,this.portalClip=new o.THREE.Plane(new o.THREE.Vector3(0,0,-1),0),this.setPortalClipping(),this.shellListener=(e,{frameType:s,spec:i,cameraMatrix:o,dx:a,dy:n,acknowledgeReceipt:l})=>{let h=this.actor._cardData.avatarEventHandler;switch(e){case"frame-type":const e="primary"===s;i&&this.setWorldSwitchFreeze(!0),e!==this.isPrimary&&this.frameTypeChanged(e,i),o&&this.portalCameraUpdate(o),(0,r.sendToShell)("avatar-ready",{frameType:s});break;case"release-freeze":this.setWorldSwitchFreeze(!1),this.refreshCameraTransform(),this.updatePortalRender(!0);break;case"sync-render-now":if(this.frozenForWorldSwitch)return void console.log((0,r.frameName)(),"ignoring sync-render while frozen");this.refreshCameraTransform(),t.render(),l&&(0,r.sendToShell)("primary-rendered");break;case"portal-camera-update":this.setWorldSwitchFreeze(!1),this.portalCameraUpdate(o);break;case"motion-start":this.hasBehavior(`${h}$AvatarPawn`,"startMotion")?this.call(`${h}$AvatarPawn`,"startMotion",a,n):this.startMotion(a,n);break;case"motion-end":this.hasBehavior(`${h}$AvatarPawn`,"endMotion")?this.call(`${h}$AvatarPawn`,"endMotion",a,n):this.endMotion(a,n);break;case"motion-update":this.hasBehavior(`${h}$AvatarPawn`,"updateMotion")?this.call(`${h}$AvatarPawn`,"updateMotion",a,n):this.updateMotion(a,n)}},(0,r.addShellListener)(this.shellListener);const a=this.isPrimary;if(this.spectator)this.goHome();else{let e,t,s;if(a&&f){const i=this.anchorFromURL(window.location,!this.isPrimary);e=f,e.anchor=i,e.inWorld=!0,f=null,t=e.cardData,s=e.name,t.name=s}else{e={inWorld:a};const i=this.anchorFromURL(window.location,!this.isPrimary);i&&(e.anchor=i,e.translation=i.translation,e.rotation=i.rotation),t={...this.makeCardSpecFrom(window.settingsMenuConfiguration,this.actor,s)}}this.say("setWorldState",{inWorld:e.inWorld,translation:e.translation,rotation:e.rotation,anchor:e.anchor}),this.say("setAvatarData",t),this.say("resetStartPosition")}this.subscribe("playerManager","playerCountChanged",this.showNumbers),this.listen("setLookAngles",this.setLookAngles),this.listenImmediate("followToWorld",this.followToWorld),this.showNumbers(),this.listen("forceOnPosition",this.forceOnPosition),this.listen("goThere",this.stopFalling),this.subscribe(this.id,"3dModelLoaded","modelLoaded"),this.listen("clearGizmo",this.clearGizmo),this.subscribe("playerManager","presentationStarted",this.presentationStarted),this.subscribe("playerManager","presentationStopped",this.presentationStopped),this.wasdVelocity=[0,0,0],this.wasdMap={w:!1,a:!1,d:!1,s:!1}}detach(){this.setDormantAvatarSpec(this.specForRevival()),this.fadeNearbyInterval&&(clearInterval(this.fadeNearbyInterval),this.fadeNearbyInterval=null),this.gizmoTargetPawn?.unselectEdit(),delete this.gizmoTargetPawn,delete this.modelLoadTime,super.detach()}startMotion(e,t){this.spin=(0,i.q_identity)(),this.velocity=(0,i.v3_zero)(),this.say("startFalling"),(e||t)&&this.updateMotion(e,t)}endMotion(e,t){this.spin=(0,i.q_identity)(),this.velocity=(0,i.v3_zero)()}updateMotion(e,t){let s=3e-5*t;s=Math.min(Math.max(s,-.015),.015);const o=e*(this.isMobile?-.001:-4e-4);this.spin=(0,i.q_euler)(0,o,0),this.velocity=[0,0,s],this.maybeLeavePresentation()}get presenting(){return this.actor.service("PlayerManager").presentationMode===this.viewId}get spectator(){if(!this.wellKnownModel("modelRoot").broadcastMode)return!1;if(this.actor.broadcaster)return!1;return"true"!==new URLSearchParams(window.location.search).get("broadcastMode")}setWorldSwitchFreeze(e){this.frozenForWorldSwitch=e}forceOnPosition(){this._rotation=this.actor.rotation,this._translation=this.actor.translation,this.onLocalChanged(),this.globalChanged()}setLookAngles(e){let{pitch:t,yaw:s,lookOffset:i}=e;void 0!==t&&(this.lookPitch=t),void 0!==s&&(this.lookYaw=s),void 0!==i&&(this.lookOffset=i)}async analyzeAndUploadFile(e,t,s){let r,a,n,l=await i.Data.store(this.sessionId,e,!0),h=i.Data.toId(l),d=this.service("AssetManager").assetManager;try{"pdf"!==s&&(r=await d.load(e,s,o.THREE,{}))}catch(e){return void console.warn("dropped file could not be processed",e)}if(r&&r.isObject3D){d.setCache(h,e,"0"),r._croquetAnimation&&(a=0);let t=new o.THREE.Vector3(0,0,0);(new o.THREE.Box3).setFromObject(r).getSize(t);let s=4/Math.max(t.x,t.y,t.z);n=[s,s,s]}let c=this.dropPose(6);this.say("fileUploaded",{dataId:h,fileName:t,type:/^(jpe?g|png|gif)$/.test(s)?"img":s,translation:c.translation,rotation:c.rotation,animationClipIndex:a,dataScale:n})}async uploadFile(e,t,s){let o=await i.Data.store(this.sessionId,e),r=i.Data.toId(o),a=this.dropPose(6);this.say("fileUploaded",{dataId:r,fileName:t,type:/^(jpe?g|png|gif)$/.test(s)?"img":s,translation:a.translation,rotation:a.rotation})}async pasteText(e){e.length>2e3&&(console.warn("Paste too long, truncating"),e=e.substr(0,2e3));let t=this.dropPose(6);this.say("textPasted",{string:e,translation:t.translation,rotation:t.rotation})}loadvrse(e){let t,s=new TextDecoder("utf-8").decode(e);try{t=JSON.parse(s)}catch(e){console.log("vrse file is not in JSON format")}if(!t)return;let i=t.data.cards,o=0;for(let e=0;e<i.length;e++){i[e].card.parent||o++}let r=o>=2;this.loadFromFile(s,r,!r)}dropPose(e,t){return this.actor.dropPose(e,t)}anchorFromURL(e,t){const{actors:s}=this.actor.service("ActorManager"),{searchParams:i}=new URL(e),o=i.get("anchor");if(!o){if(t)for(const e of s.values())if(e.isPortal)return e;for(const e of s.values())if("default"===e._cardData.spawn)return e;return null}for(const e of s.values())if(e.name===o)return e;const r=o.split(",").map((e=>parseFloat(e)));if(7!==r.length||r.some((e=>isNaN(e))))return null;const[a,n,l,h,d,c,u]=r;return{translation:[a,n,l],rotation:[h,d,c,u]}}showNumbers(){let e=this.actor.service("PlayerManager"),t=document.getElementById("userCountDisplay");if(this.service("AgoraChatManager"))return void(t&&t.remove());if(!t){let e=document.createElement("div");e.innerHTML='<div id="userCountDisplay"><div id="userCountReadout">0</div></div>',t=e.firstChild,document.body.appendChild(t),this.service("DolbyChatManager")&&window.innerWidth>=600?t.style.left="40%":t.style.left="50%"}let s=t.querySelector("#userCountReadout");if(!s)return;let i=e.players.size,o=e.playersInWorld().length,r=1===o?"visitor":"visitors",a=`${o} ${1===o?"visitor is":"visitors are"} in this world`;if(o!==i){let e=i-o;a+=`, ${e} ${1===e?"visitor has":"visitors have"} not entered yet`,i=`${o}+${e}`}if(e.presentationMode){let t=e.followers.size;s.textContent=`${t}/${i} ${r}`,a=`${t} ${1===t?"visitor":"visitors"} in guided tour, ${a}`}else s.textContent=`${i} ${r}`;t.setAttribute("title",a),s.setAttribute("presenting",this.presenting)}presentationStarted(){(0,l._s)(this)}presentationStopped(){(0,l._s)(this)}modelLoaded(){delete this.lastOpacity,delete this.lastInWorld,this.modelLoadTime=Date.now(),setModelOpacity(this.shape.children[0],!0,0)}setEditMode(e){e.target.setAttribute("pressed",!0),e.target.setPointerCapture(e.pointerId),e.stopPropagation(),this.service("InputManager").setModifierKeys({ctrlKey:!0})}clearEditMode(e){e.target.setAttribute("pressed",!1),e.target.releasePointerCapture(e.pointerId),e.stopPropagation(),this.service("InputManager").setModifierKeys({ctrlKey:!1})}maybeLeavePresentation(){this.actor.follow&&this.say("leavePresentation")}lookTo(e,t,s){this.maybeLeavePresentation(),this.setLookAngles({pitch:e,yaw:t,lookOffset:s}),this.say("avatarLookTo",[e,t,s],30);let o=(0,i.q_euler)(0,this.lookYaw,0);this._rotation=o,this.onLocalChanged(),this.isRotating=!1}destroy(){(0,r.removeShellListener)(this.shellListener),super.destroy()}get lookGlobal(){return this.lookOffset?!this.isPrimary&&this.portalLookExternal?this.portalLook:this.walkLook():this.global}walkLook(){let e=this.actor._cardData.avatarEventHandler;if(this.hasBehavior(`${e}$AvatarPawn`,"walkLook"))return this.call(`${e}$AvatarPawn`,"walkLook");const t=(0,i.q_axisAngle)([1,0,0],this.lookPitch),s=(0,i.m4_translation)(this.lookOffset),o=(0,i.m4_rotationQ)(t),r=(0,i.m4_multiply)(o,s);return(0,i.m4_multiply)(r,this.global)}get portalLook(){const e=this.anchor||this.actor._anchor||{translation:[0,0,0],rotation:[0,0,0,1]},t=(0,i.m4_translation)(e.translation),s=(0,i.m4_rotationQ)(e.rotation),r=(0,i.m4_multiply)(s,u),a=(0,i.m4_multiply)(r,t),n=(0,i.m4_multiply)(this.portalLookExternal,a);this.portalClip.normal.set(0,0,-1),this.portalClip.constant=0;const l=new o.THREE.Matrix4;l.set(...s),l.invert(),this.portalClip.applyMatrix4(l);const h=new o.THREE.Vector3(...e.translation);return this.portalClip.constant=-this.portalClip.distanceToPoint(h),n}specForRevival(){return{translation:this._translation,rotation:this._rotation,lookPitch:this.lookPitch,lookYaw:this.lookYaw,lookOffset:this.lookOffset,cardData:this.actor._cardData,name:this.actor._name,inChat:!1,behaviorModules:this.actor._behaviorModules}}setDormantAvatarSpec(e){m&&(f=e)}useDormantAvatarSpec(e){m=e}specForPortal(e,t,s){const o=(0,i.m4_translation)(t),r=(0,i.m4_multiply)(this.global,o),a=(0,i.m4_invert)(e.global),n=(0,i.m4_multiply)(r,a),l={translation:(0,i.m4_getTranslation)(n),rotation:(0,i.m4_getRotation)(n),lookPitch:this.lookPitch,lookYaw:this.lookYaw,lookOffset:this.lookOffset,cardData:this.actor._cardData,name:this.actor._name,url:e.resolvePortalURL(),crossingBackwards:s};return this.presenting&&(l.presenting=i.Data.hash(this.viewId)),l}frameTypeChanged(e,t){this.isPrimary=e;const s=e,o=!e,a={inWorld:s};if(t?.cardData&&(a.cardData=t.cardData),t?.name&&(a.name=t.name),s&&t?.translation){let{translation:e,rotation:s}=t;const o=this.anchorFromURL(t.url,!0);if(o){const t=(0,i.m4_translation)(e),r=(0,i.m4_rotationQ)(s),n=(0,i.m4_multiply)(r,t),l=(0,i.m4_translation)(o.translation),h=(0,i.m4_rotationQ)(o.rotation),d=(0,i.m4_multiply)(h,u),c=(0,i.m4_multiply)(d,l),p=(0,i.m4_multiply)(n,c);e=(0,i.m4_getTranslation)(p),s=(0,i.m4_getRotation)(p),a.anchor=o,this.anchor=o}a.translation=e,a.rotation=s,this._translation=e,this._rotation=s,this.onLocalChanged(),t.lookPitch&&(this.lookPitch=t.lookPitch),t.lookYaw&&(this.lookYaw=t.lookYaw),t.lookOffset&&(this.lookOffset=t.lookOffset)}if(o){let e=this.actor._cardData.avatarEventHandler;this.call(`${e}$AvatarPawn`,"endMotion")}if(console.log(`${(0,r.frameName)()} setting actor`,a),this.say("_set",a),s)if(delete this.modelLoadTime,this.say("setAvatarData",a.cardData||{}),t?.presenting){this.actor.service("PlayerManager").presentationMode||this.say("continuePresenting",t.presenting)}else t?.following&&this.say("continueFollowing",t.following);this.setPortalClipping()}followToWorld({followerTransferData:e}){const{url:t,following:s}=e;this.isPrimary?(console.log(`${(0,r.frameName)()} sending world-enter to ${t} following: ${s}`),this.setWorldSwitchFreeze(!0),e.cardData=this.actor._cardData,e.name=this.actor._name,(0,r.sendToShell)("world-enter",{portalURL:t,transferData:e})):console.log(`${(0,r.frameName)()} not sending world-enter to ${t}`)}update(e,t){if(!this.frozenForWorldSwitch){if(this.actor.follow||this.actor.remoteControlled)this.tug=.06,super.update(e,t);else{this.tug=.2;const s=this.actor.service("PlayerManager");if(this.throttle=s.presentationMode===this.actor.playerId?60:125,this.actor.inWorld||this.spectator){let s=this.updatePose(t);s=this.service("WalkManager").walk(this,s,e,t),this.positionTo(s.v,s.q,this.throttle),this.refreshCameraTransform(),this.updateRequests&&this.updateRequests.forEach((s=>{this.call(...s,e,t)}))}}this.updateXRReference(),this.updatePortalRender()}}updateXRReference(){let e=this.service("ThreeRenderManager");if(!e.origReferenceSpace)return;let t=e.renderer.xr,s=(0,i.m4_invert)(this.global),o=(0,i.m4_getTranslation)(s),r=(0,i.m4_getRotation)(s);o[1]+=1.6;let a=new XRRigidTransform({x:o[0],y:o[1],z:o[2]},{x:r[0],y:r[1],z:r[2],w:r[3]}),n=e.origReferenceSpace.getOffsetReferenceSpace(a);t.setReferenceSpace(n)}updatePose(e){let t,s,o=this.tug;if(e&&(o=Math.min(1,o*e/15)),t=(0,i.q_isZero)(this.spin)?this.rotation:(0,i.q_normalize)((0,i.q_slerp)(this.rotation,(0,i.q_multiply)(this.rotation,this.spin),o)),(0,i.v3_isZero)(this.velocity))s=this.translation;else{const t=(0,i.v3_scale)(this.velocity,e),o=(0,i.v3_transform)(t,(0,i.m4_rotationQ)(this.rotation));s=(0,i.v3_add)(this.translation,o)}return{v:s,q:t}}setPortalClipping(){let{clippingPlanes:e}=this.service("ThreeRenderManager").renderer;if(this.isPrimary){const t=e.indexOf(this.portalClip);t>=0&&e.splice(t,1)}else e.includes(this.portalClip)||e.push(this.portalClip)}updatePortalRender(e=!1){if(this.isPrimary){const t=[];let s=!1;this.publish("avatar","gatherPortalSpecs",{callback:e=>{t.push(e),s|=!!e.cameraMatrix},force:e});const i=this.service("ThreeRenderManager");t.length?(0,r.sendToShell)("portal-update",{portalSpecs:t}):i.setRender(!0),e&&!s&&(console.log((0,r.frameName)(),"no portals in sight; rendering immediately"),i.render(),(0,r.sendToShell)("primary-rendered"))}else this.actor._anchor&&this.refreshCameraTransform()}portalCameraUpdate(e){this.lastCameraMatrix=e;const t=this.service("ThreeRenderManager");t.setRender(!1),e&&(this.endMovementTimeout&&clearTimeout(this.endMovementTimeout),this.endMovementTimeout=setTimeout((()=>{const e=!!this.lastCameraMatrix&&!this.frozenForWorldSwitch;t.setRender(e)}),50),this.portalLookExternal=e,p=e,this.isPrimary||this.frozenForWorldSwitch||(this.refreshCameraTransform(),t.render(),(0,r.sendToShell)("portal-world-rendered")))}checkFloor(e){let t=this.service("ThreeRenderManager").threeLayer("walk").filter((e=>e.collider)),s=!1;for(let i=0;i<t.length;i++){let r=t[i],a=new o.THREE.Matrix4;a.copy(r.matrixWorld).invert();let n=new o.THREE.Vector3(0,-1,0),l=new o.THREE.Ray(new o.THREE.Vector3(...e.v),n);l.applyMatrix4(a);let h=r.children[0].geometry.boundsTree.raycastFirst(l);s=s||h}return s}collideBVH(e,t){let s=new o.THREE.Vector3,r=new o.THREE.Vector3;const a=this.actor.collisionRadius;let n=!1,l=(0,i.v3_sub)(t.v,this.translation),h=t.v,d=!1;for(let t=0;t<e.length;t++){let i=e[t],c=i.children[0].matrixWorld.clone();c.invert();let u=new o.THREE.Line3(new o.THREE.Vector3(h[0],h[1],h[2]),new o.THREE.Vector3(h[0],h[1]-.838,h[2])),p=new o.THREE.Box3;p.makeEmpty(),p.expandByPoint(u.start),p.expandByPoint(u.end),p.min.addScaledVector(new o.THREE.Vector3(-1,-1,-1),a),p.max.addScaledVector(new o.THREE.Vector3(1,1,1),a),u.applyMatrix4(c),p.applyMatrix4(c);let f=new o.THREE.Vector3;f.setFromMatrixScale(c);let m,g=Math.abs(a*f.x),y=[];i.children[0].geometry.boundsTree.shapecast({intersectsBounds:e=>e.intersectsBox(p),intersectsTriangle:e=>{const t=e.closestPointToSegment(u,r,s);if(t<g){const i=g-t,o=s.sub(r).normalize();let a=Math.sqrt(o.x**2+o.z**2),n=o.y;a<.1&&n>.9&&(!m||i>m.depth)?(m=e.clone(),y.unshift(m)):y.push(e.clone())}}}),y.forEach((e=>{const t=e.closestPointToSegment(u,r,s);if(t<g){let e=g-t;const i=s.sub(r).normalize();u.start.addScaledVector(i,e),u.end.addScaledVector(i,e),n=!0}}));let v=u.start.clone();v.applyMatrix4(i.children[0].matrixWorld),h=v.toArray(),d=d||n&&l[1]<-.1&&Math.abs(l[0])<.001&&Math.abs(l[2])<.001}return d?(this.isFalling=!1,{v:this.translation,q:t.q}):n?(this.isFalling=!0,{v:h,q:t.q}):(this.isFalling=!0,t)}pawnFrom3D(e){for(;e;){if(e.wcPawn)return e.wcPawn;e=e.parent}}collidePortal(e){if(this.frozenForWorldSwitch)return!1;const t=this.service("ThreeRenderManager"),s=t.threeLayer("portal");if(!s)return!1;let a=(0,i.v3_sub)(e.v,this.translation);const n=(0,i.v3_magnitude)(a);if(0===n)return!1;a=(0,i.v3_normalize)(a),this.portalcaster.far=5,this.portalcaster.ray.direction.set(...a),this.portalcaster.ray.origin.set(...this.translation);const l=this.portalcaster.intersectObjects(s,!0)[0];if(l){let s=this.pawnFrom3D(l.object);if(!s)return!1;const h=s.globalPlane;if(!(h.normal.dot(new o.THREE.Vector3(...a))>0))return!1;let d=l.distance<=n;if(!d){d=h.distanceToPoint(new o.THREE.Vector3(...e.v))>=-.4}if(!d)return!1;const{camera:c}=t,u=c.getWorldDirection(new o.THREE.Vector3),p=h.normal.dot(u)<0;this.anchor=s.actor,console.log((0,r.frameName)(),"player",this.viewId,"enter portal",s.portalId),t.setRender(!1),this.setWorldSwitchFreeze(!0);let f=(0,i.v3_scale)(a,l.distance);f=(0,i.v3_add)(f,(0,i.v3_scale)(h.normal.toArray(),.4));const m=this.specForPortal(s,f,p);if((0,r.sendToShell)("portal-enter",{portalId:s.portalId,transferData:m}),this.presenting){const{cardData:e,name:t,...s}=m;this.say("followMeToWorld",s)}return!0}return!1}keyDown(e){let t,s=this.wasdVelocity;const o=.0075;if(e.ctrlKey||e.altKey)switch(e.key){case"a":console.log("My avatar pawn",this),console.log("translation: ",this.actor.translation),console.log("rotation (euler):",(0,i.q_pitch)(this.actor.rotation),(0,i.q_yaw)(this.actor.rotation),(0,i.q_roll)(this.actor.rotation)),console.log("scale:",this.actor.scale);break;case"r":let e=this.service("ThreeRenderManager").renderer;console.log("Renderer",e),console.log("Scene polycount:",e.info.render.triangles),console.log("Active Drawcalls:",e.info.render.calls),console.log("Textures in Memory",e.info.memory.textures),console.log("Geometries in Memory",e.info.memory.geometries)}else switch(e.key){case"Tab":this.jumpToNote(e);break;case"w":case"W":case"a":case"A":case"d":case"D":case"s":case"S":switch(this.wasdMap[e.key.toLowerCase()]=!0,e.key){case"w":case"W":t=s[2]===o?0:-o,this.wasdVelocity=[s[0],s[1],t];break;case"a":case"A":t=s[0]===o?0:-o,this.wasdVelocity=[t,s[1],s[2]];break;case"d":case"D":t=s[0]===-o?0:o,this.wasdVelocity=[t,s[1],s[2]];break;case"s":case"S":t=s[2]===-o?0:o,this.wasdVelocity=[s[0],s[1],t]}this.velocity=this.wasdVelocity,this.say("startFalling"),this.maybeLeavePresentation()}}keyUp(e){switch(e.key){case"w":case"W":case"a":case"A":case"d":case"D":case"s":case"S":let t,s;this.wasdMap[e.key.toLowerCase()]=!1,t=this.wasdMap.a&&!this.wasdMap.d?-.01:!this.wasdMap.a&&this.wasdMap.d?.01:0,s=this.wasdMap.w&&!this.wasdMap.s?-.01:!this.wasdMap.w&&this.wasdMap.s?.01:0,this.wasdVelocity=[t,0,s],this.velocity=this.wasdVelocity}}addSticky(e){if(e.shiftKey){const t=this.service("ThreeRenderManager"),s=this.pointerRaycast(e,t.threeLayerUnion("pointer","walk"));let i=this.pointerEvent(s,e);this.say("addSticky",i)}}stopFalling(){this.isFalling=!1}xy2yp(e){let t=this.service("ThreeRenderManager").camera.fov/2,s=window.innerHeight/2,i=window.innerWidth/2,o=t*Math.PI/180/s;return[o*(e[0]-i),o*(s-e[1])]}clearGizmo(){this.gizmoTargetPawn=null}pointerDown(e){let t=this.service("ThreeRenderManager"),s=this.pointerRaycast(e,t.threeLayerUnion("pointer"));this.targetDistance=s.distance;let o=this.pointerEvent(s,e),r=(0,i.GetPawn)(o.targetId),a=r&&r.actor.isGizmoManipulator;if(this.gizmoTargetPawn&&!a&&r!==this.gizmoTargetPawn&&(this.gizmoTargetPawn.unselectEdit(),this.gizmoTargetPawn=null,this.publish(this.actor.id,"removeGizmo")),e.ctrlKey||e.altKey){let e=this.actor.behaviorManager.modules.get("Gizmo");r&&e?a?(console.log("Tried to gizmo gizmo"),this.publish(this.actor.id,"addOrCycleGizmo",{target:this.gizmoTargetPawn.actor,viewId:this.viewId})):(this.gizmoTargetPawn!=r&&r.selectEdit(),this.gizmoTargetPawn=r,this.publish(this.actor.id,"addOrCycleGizmo",{target:this.gizmoTargetPawn.actor,viewId:this.viewId})):this.publish(this.actor.id,"removeGizmo")}else{this.gizmoTargetPawn?(this.gizmoTargetPawn.unselectEdit(),this.gizmoTargetPawn=null,this.publish(this.actor.id,"removeGizmo")):e.xy&&(this.dragWorld=this.xy2yp(e.xy),this.lookYaw=(0,i.q_yaw)(this._rotation));let t=this.actor._cardData.avatarEventHandler;this.hasBehavior(`${t}$AvatarPawn`,"handlingEvent")&&this.call(`${t}$AvatarPawn`,"handlingEvent","pointerDown",this,e),a||this.publish(this.actor.id,"removeGizmo")}}pointerMove(e){if(!this.focusPawn&&this.isPointerDown&&e.xy&&this.dragWorld){let t=this.xy2yp(e.xy),s=this.lookYaw+(this.dragWorld[0]-t[0])*this.yawDirection,i=this.lookPitch+(this.dragWorld[1]-t[1])*this.pitchDirection;i=i>1?1:i<-1?-1:i,this.dragWorld=t,this.lookTo(i,s)}let t=this.actor._cardData.avatarEventHandler;this.hasBehavior(`${t}$AvatarPawn`,"handlingEvent")&&this.call(`${t}$AvatarPawn`,"handlingEvent","pointerMove",this,e)}pointerUp(e){if(this.firstResponders)for(let[e,t]of this.firstResponders)for(let e=t.length-1;e>=0;e--){t[e].pawn!==this&&t.splice(e,1)}let t=this.actor._cardData.avatarEventHandler;this.hasBehavior(`${t}$AvatarPawn`,"handlingEvent")&&this.call(`${t}$AvatarPawn`,"handlingEvent","pointerUp",this,e)}pointerTap(e){}pointerWheel(e){let t=this.lookOffset[2];t+=Math.max(1,t)*e.deltaY/1e3,t=Math.min(100,Math.max(t,0)),this.lookOffset=[this.lookOffset[0],t,t];let s=(11*this.lookPitch+Math.max(-t/2,-Math.PI/4))/12;this.lookTo(s,(0,i.q_yaw)(this._rotation),this.lookOffset)}fadeNearby(){let e=this.actor.service("PlayerManager"),t=e.presentationMode,setOpacity=(e,t)=>{const s=e.actor.inWorld;if(!e.modelLoadTime||e.lastOpacity===t&&e.lastInWorld===s)return;e.lastOpacity=t,e.lastInWorld=s;let i=t,o=e.actor._cardData.avatarEventHandler;e.hasBehavior(`${o}$AvatarPawn`,"mapOpacity")&&(t=e.call(`${o}$AvatarPawn`,"mapOpacity",this,t));let r=e.shape.children[0];if(!r)return;let a=s&&0!==t;if(setModelOpacity(r,a,t),e._children)for(let t of e._children)t.actor._cardData.avatarParts&&(t.shape.visible=a);let n=this.shape.getObjectByName("ghostfoot");n&&(n.visible=e.actor.inWorld&&0!==i)};for(let[s,r]of e.players){let e=(0,i.GetPawn)(r.id);if(e)if(this.actor.inWorld)if(r.follow)setOpacity(e,0);else if((e===this&&(0,i.v3_isZero)(r.lookOffset)||r._playerId===t&&this.actor.follow)&&(0,i.v3_isZero)(r.lookOffset))setOpacity(e,0);else{let t=this.lookGlobal,s=new o.THREE.Vector3(t[12],t[13],t[14]);t=r.global;let i=new o.THREE.Vector3(t[12],t[13],t[14]);setOpacity(e,Math.min(Math.max((s.distanceToSquared(i)-.7)/10,0),1))}else setOpacity(e,1)}}addChild(e){super.addChild(e),delete this.lastOpacity}removeChild(e){super.removeChild(e),delete this.lastOpacity}makeCardSpecFrom(e,t,s){let o={...t._cardData},r=this.actor._cardData.avatarEventHandler,a=t._behaviorModules||[],n=e.avatarType,l=o.dataLocation;if(["dataLocation","dataTranslation","dataScale","dataRotation","handedness","modelType","type","name","shadow","avatarType"].forEach((e=>{delete o[e]})),"wonderland"===n||!e.type){let t={name:s||e.nickname||this.actor._name,dataScale:[.3,.3,.3],dataRotation:(0,i.q_euler)(0,Math.PI,0),dataTranslation:[0,-.4,0],dataLocation:l||`./assets/avatars/${this.actor._name}.zip`,modelType:"glb",type:"3d",behaviorModules:a,...o};return"initial"===t.type&&(t.type="3d"),t}let h={type:"3d",modelType:"glb",dataLocation:e.avatarURL,name:e.nickname,dataRotation:[0,Math.PI,0],handedness:e.handedness,shadow:!0,behaviorModules:a,...o};return"initial"===h.type&&(h.type="3d"),"ReadyPlayerMe"===e.type?(h={...h,avatarEventHandler:"HalfBodyAvatarEventHandler",dataScale:[1.5,1.5,1.5],dataTranslation:[0,-.7,0],behaviorModules:[...h.behaviorModules,"HalfBodyAvatarEventHandler"]},h.behaviorModules.indexOf(r)>=0&&(h.behaviorModules=h.behaviorModules.filter((e=>e!==r)))):h={...h,dataScale:[.3,.3,.3],dataTranslation:[0,-.4,0]},h}showSettingsMenu(){new Promise(((e,t)=>{let s=i.Constants.ShowCaseSpec;(0,h.$)(!1,s&&!s.useAvatar,e)})).then((e=>{if(e){const e=window.settingsMenuConfiguration;(0,r.sendToShell)("update-configuration",{localConfig:e});let t=this.makeCardSpecFrom(window.settingsMenuConfiguration,this.actor);delete this.modelLoadTime,this.say("setAvatarData",t),this.modelHasLoaded=!1}}))}showShareMenu(){let e=i.Constants.ShowCaseSpec;(0,h.Y)(this,e&&!e.useAvatar)}showHelpMenu(){let e=i.Constants.ShowCaseSpec;startHelpMenu(e&&!e.useAvatar)}goHome(){if(this.spectator){let e=this.anchorFromURL(window.location.href);e||(e={translation:(0,i.v3_zero)(),rotation:(0,i.q_identity)()});let t=[...e.translation];this.lastCollideTranslation=t,t[0]+=1e-5,this.positionTo(t,e.rotation)}else this.say("goHome")}comeToMe(){let e=this.actor.service("PlayerManager");e.presentationMode?e.presentationMode===this.viewId&&this.say("stopPresentation"):this.say("comeToMe")}jumpToNote(e){let t,s=this.actor.queryCards({methodName:"filterNotes"},this);void 0===this.lastCardId?t=0:(t=s.findIndex((e=>e.id===this.lastCardId)),e.shiftKey?t--:t++),t>=s.length&&(t=0),t<0&&(t=s.length-1);let o=s[t];if(o){this.lastCardId=o.id;let e=(0,i.GetPawn)(o.id);if(!e)return;let t=e.getJumpToPose?e.getJumpToPose():null;if(t){let s={xyz:t[0],offset:t[1],look:!0,targetId:o.id,normal:e.hitNormal||[0,0,1]};this.say("goThere",s)}}}filterNotes(e){return e._behaviorModules&&e._behaviorModules.includes("StickyNote")}loadFromFile(e,t,s){let i=this.actor.wellKnownModel("ModelRoot"),o=(new TextEncoder).encode(e),r=0,a=Math.random();for(this.publish(i.id,"loadStart",a);r<o.length;){let e=o.slice(r,r+2880);this.publish(i.id,"loadOne",{key:a,buf:e}),r+=2880}let n=s?this.dropPose(6):null;this.publish(i.id,"loadDone",{asScene:t,key:a,pose:n})}getAudioListener(){return this.audioListener||(this.audioListener=new o.THREE.AudioListener,this.camera.add(this.audioListener)),this.audioListener}}},3654:(e,t,s)=>{"use strict";s.d(t,{Z4:()=>CardActor,Df:()=>CardPawn,q7:()=>MicroverseAppManager,Wh:()=>c});var i=s(4200),o=s(5679),r=s(2691),a=s(3782),n=s(4355);class DynamicTexture{constructor(e,t,s,i){(e>2048||t>2048)&&console.warn("large texture: "+e+"x"+t);var nearestPowerOfTwo=e=>2**Math.round(Math.log(e)/Math.LN2),r=nearestPowerOfTwo(e),a=nearestPowerOfTwo(t);(r!==e||a!==t)&&console.log("TDynamicTexture: "+e+"x"+t+" becomes "+r+"x"+a),this.canvas=document.createElement("canvas"),this.canvas.width=this.width=r,this.canvas.height=this.height=a,this.context=this.canvas.getContext("2d"),this.texture=new o.THREE.CanvasTexture(this.canvas),this.extractMipmapLevel=3,this.fontName="Arial",this.fontHeight=32,this.fillStyle=s||"black",this.clearStyle=i,this.setFont("normal 32px Arial"),this.align="left",this.scale=1}asMaterial(){return new o.THREE.MeshStandardMaterial({color:16777215,roughness:1,emissive:3355443,map:this.texture,transparent:!1})}getTexture(){return this.texture}getMiniTexture(){if(this.miniTexture)return this.miniTexture;let e=this.texture,t=this.extractMipmapLevel,s=2**t,i=this.width/s,r=this.height/s,a=this.service("ThreeRenderManager").renderer.getContext(),n=a.createTexture();const l=a.RGBA,h=a.RGBA,d=a.UNSIGNED_BYTE;a.bindTexture(a.TEXTURE_2D,n);let c=o.THREE.WebGLUtils(a);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,e.flipY),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),a.pixelStorei(a.UNPACK_ALIGNMENT,e.unpackAlignment),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,c.convert(e.wrapS)),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,c.convert(e.wrapT)),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,c.convert(e.magFilter)),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,c.convert(e.minFilter)),a.texImage2D(a.TEXTURE_2D,0,l,h,d,this.canvas),a.generateMipmap(a.TEXTURE_2D);let u,p=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,p),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,n,t);let f=a.checkFramebufferStatus(a.FRAMEBUFFER),m=f===a.FRAMEBUFFER_COMPLETE;if(m?(u=new Uint8Array(i*r*4),a.readPixels(0,0,i,r,a.RGBA,a.UNSIGNED_BYTE,u)):console.log("frame buffer not ready; status="+f),a.deleteFramebuffer(p),a.deleteTexture(n),!m)return null;let g=document.createElement("canvas"),y=g.getContext("2d");g.width=i,g.height=r;let v=y.createImageData(i,r);return v.data.set(u),y.putImageData(v,0,0),this.miniTexture=new o.THREE.CanvasTexture(g),this.miniTexture.flipY=!1,this.miniTexture}discardMiniTexture(){delete this.miniTexture}setFont(e){this.context.font=this.font=this.lastContextFont=e}setContextFont(e){e!==this.lastContextFont&&(this.context.font=this.lastContextFont=e)}setFillStyle(e){this.fillStyle=e}setAlign(e){this.align=e}doWithClip(e,t,s,i,o){let r=this.context;r.save(),r.beginPath(),r.rect(e,t,s,i),r.clip(),o(),r.restore(),this.lastContextFont=this.font}fill(e){this.context.save(),this.context.scale(1/this.scale,1/this.scale),this.fillRect(0,0,this.canvas.width,this.canvas.height,e),this.context.restore()}clear(){this.context.save(),this.context.scale(1/this.scale,1/this.scale),this.clearRect(0,0,this.canvas.width,this.canvas.height),this.texture.needsUpdate=!0,this.context.restore()}fillRect(e,t,s,i,o){this.context.fillStyle=o||this.fillStyle,this.context.fillRect(e,t,s,i),this.texture.needsUpdate=!0}clearRect(e,t,s,i){void 0!==this.clearStyle?(this.context.fillStyle=this.clearStyle,this.context.fillRect(e,t,s,i)):this.context.clearRect(e,t,s,i),this.texture.needsUpdate=!0}drawImage(...e){this.context.drawImage(...e),this.texture.needsUpdate=!0}drawText(e,t,s,i,o,r){if(!function isNumber(e){return!isNaN(parseFloat(e))&&isFinite(e)}(t))return this.drawTextCentered(e,s,i,o,r);this.setContextFont(o||this.font);let a=this.context;a.textAlign=this.align,r||(a.fillStyle="black",a.fillText(e,t+1,s+1)),a.fillStyle=i||this.fillStyle,a.fillText(e,t,s),this.texture.needsUpdate=!0}drawTextCentered(e,t,s,i,o){this.setContextFont(i||this.font);var r=this.context.measureText(e).width,a=this.fontHeight,n=(this.canvas.width-r)/2;"number"!=typeof t&&(t=(this.canvas.height+a)/2-2),o||(this.context.fillStyle="black",this.context.fillText(e,n+1,t+1)),this.context.fillStyle=s||this.fillStyle,this.context.fillText(e,n,t),this.texture.needsUpdate=!0}drawTextRight(e,t,s,i,o){this.setContextFont(i||this.font);var r=this.context.measureText(e).width+2,a=this.fontHeight,n=this.canvas.width-r;"number"!=typeof t&&(t=(this.canvas.height+a)/2-2),o||(this.context.fillStyle="black",this.context.fillText(e,n+1,t+1)),this.context.fillStyle=s||this.fillStyle,this.context.fillText(e,n,t),this.texture.needsUpdate=!0}drawTextLeft(e,t,s,i){this.setContextFont(i||this.font);var o=this.fontHeight;t=t||(this.canvas.height+o)/2-2;this.context.fillStyle="black",this.context.fillText(e,3,t+1),this.context.fillStyle=s||this.fillStyle,this.context.fillText(e,2,t),this.texture.needsUpdate=!0}drawRect(e,t,s,i,o,r){this.context.beginPath(),this.context.lineWidth=r||"4",this.context.strokeStyle=o||"green",this.context.rect(e,t,s,i),this.context.stroke(),this.texture.needsUpdate=!0}drawLine(e,t,s,i,o,r){this.context.lineWidth=r||"1",this.context.strokeStyle=o||"white",this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(s,i),this.context.stroke(),this.texture.needsUpdate=!0}drawPoly(e,t,s){this.context.lineWidth=s||"1",this.context.strokeStyle=t||"white",this.context.beginPath(),this.context.moveTo(e[0],e[1]);for(let t=2;t<e.length;t+=2)this.context.lineTo(e[t],e[t+1]);this.context.stroke(),this.texture.needsUpdate=!0}drawPath(e){this.context.stroke(e),this.texture.needsUpdate=!0}drawImage(e,t,s,i,o){this.context.drawImage(e,t,s,i,o),this.texture.needsUpdate=!0}changed(){this.texture.needsUpdate=!0,this.mipmapTexture.dispose(),this.mipmapTexture=null}setScale(e){this.scale=e,this.context.scale(e,e)}}var l=s(6946),h=s(4072);const{MeshBVH:d}=o.THREE_MESH_BVH,c=["translation","scale","rotation","layers","parent","behaviorModules","multiuser","name","noSave"];class CardActor extends((0,i.mix)(i.Actor).with(i.AM_Smoothed,r.w9,l.Xl)){static okayToIgnore(){return["$local","$global","$rigidBody"]}init(e){let{cardOptions:t,cardData:s}=this.separateOptions(e);t.layers||(t.layers=["pointer"]),this.scriptListeners=new Map,super.init(t),this._cardData=s,this.noSave=e.noSave,this.createShape(s),this.listen("selectEdit",this.saySelectEdit),this.listen("unselectEdit",this.sayUnselectEdit),this.listen("showControls",this.showControls),this.listen("setCardData",this.setCardData),this.listen("setAnimationClipIndex",this.setAnimationClipIndex)}destroy(){this.publish("actorManager","destroyed",this.id),super.destroy()}separateOptions(e){let t={},s={};return Object.keys(e).forEach((i=>{c.indexOf(i)>=0?t[i]=e[i]:s[i]=e[i]})),{cardOptions:t,cardData:s}}updateOptions(e){let{cardOptions:t,cardData:s}=this.separateOptions(e);this.updateBehaviors(e),this.set({...t}),this.set({cardData:s}),this.say("updateShape",e)}addBehaviorModule(e){let t;if(this._behaviorModules){if(this._behaviorModules.includes(e))return;t=[...this._behaviorModules,e]}else t=[e];this.updateBehaviors({behaviorModules:t})}removeBehaviorModule(e){let t;if(!this._behaviorModules)return;let s=this._behaviorModules.indexOf(e);s<0||(t=[...this._behaviorModules],t.splice(s,1),this.updateBehaviors({behaviorModules:t}))}updateBehaviors(e){if(!e.behaviorModules)return;let t=this.behaviorManager,s=[],i=[];e.behaviorModules.forEach((e=>{let o=t.modules.get(e);o?(o.actorBehaviors&&s.push(...o.actorBehaviors.values()),o.pawnBehaviors&&i.push(...o.pawnBehaviors.values())):console.error(`unknown module ${e} is specified for update`)}));let o=[],r=[];this._behaviorModules&&this._behaviorModules.forEach((e=>{let s=t.modules.get(e);s.actorBehaviors&&o.push(...s.actorBehaviors.values()),s.pawnBehaviors&&r.push(...s.pawnBehaviors.values())})),o.forEach((e=>{s.includes(e)||t.modelUnuse(this,e)})),r.forEach((e=>{i.includes(e)||t.viewUnuse(this,e)})),s.forEach((e=>{o.includes(e)||t.modelUse(this,e)})),i.forEach((e=>{r.includes(e)||t.viewUse(this,e)})),this._behaviorModules=[...e.behaviorModules]}addLayer(e){this._layers&&this._layers.includes(e)||this.set({layers:[...this._layers||[],e]})}removeLayer(e){this._layers.includes(e)&&(this._layers=this._layers.filter((t=>t!==e)))}setCardData(e){let t={...this._cardData,...e};this.set({cardData:t}),this.updateBehaviors(e)}createShape(e){let t=e.type;"text"===t?this.subscribe(this.id,"changed","textChanged"):"code"===t?(this.subscribe(this.id,"changed","textChanged"),this.subscribe(this.id,"text","codeAccepted")):"3d"===t||"3D"===t?void 0!==this._cardData.animationClipIndex&&void 0===this._cardData.animationStartTime&&(this._cardData.animationStartTime=this.now()):"2d"===t||"2D"===t||"lighting"===t||"object"===t||"initial"===t||console.log("unknown type for a card: ",e.type)}get pawn(){return CardPawn}get layers(){return this._layers}get isCard(){return!0}get name(){return this._name||"Card"}get color(){return this._color||16777215}uv2xy(e){return[this._cardData.textureWidth*e[0],this._cardData.textureHeight*(1-e[1])]}textChanged(){this._cardData.runs=this.content.runs,this.publish(this.sessionId,"triggerPersist")}sayDeck(e,t){if(this._parent)return this.publish(this._parent.id,e,t);this.publish(this.id,e,t)}listenDeck(e,t){if(this._parent)return this.subscribe(this._parent.id,e,t);this.subscribe(this.id,e,t)}rotateTo(e){"number"==typeof e&&(e=[0,e,0]);let t=3===e.length?(0,i.q_euler)(...e):e;return super.rotateTo(t)}rotateBy(e){"number"==typeof e&&(e=[0,e,0]);let t=3===e.length?(0,i.q_euler)(...e):e,s=(0,i.q_multiply)(this.rotation,t);super.rotateTo(s)}translateTo(e){return super.translateTo(e)}translateBy(e){let t=this.translation;super.translateTo([t[0]+e[0],t[1]+e[1],t[2]+e[2]])}forwardBy(e){let t=Array.isArray(e)?e:[0,0,e],s=(0,i.v3_rotate)(t,this.rotation),o=this.translation;super.translateTo([o[0]+s[0],o[1]+s[1],o[2]+s[2]])}scaleTo(e){let t=Array.isArray(e)?e:[e,e,e];super.scaleTo(t)}scaleBy(e){let t=Array.isArray(e)?e:[e,e,e],s=this.scale;super.scaleTo([s[0]+t[0],s[1]+t[1],s[2]+t[2]])}nop(){}duplicate(){let e=new h.H(CardActor).collectCardData(this);delete e.parent;let t=this.translation;e.translation=[t[0]+2,t[1],t[2]],this.createCard(e)}saveCard(e){this.say("saveCard",e)}allChildrenMap(e){return e||(e=new Map),this.noSave||e.set(this.id,this),this.children&&this.children.forEach((t=>t.allChildrenMap(e))),e}showControls(e){let t=this.service("ActorManager").actors.get(e.avatar),s=e.distance||6;if(s=Math.min(.7*s,4),t){let e=t.dropPose(s,[1,1,0]);if(!this.behaviorManager.modules.get("PropertySheet"))return;this.createCard({name:"property panel",behaviorModules:["PropertySheet"],translation:e.translation,rotation:e.rotation,type:"object",fullBright:!0,color:16777215,frameColor:6710886,width:3,height:3.2,cornerRadius:.02,depth:.02,noSave:!0,target:this.id}).call("PropertySheet$PropertySheetActor","setObject",this)}}setAnimationClipIndex(e){this._cardData.animationClipIndex=e,void 0===this._cardData.animationStartTime&&(this._cardData.animationStartTime=this.now()),this.say("animationStateChanged")}intrinsicProperties(){return c}saySelectEdit(e){console.log("saySelectEdit says doSelectEdit",e),this.editBox=e,this.say("doSelectEdit")}sayUnselectEdit(){this.say("doUnselectEdit")}collectCardData(){return new h.H(CardActor).collectCardData(this,!0)}static load(e,t,s){let o,r;if(Array.isArray(e)?o=e:(o=e.array,r=e.nameMap),"1"===s){let e=t.service("MicroverseAppManager"),s=t.service("BehaviorModelManager"),a=new Map;return o.map((({id:t,card:o})=>{let l,h,d={...o};if("code"===d.type){if(d.behaviorModule){let[e,t]=d.behaviorModule.split(".");h=s.lookup(e,t)}let e=[{text:h?h.code:""}];d={backgroundColor:13421772,textScale:d.textScale||.002,...d,runs:e},l=n.T0}else"text"===o.type?l=n.T0:o.className?(l=e.get(o.className),delete d.className):l=CardActor;if(o.parent&&"object"!=typeof o.parent){let e=a.get(o.parent);d.parent=e}Array.isArray(o.rotation)&&3===o.rotation.length&&(d.rotation=(0,i.q_euler)(...o.rotation)),Array.isArray(o.dataRotation)&&3===o.dataRotation.length&&(d.dataRotation=(0,i.q_euler)(...o.dataRotation)),r&&d.behaviorModules&&(d.behaviorModules=d.behaviorModules.map((e=>r.get(e)||e))),"string"==typeof d.parent&&(console.log("encountered parent as string",d.parent),delete d.parent);let c=l.create(d);return t&&a.set(t,c),"code"===d.type&&h&&c.subscribe(h.id,"setCode","loadAndReset"),c.initBehaviors(d),c}))}return[]}get rigidBody(){return this._oldRapier07?{applyForce:()=>{},applyTorque:()=>{}}:this.call("Physics$PhysicsActor","getRigidBody")}setPhysicsWorld(e){return this._physicsWorld=e,e}get physicsWorld(){let e=this.service("PhysicsManager");return e.globalWorld?e.globalWorld:this._physicsWorld?this._physicsWorld:this._parent?this._parent._physicsWorld:void 0}collisionEvent(e,t,s){return this.call(this.collisionEventHandlerBehavior,this.collisionEventHandlerMethod,e,t,s)}getTextFieldActorClass(){return n.T0}}CardActor.register("CardActor");class CardPawn extends((0,i.mix)(i.Pawn).with(i.PM_Smoothed,o.PM_ThreeVisible,r.vJ,l.AH)){constructor(e){super(e),this.addToLayers(...e.layers),this.addEventListener("pointerDoubleDown","onPointerDoubleDown"),this.listen("doSelectEdit",this.doSelectEdit),this.listen("doUnselectEdit",this.doUnselectEdit),this.listen("cardDataSet",this.cardDataUpdated),this.listen("updateShape",this.updateShape),this.listen("layersSet",this.updateLayers),this.listen("saveCard",this.saveCard),this.listen("animationStateChanged",this.tryStartAnimation),this.animationInterval=null,this.subscribe(this.id,"3dModelLoaded",this.tryStartAnimation),this.constructCard(),this._editMode=!1}sayDeck(e,t){void 0!==this.actor._parent?this.publish(this.actor._parent.id,e,t):this.publish(this.actor.id,e,t)}listenDeck(e,t){void 0!==this.actor._parent?this.subscribe(this.actor._parent.id,e,t):this.subscribe(this.actor.id,e,t)}constructCard(){this.shape=new o.THREE.Group,this.shape.name=this.actor.name,this.setRenderObject(this.shape),this.constructShape(this.actor._cardData)}constructShape(e){let t=e.type;"3d"===t||"3D"===t?this.construct3D(e):"2d"===t||"2D"===t?(this.isFlat=!0,this.construct2D(e)):"text"!==t&&"code"!==t||(this.isFlat=!0)}destroy(){let e=this.actor._cardData,t=this.service("AssetManager").assetManager;e.dataLocation&&t.revoke(e.dataLocation,this.id),e.textureLocation&&t.revoke(e.textureLocation,this.id),this.cleanupColliderObject(),super.destroy()}ensureColliderObject(){if(!this.colliderObject){let e=new o.THREE.Group;this.setColliderObject(e),e.collider=!0}}cleanupColliderObject(){this.colliderObject&&([...this.colliderObject.children].forEach((e=>{e.geometry&&(e.geometry.dispose(),this.colliderObject.remove(e))})),this.colliderObject.geometry&&this.colliderObject.geometry.dispose(),this.colliderObject.removeFromParent(),delete this.colliderObject)}updateLayers(){let e=this.layers(),t=[];e.forEach((e=>{this.actor.layers.includes(e)||t.push(e)})),t.length>0&&this.removeFromLayers(...t);let s=this.actor._layers;s&&this.addToLayers(...s)}cleanupShape(e){this.updateLayers(),delete this.isFlat,this.placeholder&&(this.placeholder.children.forEach((e=>{e.geometry.dispose(),e.material.dispose()})),this.shape.remove(this.placeholder),delete this.placeholder),delete this.video,this.texture&&(this.texture.dispose(),delete this.texture),this.objectURL&&(URL.revokeObjectURL(this.objectURL),delete this.objectURL),this.material&&this.material.dispose(),delete this.name,delete this.properties2D,delete this.animationSpec,this.animationInterval&&(clearInterval(this.animationInterval),this.animationInterval=null),this.cleanupColliderObject(),this.shape&&(this.shape.traverse((e=>{e!==this.shape&&(e.geometry&&e.geometry.dispose(),e.material&&(e.material.dispose?e.material.dispose():e.material.forEach((e=>e.dispose()))))})),[...this.shape.children].forEach((e=>this.shape.remove(e))))}updateShape(e){this.cleanupShape(e),this.constructShape(this.actor._cardData)}construct3D(e){let t=this.service("AssetManager").assetManager,s=e.dataLocation,i=e.modelType;if(!i&&s){let e=s.lastIndexOf(".");if(e>0){let o=s.slice(e+1);t.supportedFileTypes.has(o)&&(i=o)}}let publishLoaded=()=>{this.publish(this.id,"3dModelLoaded"),this.actor._cardData.loadSynchronously&&this.publish(this.sessionId,"synchronousCardLoaded",{id:this.actor.id})};if(e.placeholder){let t=e.placeholderSize||[40,1,40],s=e.placeholderColor||8421504,i=e.placeholderOffset||[0,-1.7,0];const r="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOnAAADusBZ+q87AAAAJtJREFUeJzt0EENwDAAxLDbNP6UOxh+NEYQ5dl2drFv286598GrA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAu37AD8eaBH5JQdVbAAAAAElFTkSuQmCC";let a=new Image,n=new o.THREE.Texture(a);a.onload=()=>n.needsUpdate=!0,a.src=r,n.wrapS=o.THREE.RepeatWrapping,n.wrapT=o.THREE.RepeatWrapping,n.repeat.set(t[0],t[2]);let l=new o.THREE.BoxGeometry(...t),h=new o.THREE.MeshStandardMaterial({map:n,color:s,side:o.THREE.FrontSide}),d=new o.THREE.Mesh(l,h);d.receiveShadow=!0,this.placeholder=d,this.placeholder.position.set(...i),this.placeholder.name="placeholder",this.actor.layers.indexOf("walk")>=0&&this.constructCollider(this.placeholder),this.shape.add(this.placeholder)}let r=this.actor.name,n=void 0===e.shadow||e.shadow,l=void 0!==e.singleSided&&e.singleSided,h=void 0!==e.noFog&&e.noFog;s&&this._model3dLoading!==s&&(this._model3dLoading=s,this.getBuffer(s).then((e=>(t.setCache(s,e,this.id),t.load(e,i,o.THREE)))).then((i=>{if(s!==this._model3dLoading)return void console.log("model load has been superseded");if(this.setupObj(i,e),this.setupAnimation(i),i.updateMatrixWorld(!0),e.placeholder&&(console.log("delete collider for placeholder"),t.revoke(s,this.id),this.cleanupColliderObject(),this.shape.remove(this.placeholder)),e.flatten){let e=this.flattenObj(i);e!==i&&(i.traverse((e=>{e.geometry&&(e.geometry.dispose(),e.material.dispose())})),i=e)}let d=void 0!==e.fullBright&&e.fullBright;(0,a.Bg)(i,n,l,h,d,o.THREE),this.actor.layers.indexOf("walk")>=0&&this.constructCollider(i),this.shape.add(i),i.updateMatrixWorld(!0),r&&(i.name=r),Array.isArray(i.material)&&(i.material.dispose=arrayDispose),delete this._model3dLoading,publishLoaded()})).catch((e=>{delete this._model3dLoading})))}construct2D(e){let t,s=e.dataLocation,i=e.textureLocation,r=e.textureType,n=void 0!==e.depth?e.depth:.05,l=void 0!==e.width?e.width:1,h=void 0!==e.height?e.height:1,d=void 0!==e.textureWidth?e.textureWidth:512,c=void 0!==e.textureHeight?e.textureHeight:512,u=e.name||this.id,p=e.color,f=e.frameColor||6710886,m=void 0!==e.fullBright&&e.fullBright,g=void 0===e.shadow||e.shadow,y=void 0!==e.cornerRadius?e.cornerRadius:0;this.properties2D={depth:n,width:l,height:h,textureWidth:d,textureHeight:c,name:u,color:p,frameColor:f,fullBright:m,shadow:g,cornerRadius:y};let publishLoaded=()=>{this.publish(this.id,"2dModelLoaded"),this.actor._cardData.loadSynchronously&&this.publish(this.sessionId,"synchronousCardLoaded",{id:this.actor.id})};if("video"===r){let s=void 0===this.actor._cardData.muted||this.actor._cardData.muted,r=void 0!==this.actor._cardData.loop&&this.actor._cardData.loop,a=void 0!==this.actor._cardData.autoplay&&this.actor._cardData.autoplay;this.video=document.createElement("video"),this.video.autoplay=a,this.video.muted=s,this.video.loop=r,this.video.controls=!1,t=this.getBuffer(i).then((e=>{let t=URL.createObjectURL(new Blob([e],{type:"video/mp4"}));return this.video.src=t,this.video.preload="metadata",this.objectURL=t,this.videoPromiseResolved=!1,new Promise(((e,t)=>{this.video.onloadeddata=e,this.video.onloadedmetadata=e,this.video.onerror=t}))})).then((()=>(this.videoPromiseResolved||(this.videoPromiseResolved=!0,this.video.onloadeddata=null,this.video.onloadedmetadata=null),this.videoLoaded=!0,this.video.width=e.textureWidth||this.video.videoWidth,this.video.height=e.textureHeight||this.video.videoHeight,this.video.currentTime=.03,this.texture=new o.THREE.VideoTexture(this.video),{width:this.video.width,height:this.video.height,texture:this.texture})))}else"image"===r?t=this.getBuffer(i).then((e=>{if(e.texture)return this.texture=e.texture,Promise.resolve(e);let t=URL.createObjectURL(new Blob([e]));return this.objectURL=t,new Promise(((e,s)=>{this.texture=(new o.THREE.TextureLoader).load(t,(s=>{URL.revokeObjectURL(t),e({width:s.image.width,height:s.image.height,texture:s})}),null,s)}))})):"canvas"===r?(this.canvas=document.createElement("canvas"),this.canvas.id=u,this.canvas.width=d,this.canvas.height=c,this.texture=new o.THREE.CanvasTexture(this.canvas),t=Promise.resolve({width:d,height:c,texture:this.texture})):"dynamic"===r&&(this.dynamic=new DynamicTexture(d,c,e.fillStyle,e.clearStyle),this.texture=this.dynamic.texture,t=Promise.resolve({width:d,height:c,texture:this.texture}));t||(t=Promise.resolve(void 0));let v={texture:this.texture,color:p,frameColor:f,fullBright:m,shadow:g,depth:n},w=this.service("AssetManager").assetManager;return s?this.getBuffer(s).then((e=>(w.setCache(s,e,this.id),w.load(e,"svg",o.THREE,v)))).then((e=>((0,a.bp)(e,n,g,o.THREE),e))).then((t=>{this.texture&&(0,a.iF)(t,this.texture),e.dataTranslation&&t.position.set(...e.dataTranslation),t.name="2d",Array.isArray(t.material)&&(t.material.dispose=arrayDispose),this.objectCreated(t),this.shape.add(t),this.actor.layers.indexOf("walk")>=0&&this.constructCollider(t),publishLoaded()})):t.then((e=>{if(e&&e.texture){d=e.width,c=e.height;let t=1/Math.max(d,c);l=d*t,h=c*t,i&&w.setCache(i,e,this.id),this.properties2D={...this.properties2D,width:l,height:h,textureWidth:d,textureHeight:c}}let t=this.roundedCornerGeometry(l,h,n,y),s=this.makePlaneMaterial(n,p||16777215,f,m);this.texture&&(s[0].map=this.texture),this.material=s;let r=new o.THREE.Mesh(t,s);r.castShadow=g,r.name="2d",this.objectCreated(r),this.shape.add(r),this.actor.layers.indexOf("walk")>=0&&this.constructCollider(r),publishLoaded()}))}flattenObj(e){let t=new o.THREE.Group,s=[],i=0,r=0;try{e.traverse((e=>{if(i++,e.geometry){let t=e.geometry.clone();if(t.applyMatrix4(e.matrixWorld),t.index){t.attributes.uv2&&(delete t.attributes.uv2,delete t.attributes.texcoord_2);let i=e.material.map?e.material.map.id:0;s[i]||(s[i]={material:e.material.clone(),geometries:[]}),s[i].geometries.push(t)}else console.warn("skipping a geometry in the model that is not indexed")}}));let a=o.THREE.BufferGeometryUtils;s.forEach((e=>{r++;let s=a.mergeBufferGeometries(e.geometries,!1),i=new o.THREE.Mesh(s,e.material);t.add(i)}))}catch(t){return console.error("failed to build the static for:",e),console.error(t),e}return console.log("Static - before:",i,"end:",r,"object:",e),t}constructCollider(e){let t,s=[];this.ensureColliderObject();let i=e.matrix;e.matrix=new o.THREE.Matrix4;try{e.traverse((e=>{if(e.geometry){let t=e.geometry.clone();t.applyMatrix4(e.matrixWorld);for(const e in t.attributes)"position"!==e&&t.deleteAttribute(e);t.index?s.push(t):console.warn("skipping a geometry in the model that is not indexed")}})),t=window.THREE.BufferGeometryUtils.mergeBufferGeometries(s,!1),t.boundsTree=new d(t,{lazyGeneration:!1})}catch(t){return console.error("failed to build the BVH collider for:",e),void console.error(t)}finally{e.matrix=i}let r=new o.THREE.Mesh(t);r.material.wireframe=!0,r.material.opacity=.5,r.matrixWorld=e.matrixWorld.clone(),r.updateMatrixWorld(!0),r.visible=!1,this.colliderObject.add(r)}setupObj(e,t){if(t.dataScale&&e.scale.set(...t.dataScale),t.dataTranslation&&e.position.set(...t.dataTranslation),t.dataRotation){let s=3===t.dataRotation.length?(0,i.q_euler)(...t.dataRotation):t.dataRotation;e.quaternion.set(...s)}}setupAnimation(e){if(!e._croquetAnimation)return;let t=e._croquetAnimation;t&&(this.animationSpec=t,this.tryStartAnimation())}objectCreated(){}roundedCornerGeometry(e,t,s,i){let r=t/2,n=e/2,l=s/2,h=void 0===i?0:i,d=new o.THREE.Shape;d.moveTo(-r,-n+h),d.lineTo(-r,n-h),d.quadraticCurveTo(-r,n,-r+h,n),d.lineTo(r-h,n),d.quadraticCurveTo(r,n,r,n-h),d.lineTo(r,-n+h),d.quadraticCurveTo(r,-n,r-h,-n),d.lineTo(-r+h,-n),d.quadraticCurveTo(-r,-n,-r,-n+h);let c=new o.THREE.LineCurve3(new o.THREE.Vector3(0,0,l),new o.THREE.Vector3(0,0,-l));c.arcLengthDivisions=3;let u=new o.THREE.ExtrudeGeometry(d,{extrudePath:c});u.parameters.width=e,u.parameters.height=t,u.parameters.depth=s;let p=(0,a.Sb)(u,o.THREE,!0),f=new o.THREE.Box3(new o.THREE.Vector3(-r,-n,-l),new o.THREE.Vector3(r,n,l));return p.parameters=u.parameters,((e,t)=>{let s=t.max.x-t.min.x,i=t.max.y-t.min.y;if(s&&i){let t=1,o=1;i>s?o=i/s:s>i&&(t=s/i);for(let s=0;s<e.length;s+=2)e[s]=e[s]*t+.5,e[s+1]=e[s+1]*o+.5}})(p.getAttribute("uv").array,f),p}makePlaneMaterial(e,t,s,i){let r;if(this.material&&this.material.dispose(),r=i?new o.THREE.MeshBasicMaterial({color:t,side:o.THREE.FrontSide,toneMapped:!1}):new o.THREE.MeshPhongMaterial({color:t,side:o.THREE.FrontSide}),e>0){let e;e=new o.THREE.MeshPhongMaterial({color:s,side:o.THREE.FrontSide}),r=[r,e]}return this.material=r,Array.isArray(this.material)&&(this.material.dispose=arrayDispose),r}dataType(e){return e.startsWith("data:")?"dataUri":/^[a-z0-9-_]+$/i.test(e)&&e.length>87?"dataId":"url"}getBuffer(e){let t=this.service("AssetManager").assetManager.getCache(e);if(t)return Promise.resolve(t);let s=this.dataType(e);if("url"===s||"dataUri"===s)return fetch(e).then((e=>{if(!e.ok)throw Error(`fetch failed: ${e.status} ${e.statusText}`);return e.arrayBuffer()})).then((e=>new Uint8Array(e)));if("dataId"===s){let t=i.Data.fromId(e);return i.Data.fetch(this.sessionId,t)}}cardDataUpdated(e){if(this.didPropertyChange(e,["type","dataLocation","dataRotation","dataScale"]))return this.updateShape();if("2d"!==e.v.type)return;let t=this.shape.children.find((e=>"2d"===e.name));if(t&&t.children&&0!==t.children.length&&(t=t.children[0],this.didPropertyChange(e,["depth","width","height","color","frameColor","cornerRadius","fullBright"]))){let{depth:s,width:i,height:o,color:r,frameColor:a,cornerRadius:n,fullBright:l}=e.v;s=void 0!==s?s:.05,i=void 0!==i?i:1,o=void 0!==o?o:1,r=r||16777215,a=a||6710886,n=void 0!==n?n:0,l=void 0!==l&&l;let h=this.makePlaneMaterial(s,r,a,l);if(this.didPropertyChange(e,["depth","width","height","cornerRadius"])){let e=this.roundedCornerGeometry(i,o,s,n);t.geometry=e}t.material=h}}didPropertyChange({o:e,v:t},s){return Array.isArray(s)?s.some((s=>e[s]!==t[s])):e[s]!==t[s]}uv2xy(e){return this.actor.uv2xy(e)}onPointerDoubleDown(e){if(!e.targetId)return;let t=this.getJumpToPose?this.getJumpToPose():null;t&&(e.xyz=t[0],e.offset=t[1],e.look=!0),this.publish(e.avatarId,"goThere",e)}showControls(e){this.say("showControls",e)}getJumpToPose(){if(!this.isFlat)return null;let e=this.renderObject.localToWorld(new o.THREE.Vector3).toArray(),t=this.service("ThreeRenderManager"),s=t.camera.aspect,i=t.canvas.width,r=t.canvas.height,a=r/2*Math.sqrt(3),n=this.renderObject.matrix,l=new o.THREE.Vector3(0,0,0);try{let e=new o.THREE.Vector3(0,0,0);e.setFromMatrixScale(n);let t=new o.THREE.Matrix4;t.makeScale(e.x,e.y,e.z),this.renderObject.matrix=t,(new o.THREE.Box3).setFromObject(this.renderObject).getSize(l)}finally{this.renderObject.matrix=n}return[e,1.1*(l.x/l.y<s?l.y*a/r:l.x*a/i)]}verticalNorm(e){let t=[...e];return t[1]=0,(0,i.v3_sqrMag)(t)<.001&&(t[0]=0,t[1]=e[1],t[2]=0),(0,i.v3_normalize)(t)}dragPlane(e,t){if(!this._plane){let e=t.normal||t.lookNormal;e=this.verticalNorm(e);let s=(0,i.v3_dot)(t.xyz,e);this._plane=new o.THREE.Plane(new o.THREE.Vector3(...e),-s),this._parentInvert=this._parent?(0,i.m4_invert)(this._parent.global):(0,i.m4_identity)(),this.startDrag=(0,i.v3_transform)(t.xyz,this._parentInvert),this._startTranslation=this._translation}let s=new o.THREE.Vector3;e.ray.intersectPlane(this._plane,s);let r=s.toArray(),a=(0,i.v3_transform)(r,this._parentInvert),n=(0,i.v3_sub)(a,this.startDrag);this.set({translation:(0,i.v3_add)(this._startTranslation,n)})}rotatePlane(e,t){if(!this._plane){let e=[...t.lookNormal];e[1]=0,e=(0,i.v3_normalize)(e);let s=(0,i.v3_dot)(t.xyz,e);this._plane=new o.THREE.Plane(new o.THREE.Vector3(...e),-s),this.startDrag=t.xyz,this.baseRotation=this._rotation,this.rotAngle=0}let s=new o.THREE.Vector3;e.ray.intersectPlane(this._plane,s);let r=s.toArray(),a=(0,i.v3_sub)(this.startDrag,r);a[1]=0;let n=(0,i.v3_magnitude)(a);(0,i.v3_cross)(t.lookNormal,a)[1]<0&&(n=-n);let l=(0,i.q_euler)(0,n,0);this.set({rotation:(0,i.q_multiply)(this.baseRotation,l)})}tryStartAnimation(){void 0===this.actor._cardData.animationClipIndex&&this.animationSpec?.animations.length>0&&this.say("setAnimationClipIndex",0),this.runAnimation()}runAnimation(){let e=this.animationSpec;if(!e)return void(this.animationInterval&&(clearInterval(this.animationInterval),this.animationInterval=null));this.animationInterval||(this.animationInterval=setInterval((()=>this.runAnimation()),50));let t=this.actor._cardData.animationClipIndex;if(void 0===t)return;if(t<0)return;let s=this.now(),i=this.actor._cardData.animationStartTime,{mixer:o,lastTime:r,lastAnimationClipIndex:a}=e;if(t!==a){o.stopAllAction();let s=e.animations[t];if(!s)return;o.clipAction(s).play(),e.lastAnimationClipIndex=t}let n=(s-i)/1e3,l=n-r;o.update(l),e.lastTime=n}selectEdit(){this.say("selectEdit",this.getBox(this.renderObject))}unselectEdit(){this.say("unselectEdit"),delete this._plane}doSelectEdit(){this._editMode=!0,console.log("doSelectEdit")}doUnselectEdit(){this._editMode=!1,console.log("doUnselectEdit")}getBox(e){let t,s=new o.THREE.Matrix4,i=e.matrix;try{e.matrix=s,t=(new o.THREE.Box3).setFromObject(e)}finally{e.matrix=i}return[...t.min.toArray(),...t.max.toArray()]}nop(){}getMyAvatar(){let e=this.actor.service("PlayerManager").players.get(this.viewId);if(e)return(0,i.GetPawn)(e.id)}addWireBox(e){let t,s=new o.THREE.Matrix4,i=e.matrix;try{e.matrix=s,t=(new o.THREE.Box3).setFromObject(e)}finally{e.matrix=i}let r=t.min,a=t.max,n=a.x-r.x,l=(a.x+r.x)/2,h=a.y-r.y,d=(a.y+r.y)/2,c=a.z-r.z,u=(a.z+r.z)/2,cylinder=(e,t,s,i,r)=>{let a=new o.THREE.CylinderGeometry(.02,.02,e);return t&&a[t](Math.PI/2),a.translate(s,i,r),a},p=[cylinder(n,"rotateZ",l,1.01*a.y,1.01*a.z),cylinder(n,"rotateZ",l,1.01*a.y,1.01*r.z),cylinder(n,"rotateZ",l,1.01*r.y,1.01*a.z),cylinder(n,"rotateZ",l,1.01*r.y,1.01*r.z),cylinder(h,null,1.01*a.x,d,1.01*a.z),cylinder(h,null,1.01*a.x,d,1.01*r.z),cylinder(h,null,1.01*r.x,d,1.01*a.z),cylinder(h,null,1.01*r.x,d,1.01*r.z),cylinder(c,"rotateX",1.01*a.x,1.01*a.y,u),cylinder(c,"rotateX",1.01*a.x,1.01*r.y,u),cylinder(c,"rotateX",1.01*r.x,1.01*a.y,u),cylinder(c,"rotateX",1.01*r.x,1.01*r.y,u)],f=o.THREE.BufferGeometryUtils.mergeBufferGeometries(p,!1),m=new o.THREE.MeshStandardMaterial({color:14540253,transparent:!0,opacity:.6,depthTest:!1,depthWrite:!1}),g=new o.THREE.Mesh(f,m);g._wireline=!0,g.renderOrder=1e4,e.add(g)}removeWireBox(e){[...e.children].forEach((e=>{e._wireline&&(e.geometry.dispose(),e.material.dispose(),e.removeFromParent())}))}getAudioListener(){return this.getMyAvatar().getAudioListener()}saveCard(e){if(e.viewId!==this.viewId)return;let t=this.actor.allChildrenMap(),s=new h.H(CardActor),o={},r=s.collectData(t);delete r[0].card.parent,o.cards=r;let a=[];r.forEach((e=>{e.card.behaviorModules&&a.push(...e.card.behaviorModules)}));let n=this.actor.behaviorManager.save(a);o.behaviorModules=n,i.Constants.UserRapier&&(o.useRapier=!0);let l=s.stringify(o),d=this.actor._name||"card",c={name:d,version:"1",data:JSON.parse(l)},u=document.createElement("a"),p="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(c,null,4));u.setAttribute("href",p),u.setAttribute("download",`${d}.vrse`),u.click()}}class MicroverseAppManager extends i.ModelService{init(e){super.init("MicroverseAppManager")}add(e){}set(e,t){}get(e){try{return this.constructor.classFromID(e)}catch(e){}return null}delete(e){}}function arrayDispose(){Array.isArray(this)?this.forEach((e=>e.dispose())):this.dispose()}MicroverseAppManager.register("MicroverseAppManager")},6946:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{AH:()=>PM_Code,IL:()=>BehaviorModelManager,OO:()=>checkModule,Un:()=>CodeLibrary,Xl:()=>AM_Code,ui:()=>BehaviorViewManager});var _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(4200),_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(5679),_physics_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(6590),_frame_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(3917);const{ViewService,ModelService,GetPawn,Model,Constants,App}=_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__;let isProxy=Symbol("isProxy");function newProxy(e,t,s,i){return e[isProxy]?e:new Proxy(e,{get(s,o){if(o===isProxy)return!0;if("_target"===o)return e;if("_behavior"===o)return i;if(t&&t.hasOwnProperty(o)){const s=Object.getOwnPropertyDescriptor(t,o)?.get;return s?s.apply(e):t[o]}return s[o]},set(s,i,o){const r=t&&t.hasOwnProperty(i)&&Object.getOwnPropertyDescriptor(t,i)?.set;return r?r.apply(e,[o]):s[i]=o,!0}})}function getViewRoot(){return window.viewRoot}const AM_Code=e=>class extends e{init(e){super.init(e),this.behaviorManager=this.service("BehaviorModelManager"),this.scriptListeners=new Map}initBehaviors(e){e.behaviorModules&&e.behaviorModules.forEach((e=>{let t=this.behaviorManager.modules.get(e);if(!t)return void console.error(`unknown module ${e} is specified`);let{actorBehaviors:s,pawnBehaviors:i}=t;if(s)for(let e of s.values())this.behaviorManager.modelUse(this,e);if(i)for(let e of i.values())this.behaviorManager.viewUse(this,e)}))}destroy(){if(this[isProxy])return this._target.destroy();this._behaviorModules&&this._behaviorModules.forEach((e=>{let t=this.behaviorManager.modules.get(e);if(!t)return void console.error(`unknown module ${e} is being torn down`);let{actorBehaviors:s,pawnBehaviors:i}=t;if(s)for(let e of s.values())this.behaviorManager.modelUnuse(this,e);if(i)for(let e of i.values())this.behaviorManager.viewUnuse(this,e)})),super.destroy()}future(e){if(!this[isProxy])return super.future(e);let t=this._behavior.$behaviorName,s=this._behavior.module.externalName;return this.futureWithBehavior(e,s,t)}futureWithBehavior(e,t,s){let superFuture=(t,s)=>super.future(e,t,...s),i=this.behaviorManager,o=this.call;return new Proxy(this,{get(e,r){let a=i.lookup(t,s),n="call"===r?o:a.$behavior[r],l="call"===r?"call":`${t}$${s}.${r}`;if("function"==typeof n){return new Proxy(n,{apply:(e,t,s)=>superFuture(l,s)})}throw Error("Tried to call "+r+"() on future of "+s+" which is not a function")}})}call(e,t,...s){let i,o=e.split("$");o.length>1&&(i=o[0],e=o[1]),!i&&this[isProxy]&&(i=this._behavior.module.externalName);let r=this.behaviorManager.lookup(i,e);if(!r)throw new Error(`behavior named ${e} not found`);return r.invoke(this[isProxy]?this._target:this,t,...s)}listen(e,t){return this.scriptSubscribe(this.id,e,t)}subscribe(e,t,s){return this.scriptSubscribe(e,t,s)}has(e,t){return this.hasBehavior(e,t)}hasBehavior(e,t){return this.checkBehavior(this,!0,e,t)}checkBehavior(e,t,s,i){let o,r;if(s.indexOf("$")>0){let e=s.split("$");o=e[0],r=e[1]}else o=s,r=null;!o&&e[isProxy]&&(o=e._behavior.module.externalName);let a=e;t||(a=a.actor);let n=a._behaviorModules,l=a.behaviorManager;if(!n)return!1;if(!n.includes(o))return!1;if(!r)return!0;let h=l.lookup(o,r);return!!h&&(!i||!!h.$behavior[i])}scriptSubscribe(e,t,s){if("function"==typeof s&&!this[isProxy])return super.subscribe(e,t,s);let i,o;"function"==typeof s&&(s=s.name);let r=s.indexOf("$");r>=1&&(o=s.slice(0,r),s=s.slice(r+1));let a=s.indexOf(".");a>=1&&(i=s.slice(0,a),s=s.slice(a+1));let n,l=this._behavior;!o&&l&&(o=l.module.externalName),!i&&l&&(i=l.$behaviorName),n=i?`${o}${o?"$":""}${i}${i?".":""}${s}`:s;let h=`${e}:${t}${n}`;this.scriptListeners&&this.scriptListeners.get(h)||(this.scriptListeners&&this.scriptListeners.set(h,n),super.subscribe(e,t,n))}codeAccepted(e){let t=/^class[\s]+([\S]+)/.exec(e.text.trim());if(!t)return void console.log("code does not begin with the keyword class and name");let s=this._cardData.behaviorModule,[i,o]=s.split(".");if(t[1]!==o)throw new Error("changing the behavior name not supported");let r=this.behaviorManager.moduleDefs.get(i);if(!r)throw new Error("module no longer exists");let a={name:r.name,systemModule:r.systemModule,location:r.location,actorBehaviors:new Map([...r.actorBehaviors]),pawnBehaviors:new Map([...r.pawnBehaviors])},n=a.actorBehaviors.get(o);if(n){if(a.actorBehaviors.get(o)===e.text)return;a.actorBehaviors.set(o,e.text)}else if(n=a.pawnBehaviors.get(o),n){if(a.pawnBehaviors.get(o)===e.text)return;a.pawnBehaviors.set(o,e.text)}console.log("codeAccepted"),this.behaviorManager.loadLibraries([a])}createCard(e){e.parent&&e.parent[isProxy]&&(e={...e,parent:e.parent._target});let t=(this[isProxy]?this._target:this).constructor.load([{card:e}],this.wellKnownModel("ModelRoot"),"1")[0];return this.publish(this.sessionId,"triggerPersist"),t}queryCards(e,t){let s=[...this.service("ActorManager").actors].filter((e=>e[1].isCard)).map((e=>e[1]));return e?(e.moduleName&&e.methodName?s=s.filter((s=>t.call(e.moduleName,e.methodName,s))):e.methodName&&(s=s.filter((s=>t[e.methodName].call(t,s)))),s):s}},PM_Code=e=>class extends e{constructor(e){super(e),this.scriptListeners=new Map;let t=this.actor.behaviorManager;this.subscribe(e.id,"callSetup","callSetup"),this.subscribe(e.id,"callTeardown","callTeardown"),e._behaviorModules&&e._behaviorModules.forEach((e=>{let s=t.modules.get(e),{pawnBehaviors:i}=s||{};if(i)for(let e of i.values())e&&e.ensureBehavior(),e.$behavior.setup&&this.future(0).callSetup(`${s.externalName}$${e.$behaviorName}`)}))}actorCall(e,t,...s){let i=this.actor,o=this._behavior.module.externalName;return i.call(`${o}$${e}`,t,...s)}call(e,t,...s){let i,o=e.split("$");o.length>1&&(i=o[0],e=o[1]),!i&&this[isProxy]&&(i=this._behavior.module.externalName);let r=this.actor.behaviorManager.lookup(i,e);if(!r)throw new Error(`behavior named ${e} not found`);return r.invoke(this[isProxy]?this._target:this,t,...s)}destroy(){if(this[isProxy])return this._target.destroy();this.actor._behaviorModules&&this.actor._behaviorModules.forEach((e=>{let t=this.actor.behaviorManager.modules.get(e);t||console.error(`unknown module ${e} is specified`);let{pawnBehaviors:s}=t;if(s)for(let e of s.values())e.$behavior.teardown&&this.call(`${e.module.externalName}$${e.$behaviorName}`,"teardown")})),super.destroy()}callSetup(e){return this.call(e,"setup")}callTeardown(e){return this.call(e,"teardown")}scriptListen(e,t){return this.scriptSubscribe(this.actor.id,e,t)}subscribe(e,t,s){return this.scriptSubscribe(e,t,s)}has(e,t){return this.hasBehavior(e,t)}hasBehavior(e,t){return this.actor.checkBehavior(this,!1,e,t)}scriptSubscribe(e,t,s){if("function"==typeof s&&!this[isProxy])return super.subscribe(e,t,s);let i,o,r,a;"string"==typeof t?i=t:(i=t.event,o=t.handling),"function"==typeof s&&(s=s.name);let n=s.indexOf("$");n>=1&&(a=s.slice(0,n),s=s.slice(n+1));let l=s.indexOf(".");l>=1&&(r=s.slice(0,l),s=s.slice(l+1));let h,d=this._behavior;!a&&d&&(a=d.module.externalName),!r&&d&&(r=d.$behaviorName),h=r?`${a}${a?"$":""}${r}${r?".":""}${s}`:s;let c=`${e}:${i}${h}`;if(this.scriptListeners&&this.scriptListeners.get(c)&&this.unsubscribe(e,i,h),this.scriptListeners&&this.scriptListeners.set(c,h),h.indexOf(".")>=1){let t=h.split("."),func=e=>this.call(t[0],t[1],e);return super.subscribe(e,i,func)}o?super.subscribe(e,{event:i,handling:o},h):super.subscribe(e,i,h)}update(e,t){super.update(e,t),this.updateRequests&&this.updateRequests.forEach((s=>{this.call(...s,e,t)}))}addUpdateRequest(e){this.updateRequests||(this.updateRequests=[]),this.updateRequests.findIndex((t=>t[0]===e[0]&&t[1]===e[1]))>=0||this.updateRequests.push(e)}removeUpdateRequest(e){if(!this.updateRequests)return;let t=this.updateRequests.findIndex((t=>t[0]===e[0]&&t[1]===e[1]));t<0||this.updateRequests.splice(t,1)}};class ScriptingBehavior extends Model{static okayToIgnore(){return["$behavior","$behaviorName"]}init(e){this.systemBehavior=!!e.systemBehavior,this.module=e.module,this.name=e.name,this.type=e.type,this.location=e.location}setCode(string){if(!string)return void console.log("code is empty for ",this);let theSame=this.code===string;this.code=string;let trimmed=string.trim(),source;if(0===trimmed.length)return;/^class[ \t]/.test(trimmed)&&(source=trimmed);let code=`return (${source}) //# sourceURL=${window.location.origin}/behaviors_evaled/${this.location}/${this.name}`,cls;try{const e={..._croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__,..._ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__,..._physics_js__WEBPACK_IMPORTED_MODULE_2__,..._frame_js__WEBPACK_IMPORTED_MODULE_3__,RAPIER:_physics_js__WEBPACK_IMPORTED_MODULE_2__.Physics,getViewRoot};cls=new Function("Worldcore","Microverse",code)(e,e)}catch(error){console.log("error occured while compiling:",source,error);try{eval(source)}finally{}}"function"==typeof cls&&(this.$behavior=cls.prototype,this.$behaviorName=cls.name,theSame||this.publish(this.id,"setCode",string))}ensureBehavior(){if(!this.$behavior){let e=this.code;this.setCode(e)}return this.$behavior}invoke(e,t,...s){this.ensureBehavior();let i,o=this.$behavior,r=this.$behaviorName,a=newProxy(e,o,this.module,this);try{let e=a[t];if(void 0===e)throw new Error(`a method named ${t} not found in ${r||this}`);i="function"==typeof e?e.apply(a,s):e}catch(s){console.error(`an error occured in ${r}.${t}() on`,e,s),App.messages&&App.showMessage(`Error in ${r}.${t}()`,{level:"error"})}return i}}ScriptingBehavior.register("ScriptingBehavior");class ScriptingModule extends Model{init(e){super.init(e),this.name=e.name,this.systemModule=e.systemModule,this.location=e.location}}ScriptingModule.register("ScriptingModule");class BehaviorModelManager extends ModelService{init(e){super.init(e||"BehaviorModelManager"),this.cleanUp(),this.subscribe(this.id,"loadStart","loadStart"),this.subscribe(this.id,"loadOne","loadOne"),this.subscribe(this.id,"loadDone","loadDone"),this.subscribe(this.sessionId,"disableCodeLoadFlag","disableCodeLoadFlag"),this.codeLoadDisabled=!1}disableCodeLoadFlag(){this.codeLoadDisabled=!0}cleanUp(){this.moduleDefs=new Map,this.modules=new Map,this.behaviors=new Map,this.modelUses=new Map,this.viewUses=new Map,this.externalNames=new Map,this.loadCache=null}createAvailableName(e,t){let s=this.moduleDefs.get(e);if(!s)return e;for(let[s,i]of this.moduleDefs)if(i.location===t&&i.name===e)return s;if(s.location===t)return e;let i=/([^0-9]+)([0-9]*)/.exec(e),o=i[1],r=i[2];for(r=0===r.length?0:parseInt(r,10);;){let e=o+ ++r;if(!this.moduleDefs.get(e))return e}}lookup(e,t){if(!e)return null;let s=this.modules.get(e);if(!s)return null;let i=s.actorBehaviors.get(t);return i?(i.ensureBehavior(),i):(i=s.pawnBehaviors.get(t),i?(i.ensureBehavior(),i):null)}hasBehavior(e,t){if(!e)return!1;let s=this.modules.get(e);if(!s)return!1;if(!t)return!0;let i=s.actorBehaviors.get(t);return!!i||(i=s.pawnBehaviors.get(t),!!i)}loadStart(e){this.key=e,this.loadCache=[]}loadOne(e){this.key&&e.key===this.key&&this.loadCache.push(e.buf)}loadDone(e){if(!this.key)return;if(this.key!==e)return;let t=this.loadCache;this.loadCache=[],this.key=null,this.loadAll(t)}loadAll(e){if(!e)return void console.log("inconsistent message");let t=e.reduce(((e,t)=>e+t.length),0),s=new Uint8Array(t),i=0;for(let t=0;t<e.length;t++)s.set(e[t],i),i+=e[t].length;let o=new TextDecoder("utf-8").decode(s),r=JSON.parse(o);this.loadLibraries(r),this.publish(this.sessionId,"triggerPersist")}loadLibraries(e){if(this.codeLoadDisabled)return;let t,s,i=[],o=new Map;Constants.UserBehaviorDirectory&&(t=Constants.UserBehaviorDirectory.slice(10)),Constants.SystemBehaviorDirectory&&(s=Constants.SystemBehaviorDirectory.slice(10)),e.forEach((e=>{let{action:r,name:a,systemModule:n,location:l}=e;if(l&&!l.startsWith("(detached)")){let e=l.lastIndexOf("/"),i=l.slice(0,e);if(t&&!i.startsWith(t)&&!i.startsWith(s))return}let h=a;if(!r||"add"===r){let t={...e};delete t.action,Array.isArray(t.actorBehaviors)&&(t.actorBehaviors=new Map(t.actorBehaviors)),Array.isArray(t.pawnBehaviors)&&(t.pawnBehaviors=new Map(t.pawnBehaviors)),a=this.createAvailableName(h,l),o.set(h,a),this.externalNames.set(`${l}$${e.name}`,a),this.moduleDefs.set(a,t);let s={actorBehaviors:new Map,pawnBehaviors:new Map},r=this.modules.get(a);r||(r=ScriptingModule.create({name:t.name,systemModule:t.systemModule,location:l})),r.externalName=a,["actorBehaviors","pawnBehaviors"].forEach((t=>{if(e[t]){let o=e[t];for(let[a,h]of o){let o=this.externalNames.get(`${l}$${e.name}`),d=this.lookup(o,a);if(d)d.code!==h&&(d.setCode(h),i.push(d));else{let e=l;l.startsWith("(detached):")&&(e=l.slice(11)),d=ScriptingBehavior.create({systemBehavior:n,module:r,name:a,location:e,type:t.slice(0,t.length-1)}),d.setCode(h),i.push(d)}s[t].set(a,d)}}})),r.actorBehaviors=s.actorBehaviors,r.pawnBehaviors=s.pawnBehaviors,this.modules.set(r.externalName,r)}if("remove"===r)for(let[e,t]of this.modules)t.location===l&&(this.externalNameMap.delete(l),this.modules.delete(e),this.moduleDefs.delete(e))}));let r=[];return i.forEach((e=>{if(e.$behavior.setup)if("actorBehavior"===e.type){let t=this.modelUses.get(e),s=this.service("ActorManager");t&&t.forEach((t=>{let i=s.get(t);i&&e.future(0).invoke(i,"setup")}))}else"pawnBehavior"===e.type&&r.push([e.module.externalName,e.$behaviorName])})),this.publish(this.id,"callViewSetupAll",r),o}save(e){let t=[...this.moduleDefs].filter((([e,t])=>!t.systemModule));return e&&(t=t.filter((([t,s])=>e.includes(t))),t=t.map((([e,t])=>{let s={...t};if(s.location){function randomString(){return Math.floor(Math.random()*36**10).toString(36)}s.location=`(detached):${randomString()}/${randomString()}`}return[e,s]}))),new Map([...t])}modelUse(e,t){let s=e.id,i=this.modelUses.get(t);i||(i=[],this.modelUses.set(t,i)),i.indexOf(s)<0&&(i.push(s),t.ensureBehavior(),t.$behavior.setup&&t.invoke(e[isProxy]?e._target:e,"setup"))}modelUnuse(e,t){let s=e.id,i=this.modelUses.get(t);if(!i)return;let o=i.indexOf(s);o<0||(i.splice(o,1),t.$behavior&&t.$behavior.teardown&&t.future(0).invoke(e[isProxy]?e._target:e,"teardown"))}viewUse(e,t){let s=e.id,i=this.viewUses.get(t);i||(i=[],this.viewUses.set(t,i)),i.indexOf(s)<0&&i.push(s),t.ensureBehavior(),t.$behavior.setup&&e.say("callSetup",`${t.module.externalName}$${t.$behaviorName}`)}viewUnuse(e,t){let s=e.id,i=this.viewUses.get(t);if(!i)return;let o=i.indexOf(s);o<0||(i.splice(o,1),t.$behavior&&t.$behavior.teardown&&e.say("callTeardown",`${t.module.externalName}$${t.$behaviorName}`))}}BehaviorModelManager.register("BehaviorModelManager");class BehaviorViewManager extends ViewService{constructor(e){super(e||"BehaviorViewManager"),this.url=null,this.socket=null,this.status=!1,this.model=this.wellKnownModel("BehaviorModelManager"),this.subscribe(this.model.id,"callViewSetupAll","callViewSetupAll")}isConnected(){return this.socket&&this.socket.readyState===WebSocket.OPEN&&!0===this.status}destroy(){this.callback&&this.callback(!1),this.setURL(null),super.destroy()}setURL(e,t){if(this.callback=t,this.socket)try{this.socket.onmessage=null,this.socket.close()}finally{this.socket=null}e&&(this.url=e,this.socket=new WebSocket(e),this.socket.onmessage=e=>this.load(e.data),this.socket.onopen=e=>{console.log("connected"),this.status=!0,this.callback&&this.callback(!0)},this.socket.onclose=e=>{console.log("disconnected"),this.socket&&(this.socket.onmessage=null,this.socket=null),this.status=!1,this.callback&&this.callback(!1)})}callViewSetupAll(e){e.forEach((e=>{let t=this.model.lookup(...e),s=this.model.viewUses.get(t);s&&s.forEach((e=>{let s=GetPawn(e);s&&t.invoke(s,"setup")}))}))}load(e){let t;try{t=JSON.parse(e)}catch(e){return void console.error(e)}if(!t||!Array.isArray(t))return void console.log("not an array");let s=new Map,i=[],o=[],r=[];window._allResolvers||(window._allResolvers=new Map);let a=Date.now()+"_"+Math.random().toString(),n=new Map;window._allResolvers.set(a,n),t.forEach((e=>{if("add"===e.action){s.set(e.name,e.systemModule);let t=Math.random().toString(),l=new Promise(((s,o)=>{n.set(t,s);let l=document.createElement("script");r.push(l),l.type="module";let h=URL.createObjectURL(new Blob([e.content],{type:"application/javascript"}));l.innerHTML=`\nimport * as data from "${h}";\nlet map = window._allResolvers.get("${a}");\nif (map) {map.get("${t}")({data, key: ${a}, name: "${e.name}"});}\n`,document.body.appendChild(l),i.push(h)})).catch((e=>(console.log(e),null)));o.push(l)}})),Promise.all(o).then((async e=>{if(i.forEach((e=>URL.revokeObjectURL(e))),r.forEach((e=>e.remove())),0===(e=e.filter((e=>e))).length)return;let t=[...window._allResolvers.keys()],s=t.indexOf(a);if(window._allResolvers.delete(a),s!==t.length-1);else{let t=new CodeLibrary;e.forEach((e=>{let s=e.name.lastIndexOf("."),i=e.name.slice(0,s),o=e.name.startsWith("croquet");if(!e||checkModule(e.data))throw new Error("a behavior file does not export an array of modules");t.add(e.data.default,i,o)}));let s=[],i=Math.random();for(let[e,i]of t.modules){let{actorBehaviors:e,pawnBehaviors:t,name:o,location:r,systemModule:a}=i;s.push({name:o,systemModule:a,location:r,actorBehaviors:[...e],pawnBehaviors:[...t]})}let o=JSON.stringify(s),r=(new TextEncoder).encode(o),a=0;this.publish(this.model.id,"loadStart",i);let n=r.length>8e4;for(;a<r.length;){let e=r.slice(a,a+2880);this.publish(this.model.id,"loadOne",{key:i,buf:e}),a+=2880,n&&await new Promise((e=>{setTimeout(e,5)}))}this.publish(this.model.id,"loadDone",i)}}))}}class CodeLibrary{constructor(){this.modules=new Map,this.functions=new Map,this.classes=new Map}add(e,t,s){e.modules&&e.modules.forEach((e=>{let{name:i,actorBehaviors:o,pawnBehaviors:r}=e,a=new Map,n=new Map;o&&o.forEach((e=>{a.set(e.name,e.toString())})),r&&r.forEach((e=>{n.set(e.name,e.toString())}));let l=`${t}$${i}`,h=this.modules.get(l);h&&console.log(`a module ${i} is defined in ${t} and ${h.location}`),this.modules.set(l,{name:i,location:t,actorBehaviors:a,pawnBehaviors:n,systemModule:s})})),e.functions&&e.functions.forEach((e=>{let t=e.name,s=`return ${e.toString()};`;this.functions.set(t,s)})),e.classes&&e.classes.forEach((e=>{let t=e.name;this.classes.set(t,e)}))}addModules(e){if(e)for(let[t,s]of e)this.modules.set(t,s)}get(e){return this.modules.get(e)}delete(e){this.modules.delete(e)}}function checkModule(e){if(!e||!e.default||!e.default.modules)throw new Error("a behavior file does not export an array of modules");let t=e.default.modules;if(!Array.isArray(t))throw new Error("a behavior file does not export an array of modules");t.forEach((e=>{let t=!0;e.name||(t=!1),e.actorBehaviors&&!Array.isArray(e.actorBehaviors)&&(t=!1),e.pawnBehaviors&&!Array.isArray(e.pawnBehaviors)&&(t=!1);let s={...e};if(delete s.name,delete s.actorBehaviors,delete s.pawnBehaviors,Object.keys(s).length>0&&(t=!1),!t)throw new Error("a behavior file exports a malformed behavior module")}))}},5758:(e,t,s)=>{"use strict";s.d(t,{h:()=>DolbyChatManager});var i=s(4200);let o=!1,r=null,a=null;async function getAccessToken(){const e=await fetch("https://us-central1-dolby-croquet.cloudfunctions.net/generateToken");console.log("Dolby token generated");return(await e.json()).token}class DolbyChatManager extends i.ViewService{constructor(e){if(super(e||"DolbyChatManager"),a=this,!window.isSecureContext)return void console.warn("Audio Chat failed to get microphone permissions. If you are running it off http, please enable https");window.dolbyPromise||(window.dolbyPromise=new Promise((e=>{const t=document.createElement("script");t.setAttribute("src","https://cdn.jsdelivr.net/npm/@voxeet/voxeet-web-sdk"),t.onload=async()=>{console.log("initialize Dolby SDK");const t=await getAccessToken();VoxeetSDK.initializeToken(t,getAccessToken),this.addConferenceEventHandlers(),e()},document.body.appendChild(t)}))),this.subscribe("playerManager","enter","playerEnter"),this.subscribe("playerManager","leave","playerLeave"),this.sessionP=null,this.joinState="left",this.initChatUI(),this.initAudio();const t=this.localPlayer,s=t&&t.inWorld;s&&this.prepareSession(),console.log(`DolbyChatManager (local actor ${s?"already":"not yet"} here)`,this)}get localPlayer(){return this.model.service("PlayerManager").players.get(this.viewId)}initChatUI(){let e=document.getElementById("chatHolder");if(!e){const t=document.createElement("div");t.innerHTML="<div id='chatHolder' class='hidden hide-settings unconnected'>\n    <div id='chatUI'>\n        <div id='chatState' class='noselect'>\n            \x3c!-- <div id='worldName'></div> --\x3e\n            <div id='chatSymbol'></div>\n            <div id='peopleSymbol'></div>\n            <div id='chatCount' class='noselect'><span id='chatCountText'>-</span></div>\n        </div>\n        <div id='chatButtons'>\n            <div id='toggleConnection' tabindex='4'>\n                <div class='buttonImage joined' title='leave voice chat'></div>\n                <div class='buttonImage notJoined' title='join voice chat'></div>\n                <div id='connection-tooltip' class='bouncing'>\n                    <div id='connection-tooltip-arrow'></div>\n                    <div id='connection-tooltip-contents' class='noselect'>join voice chat</div>\n                </div>\n            </div>\n            <div id='toggleAudio' tabindex='1'>\n                <div class='buttonImage enabled' title='mute mic'></div>\n                <div class='buttonImage disabled' title='unmute mic'></div>\n                <div class='buttonImage unavailable' title='mic unavailable'></div>\n            </div>\n            <div id='toggleSettings' tabindex='4'>\n                <div class='buttonImage enabled' title='hide settings'></div>\n                <div class='buttonImage disabled' title='show settings'></div>\n            </div>\n        </div>\n    </div>\n    <div id='settings'>\n        <div id='local'>\n            <audio playsinline autoplay></audio>\n        </div>\n        <div id='loudness'>\n            <div class='bar'>\n                <div class='max'></div>\n                <div class='value'></div>\n            </div>\n        </div>\n        <div id='settingsButtons'>\n            <span class='settingsText noselect'>Audio Source</span>\n            <select id='audioInputs' title='Select Audio Source'></select>\n            <div id='toggleMicrophoneTest'></div>\n        </div>\n    </div>\n</div>\n",e=t.firstChild,document.body.appendChild(e),["toggleConnection","toggleAudio","toggleSettings","toggleMicrophoneTest"].forEach((e=>{const t=document.getElementById(e);t.addEventListener("pointerdown",(e=>e.stopPropagation())),t.addEventListener("click",(()=>this[e]()))}));const s=document.getElementById("audioInputs");s.addEventListener("pointerdown",(e=>e.stopPropagation())),s.addEventListener("input",(()=>this.setAudioInput())),navigator.mediaDevices.addEventListener("devicechange",(()=>this.updateAudioInputs())),o&&e.classList.add("mute-audio")}this.elements={chatHolder:e,connectionTooltip:document.getElementById("connection-tooltip"),toggleAudio:document.getElementById("toggleAudio"),audioInputs:document.getElementById("audioInputs"),localAudio:document.querySelector("#local > audio"),toggleMicrophoneTest:document.getElementById("toggleMicrophoneTest"),loudness:document.querySelector("#loudness"),loudnessBar:document.querySelector("#loudness .bar"),loudnessMax:document.querySelector("#loudness .max"),loudnessValue:document.querySelector("#loudness .value")},this.uiStyles={preConnect:{width:"220px",height:"50px",transform:"translate(-116px, 0px)"},connected:{width:"220px",height:"50px",transform:"translate(-116px, 0px)"},settings:{width:"220px",height:"188px",transform:"translate(-116px, 0px)"}},this.setUIStyle("preConnect"),e.classList.remove("hidden")}setUIStyle(e){const t=this.uiStyles[e],s=window.innerWidth<600;t.left=s?"60%":"",t.top=s?"60px":"",Object.assign(this.elements.chatHolder.style,t)}toggleConnection(){this.resumeAudioContextIfNeeded(),this.elements.connectionTooltip.style.display="none";const e=Date.now();e-(this.lastToggle||0)<2e3||"joining"===this.joinState||"leaving"===this.joinState||(this.lastToggle=e,"left"===this.joinState?this.joinConference():this.leaveConference())}toggleAudio(){o?this.unmuteChatAudio():this.muteChatAudio()}toggleSettings(){this.resumeAudioContextIfNeeded(),this.elements.chatHolder.classList.toggle("hide-settings"),this.setUIStyle(this.elements.chatHolder.classList.contains("hide-settings")?"connected":"settings")}toggleMicrophoneTest(){this.elements.chatHolder.classList.contains("testing-microphone")?this.stopTestingMicrophone():this.testMicrophone()}computeSessionHandles(){const hasher=e=>i.Data.hash(e).slice(0,8),e=this.session.persistentId,t=this.sessionId;return{persistent:hasher(e),ephemeral:hasher(t)}}addConferenceEventHandlers(){VoxeetSDK.conference.on("streamAdded",((e,t)=>{console.log(`stream added for ${e.info.name}`),a&&a.updateActiveInChat()})),VoxeetSDK.conference.on("streamUpdated",((e,t)=>{console.log(`stream updated for ${e.info.name}`),a&&a.updateActiveInChat()})),VoxeetSDK.conference.on("streamRemoved",((e,t)=>{console.log(`stream removed for ${e.info.name}`),a&&a.updateActiveInChat()})),VoxeetSDK.conference.on("left",(async()=>{console.log("participant has left Dolby conference.")}))}prepareSession(){return this.sessionP||(this.sessionP=new Promise((async e=>{console.log("open Dolby session");const t=Date.now();await window.dolbyPromise;const s=Date.now()-t;s<1e3&&await new Promise((e=>setTimeout(e,1e3-s)));const i=this.localPlayer._name;try{await VoxeetSDK.session.open({name:i}),console.log(`Dolby session for participant ${i}`),e(!0)}catch(t){console.error(t),e(!1)}}))),this.sessionP}async createConference(){console.log("create Dolby conference");const{persistent:e,ephemeral:t}=this.computeSessionHandles(),s={alias:`${e.slice(0,8)}:${t.slice(0,8)}`,params:{audioOnly:!0,spatialAudioStyle:"shared"}};let i=null;try{i=await VoxeetSDK.conference.create(s)}catch(e){console.error(e)}return i}async joinConference(){this.joinState="joining",this.elements.chatHolder.classList.add("joining");const e=await this.prepareSession()&&await this.createConference();if(!e)return this.elements.chatHolder.classList.remove("joining"),void(this.joinState="left");console.log("join Dolby conference");const t={spatialAudio:!0,constraints:{audio:!0,video:!1}};try{await VoxeetSDK.conference.join(e,t),await this.setAudioInput(),o&&await VoxeetSDK.conference.mute(VoxeetSDK.session.participant,!0),this.joinState="joined",this.elements.chatHolder.classList.remove("unconnected"),this.startTestingAudioLevel(),this.updateActiveInChat();const s={x:1,y:0,z:0},i={x:0,y:1,z:0},r={x:0,y:0,z:1},a=6,n={x:a,y:a,z:a};VoxeetSDK.conference.setSpatialEnvironment(n,r,i,s),this.setMyPosition()}catch(e){console.error(e),this.joinState="left"}this.elements.chatHolder.classList.remove("joining")}async leaveConference(){console.log("Leave Dolby conference");const e=this.joinState;if(this.joinState="leaving",this.sessionP=null,this.myLastPosition=null,this.elements){if(this.elements.chatHolder.classList.add("unconnected"),this.stopTestingMicrophone(),this.stopTestingAudioLevel(),this.elements.chatHolder.classList.contains("hide-settings")||this.toggleSettings(),"joined"===e)try{await VoxeetSDK.conference.leave()}catch(e){console.error(e)}if(VoxeetSDK.session.isOpen())try{await VoxeetSDK.session.close(),console.log("Dolby session closed")}catch(e){console.error(e)}this.joinState="left",this.updateActiveInChat()}}setMyPosition(){if("joined"!==this.joinState)return;const{_translation:e,_rotation:t}=this.localPlayer;let s=!0;if(this.myLastPosition){const{pos:o,rot:r}=this.myLastPosition;s=!(0,i.v3_equals)(o,e)||!(0,i.q_equals)(r,t)}if(this.myLastPosition={pos:e,rot:t},s){const[s,o,r]=e,a={x:s,y:o,z:r},n={x:0,y:180*(0,i.q_yaw)(t)/Math.PI,z:0};VoxeetSDK.conference.setSpatialPosition(VoxeetSDK.session.participant,a),VoxeetSDK.conference.setSpatialDirection(VoxeetSDK.session.participant,n)}this.future(100).setMyPosition()}playerEnter(e){e.playerId===this.viewId?(console.log("our player entered"),this.prepareSession()):this.updateActiveInChat()}playerLeave(e){this.updateActiveInChat(),e.playerId===this.viewId&&(console.log("our player left"),this.leaveConference())}updateActiveInChat(){const e=document.getElementById("chatCountText");if("joined"===this.joinState){const t=Array.from(VoxeetSDK.conference.participants.values()).filter((e=>e.audioTransmitting)).map((e=>e.info.name)).sort();if(this.lastInChat?.length===t.length&&!t.some(((e,t)=>this.lastInChat[t]!==e)))return;this.lastInChat=t,e.textContent=String(t.length),e.setAttribute("title",t.join("\n"))}else e.textContent="-",e.setAttribute("title","")}async initAudio(){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=1,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=4096,this.byteTimeDomainData=new Uint8Array(this.analyser.fftSize),this.gainNode.connect(this.analyser),this.testAudioNode=this.audioContext.createMediaStreamDestination(),this.elements.localAudio.srcObject=this.testAudioNode.stream,this.gainNode.connect(this.testAudioNode),this.elements.localAudio.muted=!0,await window.dolbyPromise,await this.updateAudioInputs(),this.resumeAudioContextIfNeeded()}resumeAudioContextIfNeeded(){"running"!==this.audioContext.state&&"closed"!==this.audioContext.state&&(console.log("attempting to resume audioContext"),this.audioContext.resume())}stopStream(e){e&&e.getTracks().forEach((e=>e.stop()))}stopMeasurableAudioStream(){this.measurableAudioStreamSource&&(this.measurableAudioStreamSource.disconnect(),delete this.measurableAudioStreamSource)}updateAudioInputs(){if(this._updateAudioInputsPromise)return this._updateAudioInputsPromise;const e=this.elements.audioInputs.selectedOptions[0],t=e&&e.label||this.chatAudioTrack&&this.chatAudioTrack.label||r;let s,i=!!t;const o=this.elements.audioInputs;o.innerHTML="";const a=document.createElement("optgroup");a.disabled=!0,a.selected=!1,a.label="Select Microphone",o.appendChild(a);const n=-1===navigator.userAgent.indexOf("Firefox")?Promise.resolve():navigator.mediaDevices.getUserMedia({audio:!0,video:!1});return this._updateAudioInputsPromise=n.then((()=>VoxeetSDK.mediaDevice.enumerateAudioInputDevices())).then((e=>{e.forEach((e=>{const{deviceId:r,label:a}=e;if("default"===r||"communications"===r)return;const n=i&&t===a;n&&(i=!1);const l=new Option(a,r,n,n);s||(s=l),o.appendChild(l)})),i&&s&&(console.warn(`previous device "${t}" is gone; switching to "${s.label}"`),o.value=s.value,this.mediaStarted&&this.setAudioInput())})).catch((e=>{console.error("error in updateAudioInputs",e)})).finally((()=>{delete this._updateAudioInputsPromise}))}setAudioInput(e){if(this._setAudioInputPromise)return this._setAudioInputPromise;const t=this.elements.audioInputs.selectedOptions[0];if(!t)return console.warn("no audio selections available"),Promise.resolve();const s=t.value,i=t.label,o=this.chatAudioTrack;if(!e&&o&&o.label===i&&"live"===o.readyState)return console.log("audio stream already matches selection"),Promise.resolve();r=i,console.log(`asking Voxeet to select device ID "${s}"`);return this._setAudioInputPromise=VoxeetSDK.mediaDevice.selectAudioInput(s).then((e=>{console.log("response from Voxeet:",e);return!navigator.userAgent.match(/\biPad\b/)||!this.chatAudioStream?navigator.mediaDevices.getUserMedia({audio:{deviceId:s}}):(console.log("not invoking getUserMedia"),this.chatAudioStream)})).then((t=>{const s=t.getAudioTracks()[0],i=this.chatAudioTrack;if(!e&&s===i)return void console.warn("same audio track found; no replacement needed");this.chatAudioStream=t,this.chatAudioTrack=s,s.onmute=()=>{console.log("audio track muted itself")},s.onunmute=()=>{console.log("audio track unmuted itself")},this.stopMeasurableAudioStream();const o=this.audioContext.createMediaStreamSource(t);o.connect(this.gainNode),this.measurableAudioStreamSource=o,this.elements.toggleAudio.classList.remove("error"),this.mediaStarted=!0})).catch((e=>{console.warn(`setAudioInput failed for id ${s}: ${e}`),this.elements.toggleAudio.classList.add("error")})).finally((()=>{delete this._setAudioInputPromise}))}async muteChatAudio(){console.log("muting local audio"),await this.ensureAudioMuteState(!0)}async unmuteChatAudio(){console.log("unmuting local audio"),this.stopTestingMicrophone(),await this.ensureAudioMuteState(!1)}async ensureAudioMuteState(e){o!==e&&(await VoxeetSDK.conference.mute(VoxeetSDK.session.participant,e),o=e,this.elements.chatHolder.classList.toggle("mute-audio",e))}startTestingAudioLevel(){this._testAudioInterval=100,this._testAudioLevelIntervalId=window.setInterval(this.testAudioLevel.bind(this),this._testAudioInterval)}testAudioLevel(){const e=this.getLocalAudioLevel();if(!this.elements.chatHolder.classList.contains("hide-settings")&&this.measurableAudioStreamSource){if(void 0===this._maxAudioLevelLongTerm||e>this._maxAudioLevelLongTerm){this._maxAudioLevelLongTerm=e,window.clearTimeout(this._maxAudioLevelLongTermTimeoutId),this._maxAudioLevelLongTermTimeoutId=window.setTimeout((()=>{delete this._maxAudioLevelLongTerm,delete this._maxAudioLevelLongTermTimeoutId,this.elements.loudnessMax.style.bottom="",this.elements.loudnessMax.style.left=""}),1500);const{flexDirection:t}=getComputedStyle(this.elements.loudnessBar);t.includes("row")?(this.elements.loudnessMax.style.left=94*e+"%",this.elements.loudnessMax.style.bottom="-3px"):(this.elements.loudnessMax.style.left="-1px",this.elements.loudnessMax.style.bottom=94*e+"%")}if(void 0===this._maxAudioLevelShortTerm||e>this._maxAudioLevelShortTerm){this._maxAudioLevelShortTerm=e,window.clearTimeout(this._maxAudioLevelShortTermTimeoutId),this._maxAudioLevelShortTermTimeoutId=window.setTimeout((()=>{delete this._maxAudioLevelShortTerm,delete this._maxAudioLevelShortTermTimeoutId,this.elements.loudnessValue.style.flex=0,this.elements.loudnessValue.style.backgroundColor="green"}),100),this.elements.loudnessValue.style.flex=e;const t=`hsl(${120*(1-e**2)}, 100%, 50%)`;this.elements.loudnessValue.style.backgroundColor=t}}}stopTestingAudioLevel(){this._testAudioLevelIntervalId&&(window.clearInterval(this._testAudioLevelIntervalId),delete this._testAudioLevelIntervalId)}getLocalAudioLevel(){const e=this.byteTimeDomainData;this.analyser.getByteTimeDomainData(e);const t=this.analyser.fftSize;let s,i=0;for(let o=0;o<t;o+=19)s=e[o],s=Math.abs(s-128),i=Math.max(i,s);return i/=128,i}testMicrophone(){this.elements.localAudio.paused&&this.elements.localAudio.play(),o||this.muteChatAudio(),this.elements.localAudio.muted=!1,this.elements.chatHolder.classList.add("testing-microphone")}stopTestingMicrophone(){this.elements.localAudio.muted=!0,this.elements.chatHolder.classList.remove("testing-microphone")}destroy(){console.log("DolbyChatMgr: destroy"),this.stopTestingAudioLevel();try{this.leaveConference().then((()=>this.elements?.chatHolder.remove()))}catch(e){}a=null,super.destroy()}}},3917:(e,t,s)=>{"use strict";let i;s.r(t),s.d(t,{addShellListener:()=>addShellListener,frameId:()=>o,frameName:()=>frameName,isPrimaryFrame:()=>i,removeShellListener:()=>removeShellListener,sendToShell:()=>sendToShell,worldName:()=>r});const o=new URL(window.location.href).searchParams.get("portal"),r=new URL(window.location.href).searchParams.get("world")||"default";function frameName(){return`frame["${r}",${o}${i?",primary":""}]`}const a="croquet:microverse:";function sendToShell(e,t){window.parent.postMessage({message:a+e,...t},"*")}const n=new Set;function addShellListener(e){n.add(e)}function removeShellListener(e){n.delete(e)}window.addEventListener("message",(e=>{if(e.source===window.parent){const{message:t}=e.data;if("string"==typeof t&&t.startsWith(a)){const s=t.slice(a.length);n.forEach((t=>t(s,e.data)))}}}));addShellListener(((e,t)=>{if("frame-type"===e){const{frameType:e}=t,s="primary"===e;i!==s&&(i=s,document.body.style.background="transparent",document.getElementById("hud").classList.toggle("primary-frame",i),i&&window.focus(),sendToShell("frame-ready",{frameType:e}))}}))},7112:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{startMicroverse:()=>startMicroverse});var _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(4200),_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(5679),_physics_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(6590),_dolbyChat_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(5758),_text_text_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(4355),_card_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(3654),_avatar_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(6567),_walkManager_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(8335),_frame_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(3917),_code_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(6946),_portal_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(1246),_worldSaver_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(4072),_settingsMenu_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(5072),_apps_multiblaster_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(3128),jszip__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(5733),jszip__WEBPACK_IMPORTED_MODULE_14___default=__webpack_require__.n(jszip__WEBPACK_IMPORTED_MODULE_14__),fflate__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__(3778),_wcAssetManager_js__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__(9087);const defaultAvatarNames=["newwhite","madhatter","marchhare","queenofhearts","cheshirecat","alice"],defaultSystemBehaviorDirectory="behaviors/croquet",defaultSystemBehaviorModules=["avatarEvents.js","billboard.js","elected.js","menu.js","pdfview.js","physics.js","rapier.js","scrollableArea.js","singleUser.js","stickyNote.js","halfBodyAvatar.js","propertySheet.js","dragAndDrop.js","gizmo.js"];let AA=!0;async function getAntialias(){let e=new URL(window.location).searchParams.get("AA");if(e)return"true"===e?(console.log("antialias is true, urlOption AA is set"),!0):(console.log("antialias is false, urlOption AA is unset"),!1);const t=navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome"),s=navigator.userAgent.includes("Firefox"),i=!!("ontouchstart"in window);let o=!0;i||t&&i?o=!1:s&&(o=!0);try{const e=await navigator.xr.isSessionSupported("immersive-vr");e&&(o=e)}catch(e){}return console.log(`antialias is ${o}, mobile: ${i}, browser: ${s?"Firefox":t?"Safari":"Other Browser"}`),o}function loadLoaders(){return window.JSZip=jszip__WEBPACK_IMPORTED_MODULE_14___default(),window.fflate=fflate__WEBPACK_IMPORTED_MODULE_16__,window.THREE=_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE,Promise.resolve(_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE)}function basenames(){let e,t=window.location.origin+window.location.pathname,s=/([^/]+)\.html$/.exec(t),i=new URL(window.location).searchParams.get("world");if(i||(i=s&&"index"!==s[1]?s[1]:"default"),s)e=t.slice(0,s.index);else{let s=t.lastIndexOf("/");e=t.slice(0,s+1)}return{baseurl:e,basename:i}}function loadInitialBehaviors(paths,directory){let library=_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library||new _code_js__WEBPACK_IMPORTED_MODULE_9__.Un;if(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library=library,!paths||!directory)return;let{baseurl,_pathname}=basenames();if(!directory)throw new Error("directory argument has to be specified. It is a name for a sub directory name under the ./behaviors directory.");let isSystem=directory===_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory,root=window.microverseDir?window.microverseDir:baseurl,promises=paths.map((path=>{if(isSystem){let modulePath=`${directory.split("/")[1]}/${path}`,code=`import('${root}behaviors/${modulePath}')`;return eval(code).then((e=>[modulePath,e]))}{let code=`import('${root}${directory}/${path}')`;return eval(code).then((e=>{let t=directory.slice(9);return"/"===t[0]&&(t=t.slice(1)),[`${""===t?"":t+"/"}${path}`,e]}))}}));return Promise.all(promises).then((e=>(e.forEach((e=>{let[t,s]=e,i=t.lastIndexOf("."),o=t.slice(0,i);(0,_code_js__WEBPACK_IMPORTED_MODULE_9__.OO)(s),library.add(s.default,o,isSystem)})),!0)))}console.log("%cTHREE.REVISION:","color: #f00",_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE.REVISION);class MyPlayerManager extends _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.PlayerManager{init(e){super.init(e),this.avatarCount=0,this.presentationMode=null,this.followers=new Set,this.subscribe("playerManager","create",this.playerCreated),this.subscribe("playerManager","details",this.playerDetails),this.subscribe("playerManager","destroy",this.playerDestroyed),this.subscribe("playerManager","enter",this.playerEnteredWorld),this.subscribe("playerManager","leave",this.playerLeftWorld)}get presenter(){return this.players.get(this.presentationMode)}createPlayer(e){let t=this.avatarCount%_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.AvatarNames.length;this.avatarCount++;let s=_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.AvatarNames[t],i={...e,noSave:!0,type:"3d",singleSided:!0};return i="string"==typeof s?{...i,name:s,dataScale:[.3,.3,.3],dataRotation:(0,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.q_euler)(0,Math.PI,0),dataTranslation:[0,-.4,0],dataLocation:`./assets/avatars/${s}.zip`,avatarType:"wonderland",type:"initial"}:{...i,avatarType:"custom",avatarIndex:t,...s},_avatar_js__WEBPACK_IMPORTED_MODULE_6__.b.create(i)}playerDetails({playerId:e,details:t}){const s=this.players.get(e);s&&s.setAndPublish(t)}destroyPlayer(e){e.inWorld&&e.setAndPublish({inWorld:!1}),super.destroyPlayer(e)}playerInWorldChanged(e){e.inWorld?this.publish("playerManager","enter",e):this.publish("playerManager","leave",e)}playersInWorld(){return[...this.players.values()].filter((e=>e.inWorld))}startPresentation(e,t=null){if(!this.presentationMode||this.presentationMode===e){this.presentationMode=e;for(const s of this.playersInWorld())t&&s.presenterToken!==t||(t&&s.playerId===e||delete s.presenterToken,this.followers.add(s.playerId));this.publish("playerManager","presentationStarted"),this.publish("playerManager","playerCountChanged")}}addFollower(e){this.followers.add(e)}stopPresentation(){this.presentationMode=null,this.publish("playerManager","presentationStopped"),this.publish("playerManager","playerCountChanged"),this.followers.clear()}leavePresentation(e){this.presentationMode!==e&&(this.followers.delete(e),this.publish("playerManager","playerCountChanged"))}continuePresenting(e,t){this.presentationMode?console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.frameName)(),"continuePresenting rejected due to presentation in progress"):(console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.frameName)(),"continuePresenting",e.id,t),e.presenterToken=t,this.startPresentation(e.playerId,t))}continueFollowing(e,t){this.presentationMode&&this.presenter.presenterToken===t?(console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.frameName)(),"continueFollowing",this.presenter.id,t),this.followers.add(e.playerId),e.presentationStarted(),this.publish("playerManager","playerCountChanged")):(e.presenterToken=t,console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.frameName)(),"continueFollowing: expected presenter not presenting",t))}playerEnteredWorld(e){this.publish("playerManager","playerCountChanged")}playerLeftWorld(e){e.playerId===this.presentationMode&&this.stopPresentation(),delete e.presenterToken,this.followers.delete(e.playerId),e._inChat&&e.setAndPublish({inChat:!1}),this.publish("playerManager","playerCountChanged")}playerCreated(e){this.publish("playerManager","playerCountChanged")}playerDestroyed(e){this.publish("playerManager","playerCountChanged")}}MyPlayerManager.register("MyPlayerManager");class MyModelRoot extends _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.ModelRoot{static modelServices(){return[MyPlayerManager,_card_js__WEBPACK_IMPORTED_MODULE_5__.q7,_code_js__WEBPACK_IMPORTED_MODULE_9__.IL,_text_text_js__WEBPACK_IMPORTED_MODULE_4__.NC,_physics_js__WEBPACK_IMPORTED_MODULE_2__.PhysicsManager]}init(e,t){super.init(e);let s=this.service("MicroverseAppManager");if(s.add(_apps_multiblaster_js__WEBPACK_IMPORTED_MODULE_13__.q),s.add(_text_text_js__WEBPACK_IMPORTED_MODULE_4__.T0),s.add(_portal_js__WEBPACK_IMPORTED_MODULE_10__.Q),this.ensurePersistenceProps(),this.subscribe(this.sessionId,"triggerPersist","triggerPersist"),this.subscribe(this.sessionId,"setPersistentDataFlag","setPersistentDataFlag"),this.subscribe(this.sessionId,"addBroadcaster","addBroadcaster"),this.subscribe(this.id,"loadStart","loadStart"),this.subscribe(this.id,"loadOne","loadOne"),this.subscribe(this.id,"loadDone","loadDone"),this.subscribe(this.id,"removeAll","removeAll"),t)return console.log("loading persistent data"),void this.loadPersistentData(t);this.loadBehaviorModules(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library.modules,"1"),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.ShowCaseSpec&&this.publish(this.sessionId,"disableCodeLoadFlag"),this.load(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.DefaultCards,"1")}ensurePersistenceProps(){if(!this.persistPeriod){let e=6e4;this.persistPeriod=e}void 0===this.lastPersistTime&&(this.lastPersistTime=0),void 0===this.persistRequested&&(this.persistRequested=!1)}loadPersistentData({_name:e,version:t,data:s}){try{delete this.loadingPersistentDataErrored,this.loadingPersistentData=!0;let e=new _worldSaver_js__WEBPACK_IMPORTED_MODULE_11__.H(_card_js__WEBPACK_IMPORTED_MODULE_5__.Z4).parse(JSON.stringify(s)),i=_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library,o=new Map;for(let[e,t]of i.modules)t.systemModule&&o.set(e,t);this.loadBehaviorModules(o,t),this.loadBehaviorModules(e.behaviorModules,t),e.cards&&this.load(e.cards,t)}catch(e){console.error("error in loading persistent data",e),this.loadingPersistentDataErrored=!0}finally{delete this.loadingPersistentData}}savePersistentData(){if(this.loadingPersistentData)return;if(this.loadingPersistentDataErrored)return;this.lastPersistTime=this.now();this.persistSession((()=>this.saveData()))}saveData(){let e=this.sessionName||"Unknown",t=new _worldSaver_js__WEBPACK_IMPORTED_MODULE_11__.H(_card_js__WEBPACK_IMPORTED_MODULE_5__.Z4),s=t.save(this),i=t.stringify(s);return{name:e,version:"1",data:JSON.parse(i)}}loadBehaviorModules(e,t){if("1"===t){return this.service("BehaviorModelManager").loadLibraries([...e.values()])}return null}load(e,t){if("1"===t)return _card_js__WEBPACK_IMPORTED_MODULE_5__.Z4.load(e,this,t)}setPersistentDataFlag(e){this.persistentDataDisabled=!e,console.log("persistentData: "+(this.persistentDataDisabled?"disabled":"enabled"))}triggerPersist(){let e=this.now(),t=e-this.lastPersistTime,s=this.persistPeriod;t<s?this.persistRequested||(this.persistRequested=!0,this.future(s-t).triggerPersist()):(this.lastPersistTime=e,this.persistRequested=!1,this.persistentDataDisabled||this.savePersistentData())}addBroadcaster(e){let t=this.service("PlayerManager").player(e);t&&(t.broadcaster=!0),this.broadcastMode||(this.broadcastMode=!0,this.publish(this.sessionId,"broadcastModeEnabled"))}loadStart(e){this.loadKey=e,this.loadBuffer=[]}loadOne(e){let{key:t,buf:s}=e;t===this.loadKey&&this.loadBuffer.push(s)}loadDone(e){let{key:t,asScene:s,pose:i}=e;if(t!==this.loadKey)return;let o=this.loadBuffer;if(this.loadBuffer=[],this.loadKey=null,!o)return void console.log("inconsistent message");let r=o.reduce(((e,t)=>e+t.length),0),a=new Uint8Array(r),n=0;for(let e=0;e<o.length;e++)a.set(o[e],n),n+=o[e].length;let l=new TextDecoder("utf-8").decode(a),h=JSON.parse(l);if("1"===h.version){let e=JSON.stringify(h.data);h.data=e,this.loadFromFile(h,s,i)}}removeAll(){}loadFromFile({_name:e,version:t,data:s},i,o){try{let e=new _worldSaver_js__WEBPACK_IMPORTED_MODULE_11__.H(_card_js__WEBPACK_IMPORTED_MODULE_5__.Z4).parse(s),r=this.loadBehaviorModules(e.behaviorModules,t);if(e.cards){let s=this.load({array:e.cards,nameMap:i?null:r},t);o&&s.forEach((e=>{e.parent||(e._translation=o.translation,e._rotation=o.rotation)}))}}catch(e){console.error("error in loading persistent data",e)}}}function setupBroadcastMode(e){const t="true"===new URLSearchParams(window.location.search).get("broadcastMode");return e.broadcastMode&&!t&&(e.__realm.vm.controller.sessionSpec.viewOnly=!0),t}MyModelRoot.register("MyModelRoot");class MyViewRoot extends _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.ViewRoot{static viewServices(){const e=[_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.InputManager,{service:_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.ThreeRenderManager,options:{useBVH:!0,antialias:AA}},_wcAssetManager_js__WEBPACK_IMPORTED_MODULE_15__.m,_text_text_js__WEBPACK_IMPORTED_MODULE_4__.WK,_text_text_js__WEBPACK_IMPORTED_MODULE_4__.Ax,_text_text_js__WEBPACK_IMPORTED_MODULE_4__.N2,_code_js__WEBPACK_IMPORTED_MODULE_9__.ui,_walkManager_js__WEBPACK_IMPORTED_MODULE_7__.R];return(window.settingsMenuConfiguration?.voice||_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.ShowCaseSpec&&_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.ShowCaseSpec.voiceChat)&&e.push(_dolbyChat_js__WEBPACK_IMPORTED_MODULE_3__.h),e}constructor(e){const t=setupBroadcastMode(e);super(e);const s=this.service("ThreeRenderManager"),i=s.renderer;window.scene=s.scene,this.service("FontViewManager").setModel(e.service("FontModelManager")),i.toneMapping=_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE.ReinhardToneMapping,i.toneMappingExposure=2.5,i.shadowMap.enabled=!0,i.localClippingEnabled=!0,this.setAnimationLoop(this.session);let o=[...this.model.service("ActorManager").actors].filter((e=>e[1].isCard)).map((e=>e[1]));this.synchronousLoadCards=o.filter((e=>e._cardData.loadSynchronously)),this.synchronousLoadCards&&(this.notLoadedSynchronousCards=new Set(this.synchronousLoadCards.map((e=>e.id)))),this.subscribe(this.sessionId,"synchronousCardLoaded","synchronousCardLoaded"),t&&this.publish(this.sessionId,"addBroadcaster",this.viewId),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.ShowCaseSpec&&!e.persistentDataDisabled&&this.publish(this.sessionId,"setPersistentDataFlag",!1),window.viewRoot=this}detach(){console.log("ViewRoot detached"),delete window.viewRoot,super.detach()}setAnimationLoop(e){this.service("ThreeRenderManager").renderer.setAnimationLoop(((t,s)=>{s&&e.step(t)}))}synchronousCardLoaded(e){if(!this.notLoadedSynchronousCards)return;if(0===this.notLoadedSynchronousCards.size)return;let t=e.id;this.notLoadedSynchronousCards.delete(t),0===this.notLoadedSynchronousCards.size&&this.publish(this.sessionId,"allSynnchronousCardsLoaded")}}function deleteParameter(e,t){const s=new URL(e,location.href);return s.searchParams.delete(t),s.toString()}let resolveConfiguration=null;function startWorld(e,t){let s={name:e.name||_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.autoSession(),password:e.password||_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.autoPassword(),model:MyModelRoot,view:MyViewRoot,tps:30,eventRateLimit:60,options:{world:t},...e};return Array.isArray(s.flags)||(s.flags=[]),s.flags.includes("microverse")||s.flags.push("microverse"),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.sessionURL=deleteParameter(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.sessionURL,"portal"),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.sessionURL=deleteParameter(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.sessionURL,"broadcastMode"),loadLoaders().then((()=>loadInitialBehaviors(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory))).then((()=>loadInitialBehaviors(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.UserBehaviorModules,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.UserBehaviorDirectory))).then((()=>(0,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.StartWorldcore)(s))).then((e=>{e.view.setAnimationLoop(e);let{baseurl:t}=basenames(),s=window.microverseDir?window.microverseDir:t;return fetch(`${s}meta/version.txt`)})).then((e=>`${e.status}`.startsWith("2")?e.text():"(version not found)")).then((e=>{console.log(`\nCroquet Microverse\n${e}\nhttps://croquet.io`.trim())}))}function isRunningLocalNetwork(){let e=window.location.hostname;/^\[.*\]$/.test(e)&&(e=e.slice(1,e.length-1));let t=[/^localhost$/,/^.*\.local$/,/^.*\.ngrok.io$/,/^(::ffff:)?10(?:\.\d{1,3}){3}$/,/^(::ffff:)?127(?:\.\d{1,3}){3}$/,/^(::f{4}:)?169\.254\.([1-9]|1?\d\d|2[0-4]\d|25[0-4])\.\d{1,3}$/,/^(::ffff:)?(172\.1[6-9]|172\.2\d|172\.3[01])(?:\.\d{1,3}){2}$/,/^(::ffff:)?192\.168(?:\.\d{1,3}){2}$/,/^f[cd][\da-f]{2}(::1$|:[\da-f]{1,4}){1,7}$/,/^fe[89ab][\da-f](::1$|:[\da-f]{1,4}){1,7}$/,/^::1$/];for(let s=0;s<t.length;s++)if(t[s].test(e))return!0;return!1}function startMicroverse(){let setButtons=e=>{["homeBtn","worldMenuBtn"].forEach((t=>{let s=document.querySelector("#"+t);s&&(s.style.display=e)}))},e=window.showcase;(0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.sendToShell)("hud",{joystick:!1,fullscreen:!1}),setButtons("none");const t=new Promise((e=>resolveConfiguration=e)).then((t=>(window.settingsMenuConfiguration={...t},!(!t.showSettings||t.userHasSet)&&new Promise((t=>(0,_settingsMenu_js__WEBPACK_IMPORTED_MODULE_12__.$)(!0,e&&!e.useAvatar,t))))));return(0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.sendToShell)("send-configuration"),t.then((t=>(t&&(0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.sendToShell)("update-configuration",{localConfig:window.settingsMenuConfiguration}),e||((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.sendToShell)("hud",{joystick:!0,fullscreen:!0}),setButtons("flex")),getAntialias()))).then((e=>{AA=e,launchMicroverse()}))}async function launchMicroverse(){if(window.microverseInitFunction)return window.microverseInitFunction(startWorld,{Constants:_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants,App:_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App});let{baseurl,basename}=basenames(),apiKeysModule;if(basename.endsWith(".vrse")){const e=await fetch(basename);if(!e.ok)throw Error(`world not found: ${basename}`);const t=await e.text(),s=(new _worldSaver_js__WEBPACK_IMPORTED_MODULE_11__.H).parse(t);_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.AvatarNames=defaultAvatarNames,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory=defaultSystemBehaviorDirectory,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules=defaultSystemBehaviorModules,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.DefaultCards=s.data.cards,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library=new _code_js__WEBPACK_IMPORTED_MODULE_9__.Un,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library.addModules(s.data.behaviorModules)}else{const worldModule=await eval(`import("${baseurl}worlds/${basename}.js")`);if(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.ModelRoot.evaluate((()=>worldModule.init(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants))),!_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules)if(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory=defaultSystemBehaviorDirectory,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.ExcludedSystemBehaviorModules||_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.IncludedSystemBehaviorModules){let e=[...defaultSystemBehaviorModules];_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.ExcludedSystemBehaviorModules&&(e=e.filter((e=>!_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.ExcludedSystemBehaviorModules.includes(e)))),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.IncludedSystemBehaviorModules&&e.push(..._croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.IncludedSystemBehaviorModules),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules=e}else _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules=defaultSystemBehaviorModules}let local=isRunningLocalNetwork(),apiKeysFile=local?"apiKey-dev.js":"apiKey.js";try{apiKeysModule=await eval(`import('${baseurl}${apiKeysFile}')`);const{apiKey,appId}=apiKeysModule.default;if("string"!=typeof apiKey)throw Error(`${apiKeysFile}: apiKey must be a string`);if("string"!=typeof appId)throw Error(`${apiKeysFile}: appId must be a string`);if(!apiKey.match(/^[_a-z0-9]+$/i))throw Error(`${apiKeysFile}: invalid apiKey: "${apiKey}"`);if(!appId.match(/^[-_.a-z0-9]+$/i))throw Error(`${apiKeysFile}: invalid appId: "${appId}"`)}catch(e){if("TypeError"!==e.name||!local)throw console.error(e),Error("Please make sure that you have created a valid apiKey-dev.js for local development, and apiKey.js for deployment (see croquet.io/keys)");console.warn(`${apiKeysFile} not found, using default key for local development. Please create a valid apiKey-dev.js for local development, and apiKey.js for deployment (see croquet.io/keys)`),apiKeysModule={default:{apiKey:"1kBmNnh69v93i5tOpj7bqqaJxjD3HJEucxd7egi7H",appId:"io.croquet.microverse.localdevdefault"}}}startWorld(apiKeysModule.default,basename)}const shellListener=(e,t)=>{if("local-configuration"===e){const{localConfig:e}=t;resolveConfiguration&&(resolveConfiguration(e),resolveConfiguration=null)}};(0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.addShellListener)(shellListener)},6590:(e,t,s)=>{"use strict";s.r(t),s.d(t,{Physics:()=>o,PhysicsManager:()=>PhysicsManager,PhysicsVersion:()=>PhysicsVersion});var i=s(4200);let o;function PhysicsVersion(){return"Rapier: "+o.version()}class PhysicsWorld extends i.Model{init(e){e.useCollisionEventQueue&&(this.queue=new o.EventQueue(!0));const t=e.gravity||[0,-9.8,0],s=e.timeStep||5,i=new o.Vector3(...t);this.world=new o.World(i),this.timeStep=s,this.world.timestep=this.timeStep/1e3,this.rigidBodies=new Map,e.startPaused||this.future(0).tick()}pause(){this.isPaused=!0}resume(){this.isPaused=!1}tick(){this.isPaused||(this.world.step(this.queue),this.world.forEachActiveRigidBody((e=>{let t=e.handle;const s=this.rigidBodies.get(t),i=s.rigidBody.translation(),o=s.rigidBody.rotation(),r=[i.x,i.y,i.z],a=[o.x,o.y,o.z,o.w];s.moveTo(r),s.say("translating",r),s.rotateTo(a)})),this.queue&&this.collisionEventHandler&&this.queue.drainCollisionEvents(((e,t,s)=>{let i=this.rigidBodies.get(e),o=this.rigidBodies.get(t);this.collisionEventHandler.collision(i,o,s)}))),this.future(this.timeStep).tick()}registerCollisionEventHandler(e){this.collisionEventHandler=e}destroy(){this.world.free(),this.world=null}}PhysicsWorld.register("PhysicsWorld");class PhysicsManager extends i.ModelService{static async asyncStart(){o=window.RAPIERModule?window.RAPIERModule:await s.e(87).then(s.bind(s,5087)),console.log("Starting physics "+PhysicsVersion())}static types(){return o?{"Physics.World":{cls:o.World,write:e=>e.takeSnapshot(),read:e=>o.World.restoreSnapshot(e)},"Physics.EventQueue":{cls:o.EventQueue,write:e=>{},read:e=>new o.EventQueue(!0)}}:{}}init(){super.init("PhysicsManager"),this.worlds=new Map}createWorld(e,t){let s=PhysicsWorld.create(e);return this.worlds.set(t,s),s}createGlobalWorld(e){if(!this.globalWorld)return this.globalWorld=this.createWorld(e,this.id),this.globalWorld}deleteWorld(e){let t=this.worlds.get(e);t&&(t.destroy(),this.worlds.delete(e))}deleteGlobalWorld(){this.deleteWorld(this.id),delete this.globalWorld}destroy(){for(let[e,t]of this.worlds)t.destroy();delete this.globalWorld,this.worlds=new Map,super.destroy()}}PhysicsManager.register("PhysicsManager")},1246:(e,t,s)=>{"use strict";s.d(t,{Q:()=>PortalActor});var i=s(5679),o=s(3654),r=s(3917);class PortalActor extends o.Z4{init(e){super.init(e),this._isOpen=!0,this.addLayer("portal"),this._portalTime=this.now(),this.listen("isOpenSet",this.setIsOpen)}get isPortal(){return!0}get isOpen(){return this._isOpen}get portalTime(){return this._portalTime}get portalURL(){return this._cardData.portalURL}get sparkle(){return this._cardData.sparkle}get pawn(){return PortalPawn}setIsOpen(){this.isOpen?this.addLayer("portal"):this.removeLayer("portal")}}PortalActor.register("PortalActor");class PortalPawn extends o.Df{constructor(e){super(e),this.createPortalMaterials(),this.portalId=void 0,this.targetMatrix=new i.THREE.Matrix4,this.targetMatrixBefore=new i.THREE.Matrix4,this.actor.isOpen&&this.openPortal(),this.setGhostWorld({v:this.actor._ghostWorld}),this.listen("ghostWorldSet",this.setGhostWorld),this.listen("isOpenSet",this.setIsOpen),this.addEventListener("pointerDown",this.onPointerDown),this.addEventListener("keyDown",(e=>{switch(e.key){case" ":this.enterPortal();break;case"G":case"g":this.say("_set",{ghostWorld:null===this.actor._ghostWorld?20:null})}})),this.shellListener=(e,t)=>this.receiveFromShell(e,t),(0,r.addShellListener)(this.shellListener),this.subscribe("avatar",{event:"gatherPortalSpecs",handling:"immediate"},this.updatePortal)}destroy(){this.closePortal(),(0,r.removeShellListener)(this.shellListener),super.destroy()}get globalPlane(){return this._globalPlane||(this._globalPlane=new i.THREE.Plane,this._globalPlane.normal.set(0,0,1),this._globalPlane.applyMatrix4(this.shape.matrixWorld)),this._globalPlane}objectCreated(e,t){super.objectCreated(e,t),this.applyPortalMaterial(e),this.actor.sparkle&&this.addParticles()}createPortalMaterials(){this.portalMaterial=new i.THREE.ShaderMaterial({uniforms:{time:{value:0}},vertexShader:"\n                #include <clipping_planes_pars_vertex>\n                varying vec3 vUv;\n                void main() {\n                    #include <begin_vertex>             // transformed = position\n                    #include <project_vertex>           // mvPosition and gl_Position\n                    #include <clipping_planes_vertex>   // vClipPosition\n                    vUv = transformed;\n                }\n            ",fragmentShader:"\n                uniform float time;\n                varying vec3 vUv;\n                #include <clipping_planes_pars_fragment>\n                void main() {\n                    #include <clipping_planes_fragment>\n                    float r = length(vUv.xy);\n                    float angle = atan(vUv.y, vUv.x);\n                    float v = sin(time * 30.0 - r * 1.0 + 5.0 * angle) + r - time * 2.0 + 2.0;\n                    float alpha = clamp(v, 0.0, 1.0);\n                    // gl_FragColor = vec4(0, 0, 0, alpha); // if we only care about alpha\n                    gl_FragColor = vec4(alpha*0.3, alpha*0.3, alpha*0.3, alpha); // add some grey\n                }\n            ",clipping:!0})}applyPortalMaterial(e){if(e||(e=this.shape),e.material||(e=e.children[0]),!e)return;const{isOpen:t}=this.actor;Array.isArray(e.material)?(e.material[0]!==this.portalMaterial&&(this.originalMaterial=e.material[0]),e.material[0]=t?this.portalMaterial:this.originalMaterial):(e.material!==this.portalMaterial&&(this.originalMaterial=e.material),e.material=t?this.portalMaterial:this.originalMaterial)}addParticles(){if(this.particleSystem)return;const e=.5*this.actor._cardData.width+.002,t=.5*this.actor._cardData.height+.002,s={pointTexture:{value:(new i.THREE.TextureLoader).load("./assets/images/spark.png")}},o=new i.THREE.ShaderMaterial({uniforms:s,vertexShader:"\n                attribute float size;\n                #include <clipping_planes_pars_vertex>\n                void main() {\n                    #include <begin_vertex>\n                    #include <project_vertex>\n                    mvPosition += vec4( 0.0, 0.0, 0.1, 0.0 ); // offset towards camera to avoid z clipping\n                    #include <clipping_planes_vertex>\n                    gl_PointSize = size * ( 20.0 / -mvPosition.z );\n                }\n            ",fragmentShader:"\n                uniform sampler2D pointTexture;\n                #include <clipping_planes_pars_fragment>\n                void main() {\n                    #include <clipping_planes_fragment>\n                    gl_FragColor = texture2D( pointTexture, gl_PointCoord );\n                }\n            ",clipping:!0,blending:i.THREE.AdditiveBlending,depthWrite:!1,transparent:!0,vertexColors:!0}),r=[],a=[];for(let s=0;s<1e3;s++){const s=2*Math.random()-1,i=Math.random()<.5?1:-1,o=Math.random()<.5;r.push((o?s:i)*e),r.push((o?i:s)*t),r.push(0),a.push(20)}const n=new i.THREE.BufferGeometry;n.setAttribute("position",new i.THREE.Float32BufferAttribute(r,3)),n.setAttribute("size",new i.THREE.Float32BufferAttribute(a,1).setUsage(i.THREE.DynamicDrawUsage)),this.particleSystem=new i.THREE.Points(n,o),this.shape.add(this.particleSystem)}removeParticles(){this.particleSystem&&(this.shape.remove(this.particleSystem),this.particleSystem=void 0)}get hitNormal(){return[0,0,-1]}update(e){super.update(e),this.updatePortalMaterial(),this.updateParticles()}updatePortal({callback:e,force:t}){this.updatePortalCamera(e,t)}updatePortalCamera(e,t){if(!this.portalId)return;const{targetMatrix:s,targetMatrixBefore:o,portalId:r}=this,{camera:a}=this.service("ThreeRenderManager");if(a.updateMatrixWorld(!0),this.renderObject.updateMatrixWorld(!0),s.copy(this.renderObject.matrixWorld),s.invert(),s.multiply(a.matrixWorld),t||!o.equals(s)){const t=new i.THREE.Frustum,n=(new i.THREE.Matrix4).multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);t.setFromProjectionMatrix(n);e({portalId:r,cameraMatrix:t.intersectsObject(this.renderObject.children[0])?s.elements:null}),o.copy(s)}}updatePortalMaterial(){let{portalTime:e}=this.actor;const t=(this.extrapolatedNow()-e)/1e3;this.portalMaterial.uniforms.time.value=t}updateParticles(){if(this.actor.sparkle&&!this.particleSystem?this.addParticles():!this.actor.sparkle&&this.particleSystem&&this.removeParticles(),!this.particleSystem)return;const{geometry:e}=this.particleSystem,t=e.attributes.size.array,s=Date.now()/100;for(let e=0;e<t.length;e++)t[e]=10*(1+Math.sin(.1*e+s));e.attributes.size.needsUpdate=!0}updateShape(e){this.removeParticles(),super.updateShape(e),this.updateParticles()}cardDataUpdated(e){super.cardDataUpdated(e),this.didPropertyChange(e,"sparkle")&&this.updateParticles()}refreshDrawTransform(){super.refreshDrawTransform(),this._globalPlane=null}onPointerDown(){this.say("_set",{isOpen:!this.actor.isOpen,portalTime:this.now()})}openPortal(){const e=this.resolvePortalURL();(0,r.sendToShell)("portal-open",{portalURL:e,portalId:this.portalId})}closePortal(){(0,r.sendToShell)("portal-close",{portalId:this.portalId}),this.portalId=null,this.targetMatrixBefore.identity()}resolvePortalURL(){let e=this.actor.portalURL;const t=new URL(e,location.href),s=t.searchParams,i=new URLSearchParams(t.hash.slice(1));let o=s.get("q"),r=i.get("pw");const a=new URL(location.href);if(!(o&&r||(o||(o=a.searchParams.get("q"),r="",s.set("q",o)),r))){r=new URLSearchParams(a.hash.slice(1)).get("pw"),i.set("pw",r),t.hash=i.toString()}return["showSettings","voiceChat"].forEach((e=>{a.searchParams.has(e)&&s.set(e,"true")})),e=t.toString(),t.origin===location.origin&&(e=e.slice(location.origin.length),t.pathname===location.pathname&&(e=e.slice(location.pathname.length))),this.actor.portalURL!==e&&this.say("setCardData",{portalURL:e}),t.toString()}setIsOpen({v:e}){this.applyPortalMaterial(),e?this.openPortal():this.closePortal()}setGhostWorld({v:e}){let t=document.getElementById("ThreeCanvas"),s=document.getElementById("ghostSlider");s&&("number"==typeof e&&r.isPrimaryFrame?(s.style.display="block",s.oninput=()=>this.say("_set",{ghostWorld:+s.value}),t.style.filter=`opacity(${100-e}%) saturate(${100-e}%) contrast(${80+.2*e}%) blur(4px)`,s.value=e):(s.style.display="none",t.style.filter=""))}receiveFromShell(e,{portalId:t}){switch(e){case"portal-opened":this.portalId=t;break;case"frame-type":this.setGhostWorld({v:this.actor._ghostWorld})}}}},5072:(e,t,s)=>{"use strict";s.d(t,{$:()=>startSettingsMenu,Y:()=>startShareMenu});var i=s(3986),o=s(4200);let r,a,n,l,h=null,d={};function startSettingsMenu(e,t,s){l=s,r=!1,a=!1,n=t,(0,i.ts)(),function createSettingsMenu(e){let t='\n<div id="joinDialog" class="dialogPanel no-select">\n    <button id="close-button" type="button" class="btn btn-danger btn-x topright">x</button>\n    <div id="join-container" class="content-container">\n        \x3c!--\n        <div id="dialogTitle">\n            <div id="titleHolder">\n                <img id="titleLogo" src="assets/images/microverse-logo.png" />\n            </div>\n        </div>\n        --\x3e\n        <div id="joinPrompt">\n            <div id="joinPromptTitle">Settings</div>\n            <div id="joinPromptBlurb" class="promptBlurb">Specify a nickname, and choose an avatar either\n                by selecting from those on display or pasting a valid Ready Player Me URL.\n            </div>\n        </div>\n        <div id="settings-title" class="panel-title">Settings</div>\n        <div class="settings-container">\n            <div id="nameInput" class="stringInputHolder">\n                <div id="namePrompt" class="namePrompt">Nickname<span>*</span></div>\n                <div id="nameField" class="nameField allow-select" contenteditable="true"></div>\n                <div id="nameExplanation">Enter 1-12 characters (ASCII only).</div>\n                <div id="nameFilterWarning"><br /></div>\n            </div>\n            <div id="selectAvatar" class="namePrompt">Select Avatar</div>\n            <div id="dialogAvatarSelections">\n                <div id="avatarList"></div>\n            </div>\n            <div id="avatarURL" class="stringInputHolder">\n                <div id="avatarURLPrompt" class="namePrompt">Or, Enter an Avatar URL</div>\n                <div id="avatarURLField" class="nameField avatarNameField allow-select" contenteditable="true"></div>\n            </div>\n            <div id="handednessRow">\n                <div id="handednessLabel">Hand:</div>\n                <div class="btn-group" id="handedness">\n                    <label class="btn btn-radio-button">\n                         <input type="radio" name="options" id="left"><span class="handedness-label">Left</span>\n                    </label>\n                    <label class="btn btn-radio-button">\n                        <input type="radio" name="options" id="right" checked><span class="handedness-label">Right</span>\n                    </label>\n                </div>\n            </div>\n            <div id="dialogEnterButton" class="dialogButtonsHolder disabled">\n                <div id="enterButton">Enter</div>\n            </div>\n            <div id="dialogAcceptCancelButtons" class="dialogButtonsHolder twoItems">\n                <button id="cancel-button" type="button" class="btn btn-danger cancel-button">Cancel</button>\n                <button type="button" id="acceptButton" class="btn btn-success">Apply</button>\n            </div>\n        </div>\n    </div>\n</div>\n'.trim(),s=document.createElement("div");s.innerHTML=t,h=s.querySelector("#joinDialog");let o=h.querySelector("#close-button"),r=h.querySelector("#enterButton"),a=h.querySelector("#acceptButton"),l=h.querySelector("#cancel-button"),u=h.querySelector("#handednessRow"),p=h.querySelector("#handedness"),f=h.querySelector("#dialogTitle"),m=h.querySelector("#joinPrompt"),g=h.querySelector("#joinPromptBlurb"),y=h.querySelector("#settings-title"),v=h.querySelector("#dialogEnterButton"),w=h.querySelector("#dialogAcceptCancelButtons"),_=h.querySelector("#selectAvatar"),x=h.querySelector("#dialogAvatarSelections"),b=h.querySelector("#avatarURL"),M=h.querySelector("#nameField");M.addEventListener("keydown",(e=>function nameFieldKeydown(e){e.stopPropagation(),(13===e.keyCode||9===e.keyCode)&&e.preventDefault()}(e))),M.addEventListener("input",(e=>nameFieldChanged(e))),M.addEventListener("paste",(e=>e.stopPropagation()));let E=h.querySelector("#avatarURLField");E.addEventListener("input",(e=>avatarURLFieldChanged(e))),E.addEventListener("paste",(e=>e.stopPropagation())),E.addEventListener("keydown",(e=>e.stopPropagation())),r.onclick=()=>function dialogCloseEnter(){console.log("enter",d),updateLocalConfig(),closeDialog(!0)}(),a.onclick=()=>function accept(){console.log("accept",d),updateLocalConfig(),closeDialog(!0),(0,i.ts)()}(),o.onclick=()=>(0,i.ts)(),l.onclick=()=>(0,i.ts)(),p.addEventListener("input",(()=>function handednessChanged(){let e=h.querySelector("#left");d.handedness=e.checked?"Left":"Right"}())),f&&f.classList.toggle("hidden",!e);m&&m.classList.toggle("notUseEnter",!e);y&&y.classList.toggle("hidden",e);o&&o.classList.toggle("hidden",e);v&&v.classList.toggle("notUseEnter",!e);w&&w.classList.toggle("notUseEnter",!e);_&&_.classList.toggle("hidden",!!n);x&&x.classList.toggle("hidden",!!n);b&&(b.style.display=n?"none":"flex");u&&(u.style.display=n?"none":"flex");g&&n&&(g.textContent="Specify a nickname and press Enter.");return function populateAvatarSelection(){if(!h)return;let e=h.querySelector("#avatarList");c.forEach((t=>{let s=document.createElement("div");s.classList.add("avatarThumb"),s.onclick=()=>avatarSelected(t),t.png.indexOf("/")>=0?s.style.backgroundImage=`url(${t.png})`:s.style.backgroundImage=`url(./assets/avatar-images/${t.png}.png)`,s.setAttribute("avatarURL",t.url),e.appendChild(s)}))}(),document.body.appendChild(h),(0,i.gA)(h),Promise.resolve(h)}(e).then(fillFromPrevious),(0,i.aP)()}function startShareMenu(e,t){n=t,(0,i.ts)(),function createShareMenu(e){let t='\n    <div id="shareDialog" class="dialogPanel no-select">\n        <button id="close-button" type="button" class="btn btn-danger btn-x topright">x</button>\n        <div id="share-container" class="content-container">\n            <div id="share-title" class="panel-title">Invite Users<br></div>\n            <div class="promptBlurb">Scan QR code or click to open a new browser tab in the same session.</div>\n            <div id="share-qr"></div>\n\n            <div class="share-settings-label">Copy Share Link</div>\n            <div class="share-menu-row">\n                <div id="copy-link" class="copy-link allow-select">generated link</div>\n                <button id="copy-button" type="button" class="btn btn-outline-success">Copy</button>\n            </div>\n            <div id="save-vrse-row" class="share-menu-row">\n                <div class="share-settings-label">Save world as VRSE file</div>\n                <button id="save-button" type="button" class="btn btn-outline-success">Download</button>\n            </div>\n        </div>\n    </div>'.trim(),s=document.createElement("div");s.innerHTML=t;let r=s.querySelector("#shareDialog"),a=s.querySelector("#share-qr"),l=r.querySelector("#close-button"),h=document.createElement("div"),d=s.querySelector("#copy-link"),c=s.querySelector("#copy-button"),u=s.querySelector("#save-button"),p=s.querySelector("#save-vrse-row");(0,i.gA)(r);let f=o.App.makeQRCanvas(),m=o.App.sessionURL;a.appendChild(h),h.appendChild(f),h.classList.add("menu-qr"),f.classList.add("share-qr-canvas"),f.onclick=()=>{let e=document.createElement("div");e.innerHTML=`<a id="link" target="_blank" rel="noopener noreferrer" href="${m}"></a>`,document.getElementById("hud").appendChild(e),e.querySelector("#link").click(),e.remove()},l.onclick=()=>(0,i.ts)(),d.textContent=m,u.onclick=t=>function savePressed(e){let t=e.actor.wellKnownModel("ModelRoot"),s=document.createElement("a"),i="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t.saveData(),null,4));s.setAttribute("href",i),s.setAttribute("download","scene.vrse"),s.click()}(e),c.onclick=e=>function copyPressed(e){let t=navigator.userAgent.match(/ipad|iphone/i),s=o.App.sessionURL,clipboardAPI=()=>navigator.clipboard?navigator.clipboard.writeText(s).then((()=>!0),(()=>!1)):Promise.resolve(!1);clipboardAPI().then((e=>{if(!e){if(!t)return this.copy.value=s,this.copy.select(),this.copy.setSelectionRange(0,99999),void document.execCommand("copy");let e=document.createRange();e.selectNodeContents(this.copy),this.copy.textContent=s;let i=window.getSelection();i.removeAllRanges(),i.addRange(e),this.copy.setSelectionRange(0,1e5),document.execCommand("copy")}}))}(),n&&(p.style.display="none");document.body.appendChild(r)}(e),(0,i.aP)()}function fillFromPrevious(){const e=window.settingsMenuConfiguration||{},t=e.nickname,s=n?null:e.avatarURL,i=e.handedness;if(t){h.querySelector("#nameField").textContent=t,nameFieldChanged()}if(s){let e=function findPredefined(e){return c.find((t=>t.url===e))}(s);if(e)avatarSelected(e);else{h.querySelector("#avatarURLField").textContent=s,avatarURLFieldChanged()}}if(i&&"Left"===i){h.querySelector("#handedness").querySelector("#left").checked=!0}updateButtonState()}function nameFieldChanged(e){e&&(e.stopPropagation(),e.preventDefault());let t=document.getElementById("nameField").textContent.trim().replace(/\r?\n|\r/g,"");const s=t.length;t=t.replace(/[^\x20-\x7F]/g,"").trim().slice(0,12).trim();document.getElementById("nameFilterWarning").innerHTML=t.length===s?"<br/>":`Nickname filtered to "${t}"`,t.length>=1&&t.length<=12?(d.nickname=t,r=!0):r=!1,updateButtonState()}function avatarURLFieldChanged(e){e&&(e.preventDefault(),e.stopPropagation());avatarSelected({url:h.querySelector("#avatarURLField").textContent.trim(),type:"ReadyPlayerMe"})}function updateButtonState(){const e=r&&(n||a);h.querySelector("#dialogEnterButton").classList.toggle("disabled",!e);h.querySelector("#dialogAcceptCancelButtons").classList.toggle("disabled",!e)}function closeDialog(e){h.remove(),h=null,l&&(l(e),l=null)}function updateLocalConfig(){const e=window.settingsMenuConfiguration||{};window.settingsMenuConfiguration={...e,...d},n&&(window.settingsMenuConfiguration.avatarURL=null,window.settingsMenuConfiguration.type="wonderland")}let c=[{png:"https://croquet.io/microverse/assets/avatar-images/f1.png",url:"https://d1a370nemizbjq.cloudfront.net/0725566e-bdc0-40fd-a22f-cc4c333bcb90.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/f2.png",url:"https://d1a370nemizbjq.cloudfront.net/50ef7f5f-b401-4b47-a8dc-1c4eda1ba8d2.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/f3.png",url:"https://d1a370nemizbjq.cloudfront.net/b5c04bb2-a1df-4ca4-be2e-fb54799e9030.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/f4.png",url:"https://d1a370nemizbjq.cloudfront.net/b480f1d0-3a0f-4766-9860-c213e6c50f3d.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/m1.png",url:"https://d1a370nemizbjq.cloudfront.net/05d16812-01de-48cc-8e06-c6514ba14a77.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/m2.png",url:"https://d1a370nemizbjq.cloudfront.net/2955d824-31a4-47e1-ba58-6c387c63b660.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/m3.png",url:"https://d1a370nemizbjq.cloudfront.net/579d4ec8-ade3-49ea-8b52-2ea5fe097f7d.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/m4.png",url:"https://d1a370nemizbjq.cloudfront.net/535100f3-c58c-4fd8-9fb9-4ee090e844bf.glb",type:"ReadyPlayerMe"}];function avatarSelected(e){let t=e.url,s=/https?:[a-zA-Z0-9/.-]+\.glb/.test(t);if(s&&!n&&(d.avatarURL=e.url,d.type=e.type),!h)return;a=!1;let i=h.querySelector("#avatarList");for(let t=0;t<i.childNodes.length;t++){let s=i.childNodes[t];s.getAttribute("avatarURL")===e.url?(s.setAttribute("selected",!0),a=!0):s.removeAttribute("selected")}t&&t===e.url?a=s:avatarURLField.textContent="",updateButtonState()}},4355:(e,t,s)=>{"use strict";s.d(t,{NC:()=>FontModelManager,Ax:()=>FontViewManager,WK:()=>KeyFocusManager,N2:()=>SyncedStateManager,T0:()=>TextFieldActor});var i=s(4200),o=s(5679),r=s(7194),a=s(3654),n=s(9902),l=s.n(n);const h=JSON.parse('{"pages":["Roboto-msdf.png"],"chars":[{"id":41,"width":22,"height":53,"xoffset":0,"yoffset":-33.6943359375,"xadvance":14.6015625,"chnl":15,"x":0,"y":0,"page":0},{"id":40,"width":24,"height":53,"xoffset":0,"yoffset":-33.6943359375,"xadvance":14.35546875,"chnl":15,"x":0,"y":55,"page":0},{"id":93,"width":18,"height":51,"xoffset":0,"yoffset":-34.125,"xadvance":11.1357421875,"chnl":15,"x":0,"y":110,"page":0},{"id":91,"width":21,"height":51,"xoffset":0,"yoffset":-34.125,"xadvance":11.1357421875,"chnl":15,"x":0,"y":163,"page":0},{"id":125,"width":23,"height":50,"xoffset":0,"yoffset":-32.7509765625,"xadvance":14.2119140625,"chnl":15,"x":0,"y":216,"page":0},{"id":123,"width":24,"height":50,"xoffset":0,"yoffset":-32.7509765625,"xadvance":14.2119140625,"chnl":15,"x":0,"y":268,"page":0},{"id":106,"width":18,"height":49,"xoffset":0,"yoffset":-30.26953125,"xadvance":10.0283203125,"chnl":15,"x":0,"y":320,"page":0},{"id":36,"width":31,"height":49,"xoffset":0,"yoffset":-34.69921875,"xadvance":23.583984375,"chnl":15,"x":0,"y":371,"page":0},{"id":64,"width":46,"height":49,"xoffset":0,"yoffset":-29.3466796875,"xadvance":37.7138671875,"chnl":15,"x":0,"y":422,"page":0},{"id":87,"width":46,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":37.2626953125,"chnl":15,"x":48,"y":422,"page":0},{"id":124,"width":17,"height":45,"xoffset":0,"yoffset":-29.859375,"xadvance":10.2333984375,"chnl":15,"x":33,"y":371,"page":0},{"id":81,"width":36,"height":45,"xoffset":0,"yoffset":-30.26953125,"xadvance":28.875,"chnl":15,"x":52,"y":371,"page":0},{"id":109,"width":44,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":36.8115234375,"chnl":15,"x":0,"y":473,"page":0},{"id":77,"width":43,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":36.66796875,"chnl":15,"x":96,"y":422,"page":0},{"id":39,"width":15,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":7.3212890625,"chnl":15,"x":90,"y":371,"page":0},{"id":34,"width":21,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":13.4326171875,"chnl":15,"x":107,"y":371,"page":0},{"id":92,"width":27,"height":42,"xoffset":0,"yoffset":-29.859375,"xadvance":17.2265625,"chnl":15,"x":130,"y":371,"page":0},{"id":104,"width":30,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":23.1328125,"chnl":15,"x":159,"y":371,"page":0},{"id":47,"width":26,"height":42,"xoffset":0,"yoffset":-29.859375,"xadvance":17.30859375,"chnl":15,"x":191,"y":371,"page":0},{"id":108,"width":17,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":10.1923828125,"chnl":15,"x":219,"y":371,"page":0},{"id":98,"width":32,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":23.5634765625,"chnl":15,"x":238,"y":371,"page":0},{"id":107,"width":31,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":21.287109375,"chnl":15,"x":272,"y":371,"page":0},{"id":100,"width":31,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":23.6865234375,"chnl":15,"x":305,"y":371,"page":0},{"id":102,"width":25,"height":42,"xoffset":0,"yoffset":-31.9306640625,"xadvance":14.5810546875,"chnl":15,"x":338,"y":371,"page":0},{"id":48,"width":31,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":365,"y":371,"page":0},{"id":51,"width":31,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":398,"y":371,"page":0},{"id":83,"width":33,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":24.9169921875,"chnl":15,"x":431,"y":371,"page":0},{"id":56,"width":31,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":466,"y":371,"page":0},{"id":119,"width":41,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":31.5615234375,"chnl":15,"x":46,"y":473,"page":0},{"id":37,"width":39,"height":41,"xoffset":0,"yoffset":-30.2900390625,"xadvance":30.76171875,"chnl":15,"x":20,"y":320,"page":0},{"id":103,"width":31,"height":41,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.5634765625,"chnl":15,"x":61,"y":320,"page":0},{"id":113,"width":31,"height":41,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.87109375,"chnl":15,"x":94,"y":320,"page":0},{"id":96,"width":20,"height":41,"xoffset":0,"yoffset":-31.458984375,"xadvance":12.9814453125,"chnl":15,"x":127,"y":320,"page":0},{"id":38,"width":36,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":26.1064453125,"chnl":15,"x":149,"y":320,"page":0},{"id":121,"width":29,"height":41,"xoffset":0,"yoffset":-22.189453125,"xadvance":19.8720703125,"chnl":15,"x":187,"y":320,"page":0},{"id":67,"width":35,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":27.3369140625,"chnl":15,"x":218,"y":320,"page":0},{"id":79,"width":36,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":28.875,"chnl":15,"x":255,"y":320,"page":0},{"id":71,"width":36,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":28.6083984375,"chnl":15,"x":293,"y":320,"page":0},{"id":112,"width":32,"height":41,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.5634765625,"chnl":15,"x":331,"y":320,"page":0},{"id":72,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":29.94140625,"chnl":15,"x":141,"y":422,"page":0},{"id":73,"width":18,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":11.4228515625,"chnl":15,"x":179,"y":422,"page":0},{"id":74,"width":30,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.173828125,"chnl":15,"x":199,"y":422,"page":0},{"id":75,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.33203125,"chnl":15,"x":231,"y":422,"page":0},{"id":76,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":22.599609375,"chnl":15,"x":269,"y":422,"page":0},{"id":57,"width":31,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":303,"y":422,"page":0},{"id":78,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":29.94140625,"chnl":15,"x":336,"y":422,"page":0},{"id":33,"width":18,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":10.8076171875,"chnl":15,"x":374,"y":422,"page":0},{"id":80,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.49609375,"chnl":15,"x":394,"y":422,"page":0},{"id":42,"width":27,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":18.087890625,"chnl":15,"x":431,"y":422,"page":0},{"id":82,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.8603515625,"chnl":15,"x":460,"y":422,"page":0},{"id":49,"width":25,"height":40,"xoffset":0,"yoffset":-30.0029296875,"xadvance":23.583984375,"chnl":15,"x":365,"y":320,"page":0},{"id":84,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.060546875,"chnl":15,"x":392,"y":320,"page":0},{"id":85,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":27.234375,"chnl":15,"x":428,"y":320,"page":0},{"id":86,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.7216796875,"chnl":15,"x":464,"y":320,"page":0},{"id":50,"width":32,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":26,"y":268,"page":0},{"id":88,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.33203125,"chnl":15,"x":60,"y":268,"page":0},{"id":89,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.224609375,"chnl":15,"x":97,"y":268,"page":0},{"id":90,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.142578125,"chnl":15,"x":134,"y":268,"page":0},{"id":105,"width":17,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":10.1923828125,"chnl":15,"x":170,"y":268,"page":0},{"id":52,"width":33,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.583984375,"chnl":15,"x":189,"y":268,"page":0},{"id":63,"width":28,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":19.8310546875,"chnl":15,"x":224,"y":268,"page":0},{"id":94,"width":26,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":17.5546875,"chnl":15,"x":254,"y":268,"page":0},{"id":53,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.583984375,"chnl":15,"x":282,"y":268,"page":0},{"id":65,"width":37,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":27.3984375,"chnl":15,"x":316,"y":268,"page":0},{"id":66,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.1474609375,"chnl":15,"x":355,"y":268,"page":0},{"id":54,"width":32,"height":40,"xoffset":0,"yoffset":-29.8798828125,"xadvance":23.583984375,"chnl":15,"x":391,"y":268,"page":0},{"id":68,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":27.5419921875,"chnl":15,"x":425,"y":268,"page":0},{"id":55,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.583984375,"chnl":15,"x":462,"y":268,"page":0},{"id":70,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.21484375,"chnl":15,"x":25,"y":216,"page":0},{"id":35,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.8603515625,"chnl":15,"x":59,"y":216,"page":0},{"id":69,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.87109375,"chnl":15,"x":96,"y":216,"page":0},{"id":116,"width":22,"height":38,"xoffset":0,"yoffset":-27.5625,"xadvance":13.7197265625,"chnl":15,"x":130,"y":216,"page":0},{"id":59,"width":17,"height":38,"xoffset":0,"yoffset":-22.39453125,"xadvance":8.8798828125,"chnl":15,"x":154,"y":216,"page":0},{"id":126,"width":36,"height":26,"xoffset":0,"yoffset":-16.447265625,"xadvance":28.5673828125,"chnl":15,"x":89,"y":473,"page":0},{"id":43,"width":32,"height":35,"xoffset":0,"yoffset":-24.732421875,"xadvance":23.8095703125,"chnl":15,"x":173,"y":216,"page":0},{"id":60,"width":28,"height":33,"xoffset":0,"yoffset":-22.517578125,"xadvance":21.3486328125,"chnl":15,"x":207,"y":216,"page":0},{"id":97,"width":31,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":22.845703125,"chnl":15,"x":237,"y":216,"page":0},{"id":101,"width":31,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":22.2509765625,"chnl":15,"x":270,"y":216,"page":0},{"id":110,"width":30,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.173828125,"chnl":15,"x":303,"y":216,"page":0},{"id":111,"width":32,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.953125,"chnl":15,"x":335,"y":216,"page":0},{"id":62,"width":30,"height":33,"xoffset":0,"yoffset":-22.5380859375,"xadvance":21.943359375,"chnl":15,"x":369,"y":216,"page":0},{"id":58,"width":17,"height":33,"xoffset":0,"yoffset":-22.39453125,"xadvance":10.171875,"chnl":15,"x":401,"y":216,"page":0},{"id":114,"width":24,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":14.2119140625,"chnl":15,"x":420,"y":216,"page":0},{"id":115,"width":30,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":21.65625,"chnl":15,"x":446,"y":216,"page":0},{"id":99,"width":31,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":21.984375,"chnl":15,"x":478,"y":216,"page":0},{"id":117,"width":30,"height":33,"xoffset":0,"yoffset":-22.189453125,"xadvance":23.1533203125,"chnl":15,"x":23,"y":163,"page":0},{"id":118,"width":30,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":20.34375,"chnl":15,"x":55,"y":163,"page":0},{"id":120,"width":30,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":20.8154296875,"chnl":15,"x":87,"y":163,"page":0},{"id":122,"width":29,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":20.8154296875,"chnl":15,"x":119,"y":163,"page":0},{"id":61,"width":30,"height":30,"xoffset":0,"yoffset":-19.9951171875,"xadvance":23.05078125,"chnl":15,"x":150,"y":163,"page":0},{"id":95,"width":29,"height":13,"xoffset":0,"yoffset":0,"xadvance":18.94921875,"chnl":15,"x":127,"y":473,"page":0},{"id":45,"width":21,"height":24,"xoffset":0,"yoffset":-14.232421875,"xadvance":11.5869140625,"chnl":15,"x":182,"y":163,"page":0},{"id":44,"width":16,"height":20,"xoffset":0,"yoffset":-4.4912109375,"xadvance":8.244140625,"chnl":15,"x":496,"y":268,"page":0},{"id":46,"width":18,"height":15,"xoffset":0,"yoffset":-4.2861328125,"xadvance":11.0537109375,"chnl":15,"x":23,"y":198,"page":0},{"id":32,"width":0,"height":0,"xoffset":0,"yoffset":0,"xadvance":10.3974609375,"chnl":15,"x":0,"y":508,"page":0}],"info":{"face":"Roboto","size":42,"bold":0,"italic":0,"charset":[" ","!","\\"","#","$","%","&","\'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\\\","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","{","|","}","~"],"unicode":1,"stretchH":100,"smooth":1,"aa":1,"padding":[0,0,0,0],"spacing":[2,2]},"common":{"lineHeight":44.091796875,"base":38.96484375,"scaleW":512,"scaleH":512,"pages":1,"packed":0,"alphaChnl":0,"redChnl":0,"greenChnl":0,"blueChnl":0},"kernings":[{"first":32,"second":84,"amount":-0.8203125},{"first":34,"second":34,"amount":-2.1943359375},{"first":34,"second":39,"amount":-2.1943359375},{"first":34,"second":65,"amount":-2.4609375},{"first":34,"second":97,"amount":-1.025390625},{"first":34,"second":99,"amount":-1.2099609375},{"first":34,"second":100,"amount":-1.2099609375},{"first":34,"second":101,"amount":-1.2099609375},{"first":34,"second":103,"amount":-1.2099609375},{"first":34,"second":109,"amount":-0.41015625},{"first":34,"second":110,"amount":-0.41015625},{"first":34,"second":111,"amount":-1.2509765625},{"first":34,"second":112,"amount":-0.41015625},{"first":34,"second":113,"amount":-1.2099609375},{"first":34,"second":115,"amount":-1.640625},{"first":39,"second":34,"amount":-2.1943359375},{"first":39,"second":39,"amount":-2.1943359375},{"first":39,"second":65,"amount":-2.4609375},{"first":39,"second":97,"amount":-1.025390625},{"first":39,"second":99,"amount":-1.2099609375},{"first":39,"second":100,"amount":-1.2099609375},{"first":39,"second":101,"amount":-1.2099609375},{"first":39,"second":103,"amount":-1.2099609375},{"first":39,"second":109,"amount":-0.41015625},{"first":39,"second":110,"amount":-0.41015625},{"first":39,"second":111,"amount":-1.2509765625},{"first":39,"second":112,"amount":-0.41015625},{"first":39,"second":113,"amount":-1.2099609375},{"first":39,"second":115,"amount":-1.640625},{"first":40,"second":86,"amount":0.41015625},{"first":40,"second":87,"amount":0.369140625},{"first":40,"second":89,"amount":0.451171875},{"first":44,"second":34,"amount":-3.486328125},{"first":44,"second":39,"amount":-3.486328125},{"first":46,"second":34,"amount":-3.486328125},{"first":46,"second":39,"amount":-3.486328125},{"first":47,"second":47,"amount":-4.59375},{"first":65,"second":34,"amount":-2.4609375},{"first":65,"second":39,"amount":-2.4609375},{"first":65,"second":67,"amount":-0.2255859375},{"first":65,"second":71,"amount":-0.2255859375},{"first":65,"second":79,"amount":-0.2255859375},{"first":65,"second":81,"amount":-0.2255859375},{"first":65,"second":84,"amount":-2.6455078125},{"first":65,"second":85,"amount":-0.3486328125},{"first":65,"second":86,"amount":-1.7841796875},{"first":65,"second":87,"amount":-1.4150390625},{"first":65,"second":89,"amount":-1.927734375},{"first":65,"second":111,"amount":-0.24609375},{"first":65,"second":117,"amount":-0.2255859375},{"first":65,"second":118,"amount":-1.025390625},{"first":65,"second":121,"amount":-1.025390625},{"first":65,"second":122,"amount":0.24609375},{"first":66,"second":84,"amount":-0.5537109375},{"first":66,"second":86,"amount":-0.4921875},{"first":66,"second":89,"amount":-1.1279296875},{"first":67,"second":84,"amount":-0.5947265625},{"first":68,"second":44,"amount":-2.091796875},{"first":68,"second":46,"amount":-2.091796875},{"first":68,"second":65,"amount":-0.4306640625},{"first":68,"second":84,"amount":-0.5537109375},{"first":68,"second":86,"amount":-0.451171875},{"first":68,"second":88,"amount":-0.451171875},{"first":68,"second":89,"amount":-0.8818359375},{"first":68,"second":90,"amount":-0.4716796875},{"first":69,"second":84,"amount":0.41015625},{"first":69,"second":99,"amount":-0.3896484375},{"first":69,"second":100,"amount":-0.3896484375},{"first":69,"second":101,"amount":-0.3896484375},{"first":69,"second":103,"amount":-0.3896484375},{"first":69,"second":111,"amount":-0.3896484375},{"first":69,"second":113,"amount":-0.3896484375},{"first":69,"second":117,"amount":-0.3486328125},{"first":69,"second":118,"amount":-0.533203125},{"first":69,"second":121,"amount":-0.533203125},{"first":70,"second":44,"amount":-4.798828125},{"first":70,"second":46,"amount":-4.798828125},{"first":70,"second":65,"amount":-3.486328125},{"first":70,"second":74,"amount":-5.4140625},{"first":70,"second":84,"amount":0.41015625},{"first":70,"second":97,"amount":-0.697265625},{"first":70,"second":99,"amount":-0.4306640625},{"first":70,"second":100,"amount":-0.4306640625},{"first":70,"second":101,"amount":-0.4306640625},{"first":70,"second":103,"amount":-0.4306640625},{"first":70,"second":111,"amount":-0.4306640625},{"first":70,"second":113,"amount":-0.4306640625},{"first":70,"second":114,"amount":-0.533203125},{"first":70,"second":117,"amount":-0.451171875},{"first":70,"second":118,"amount":-0.4921875},{"first":70,"second":121,"amount":-0.4921875},{"first":72,"second":65,"amount":0.369140625},{"first":72,"second":84,"amount":-0.5947265625},{"first":72,"second":88,"amount":0.3486328125},{"first":72,"second":89,"amount":-0.57421875},{"first":73,"second":65,"amount":0.369140625},{"first":73,"second":84,"amount":-0.5947265625},{"first":73,"second":88,"amount":0.3486328125},{"first":73,"second":89,"amount":-0.57421875},{"first":74,"second":65,"amount":-0.451171875},{"first":75,"second":45,"amount":-1.3125},{"first":75,"second":67,"amount":-0.6357421875},{"first":75,"second":71,"amount":-0.6357421875},{"first":75,"second":79,"amount":-0.6357421875},{"first":75,"second":81,"amount":-0.6357421875},{"first":75,"second":99,"amount":-0.533203125},{"first":75,"second":100,"amount":-0.533203125},{"first":75,"second":101,"amount":-0.533203125},{"first":75,"second":103,"amount":-0.533203125},{"first":75,"second":109,"amount":-0.4716796875},{"first":75,"second":110,"amount":-0.4716796875},{"first":75,"second":111,"amount":-0.5537109375},{"first":75,"second":112,"amount":-0.4716796875},{"first":75,"second":113,"amount":-0.533203125},{"first":75,"second":117,"amount":-0.4716796875},{"first":75,"second":118,"amount":-0.8203125},{"first":75,"second":121,"amount":-0.8203125},{"first":76,"second":34,"amount":-6.890625},{"first":76,"second":39,"amount":-6.890625},{"first":76,"second":65,"amount":0.3896484375},{"first":76,"second":67,"amount":-1.3330078125},{"first":76,"second":71,"amount":-1.3330078125},{"first":76,"second":79,"amount":-1.3330078125},{"first":76,"second":81,"amount":-1.3330078125},{"first":76,"second":84,"amount":-5.6396484375},{"first":76,"second":85,"amount":-1.107421875},{"first":76,"second":86,"amount":-3.5888671875},{"first":76,"second":87,"amount":-2.9326171875},{"first":76,"second":89,"amount":-4.9013671875},{"first":76,"second":117,"amount":-0.90234375},{"first":76,"second":118,"amount":-2.7275390625},{"first":76,"second":121,"amount":-2.7275390625},{"first":77,"second":65,"amount":0.369140625},{"first":77,"second":84,"amount":-0.5947265625},{"first":77,"second":88,"amount":0.3486328125},{"first":77,"second":89,"amount":-0.57421875},{"first":78,"second":65,"amount":0.369140625},{"first":78,"second":84,"amount":-0.5947265625},{"first":78,"second":88,"amount":0.3486328125},{"first":78,"second":89,"amount":-0.57421875},{"first":79,"second":44,"amount":-2.091796875},{"first":79,"second":46,"amount":-2.091796875},{"first":79,"second":65,"amount":-0.4306640625},{"first":79,"second":84,"amount":-0.5537109375},{"first":79,"second":86,"amount":-0.451171875},{"first":79,"second":88,"amount":-0.451171875},{"first":79,"second":89,"amount":-0.8818359375},{"first":79,"second":90,"amount":-0.4716796875},{"first":80,"second":44,"amount":-6.64453125},{"first":80,"second":46,"amount":-6.64453125},{"first":80,"second":65,"amount":-2.830078125},{"first":80,"second":74,"amount":-4.1015625},{"first":80,"second":88,"amount":-0.6357421875},{"first":80,"second":90,"amount":-0.533203125},{"first":80,"second":97,"amount":-0.2255859375},{"first":80,"second":99,"amount":-0.2666015625},{"first":80,"second":100,"amount":-0.2666015625},{"first":80,"second":101,"amount":-0.2666015625},{"first":80,"second":103,"amount":-0.2666015625},{"first":80,"second":111,"amount":-0.2666015625},{"first":80,"second":113,"amount":-0.2666015625},{"first":80,"second":118,"amount":0.3076171875},{"first":80,"second":121,"amount":0.3076171875},{"first":81,"second":84,"amount":-0.8818359375},{"first":81,"second":86,"amount":-0.57421875},{"first":81,"second":87,"amount":-0.41015625},{"first":81,"second":89,"amount":-0.7177734375},{"first":82,"second":84,"amount":-1.640625},{"first":82,"second":86,"amount":-0.3896484375},{"first":82,"second":89,"amount":-0.984375},{"first":84,"second":44,"amount":-4.470703125},{"first":84,"second":45,"amount":-4.7578125},{"first":84,"second":46,"amount":-4.470703125},{"first":84,"second":65,"amount":-1.6201171875},{"first":84,"second":67,"amount":-0.57421875},{"first":84,"second":71,"amount":-0.57421875},{"first":84,"second":74,"amount":-4.921875},{"first":84,"second":79,"amount":-0.57421875},{"first":84,"second":81,"amount":-0.57421875},{"first":84,"second":83,"amount":-0.328125},{"first":84,"second":84,"amount":0.328125},{"first":84,"second":86,"amount":0.328125},{"first":84,"second":87,"amount":0.3076171875},{"first":84,"second":89,"amount":0.328125},{"first":84,"second":97,"amount":-2.3173828125},{"first":84,"second":99,"amount":-2.0302734375},{"first":84,"second":100,"amount":-2.0302734375},{"first":84,"second":101,"amount":-2.0302734375},{"first":84,"second":103,"amount":-2.0302734375},{"first":84,"second":109,"amount":-2.2353515625},{"first":84,"second":110,"amount":-2.2353515625},{"first":84,"second":111,"amount":-2.0302734375},{"first":84,"second":112,"amount":-2.2353515625},{"first":84,"second":113,"amount":-2.0302734375},{"first":84,"second":115,"amount":-2.37890625},{"first":84,"second":117,"amount":-1.9482421875},{"first":84,"second":118,"amount":-1.4765625},{"first":84,"second":120,"amount":-1.5791015625},{"first":84,"second":121,"amount":-1.4765625},{"first":84,"second":122,"amount":-1.23046875},{"first":85,"second":65,"amount":-0.451171875},{"first":86,"second":44,"amount":-4.6142578125},{"first":86,"second":45,"amount":-0.7587890625},{"first":86,"second":46,"amount":-4.6142578125},{"first":86,"second":65,"amount":-1.5380859375},{"first":86,"second":67,"amount":-0.2666015625},{"first":86,"second":71,"amount":-0.2666015625},{"first":86,"second":79,"amount":-0.2666015625},{"first":86,"second":81,"amount":-0.2666015625},{"first":86,"second":97,"amount":-0.943359375},{"first":86,"second":99,"amount":-0.90234375},{"first":86,"second":100,"amount":-0.90234375},{"first":86,"second":101,"amount":-0.90234375},{"first":86,"second":103,"amount":-0.90234375},{"first":86,"second":111,"amount":-0.943359375},{"first":86,"second":113,"amount":-0.90234375},{"first":86,"second":117,"amount":-0.57421875},{"first":86,"second":118,"amount":-0.2255859375},{"first":86,"second":121,"amount":-0.2255859375},{"first":87,"second":44,"amount":-2.5224609375},{"first":87,"second":45,"amount":-1.23046875},{"first":87,"second":46,"amount":-2.5224609375},{"first":87,"second":65,"amount":-0.8818359375},{"first":87,"second":84,"amount":0.287109375},{"first":87,"second":97,"amount":-0.6767578125},{"first":87,"second":99,"amount":-0.6357421875},{"first":87,"second":100,"amount":-0.6357421875},{"first":87,"second":101,"amount":-0.6357421875},{"first":87,"second":103,"amount":-0.6357421875},{"first":87,"second":111,"amount":-0.6357421875},{"first":87,"second":113,"amount":-0.6357421875},{"first":87,"second":117,"amount":-0.3896484375},{"first":88,"second":45,"amount":-0.943359375},{"first":88,"second":67,"amount":-0.5126953125},{"first":88,"second":71,"amount":-0.5126953125},{"first":88,"second":79,"amount":-0.5126953125},{"first":88,"second":81,"amount":-0.5126953125},{"first":88,"second":86,"amount":0.287109375},{"first":88,"second":99,"amount":-0.533203125},{"first":88,"second":100,"amount":-0.533203125},{"first":88,"second":101,"amount":-0.533203125},{"first":88,"second":103,"amount":-0.533203125},{"first":88,"second":111,"amount":-0.4306640625},{"first":88,"second":113,"amount":-0.533203125},{"first":88,"second":117,"amount":-0.4306640625},{"first":88,"second":118,"amount":-0.6357421875},{"first":88,"second":121,"amount":-0.6357421875},{"first":89,"second":44,"amount":-4.3271484375},{"first":89,"second":45,"amount":-1.06640625},{"first":89,"second":46,"amount":-4.3271484375},{"first":89,"second":65,"amount":-1.927734375},{"first":89,"second":67,"amount":-0.5947265625},{"first":89,"second":71,"amount":-0.5947265625},{"first":89,"second":74,"amount":-1.96875},{"first":89,"second":79,"amount":-0.5947265625},{"first":89,"second":81,"amount":-0.5947265625},{"first":89,"second":83,"amount":-0.328125},{"first":89,"second":84,"amount":0.3486328125},{"first":89,"second":85,"amount":-1.96875},{"first":89,"second":86,"amount":0.369140625},{"first":89,"second":87,"amount":0.3486328125},{"first":89,"second":88,"amount":0.2666015625},{"first":89,"second":89,"amount":0.369140625},{"first":89,"second":97,"amount":-1.4970703125},{"first":89,"second":99,"amount":-1.3330078125},{"first":89,"second":100,"amount":-1.3330078125},{"first":89,"second":101,"amount":-1.3330078125},{"first":89,"second":103,"amount":-1.3330078125},{"first":89,"second":109,"amount":-0.8203125},{"first":89,"second":110,"amount":-0.8203125},{"first":89,"second":111,"amount":-1.3330078125},{"first":89,"second":112,"amount":-0.8203125},{"first":89,"second":113,"amount":-1.3330078125},{"first":89,"second":115,"amount":-1.189453125},{"first":89,"second":117,"amount":-0.7998046875},{"first":89,"second":118,"amount":-0.41015625},{"first":89,"second":120,"amount":-0.4716796875},{"first":89,"second":121,"amount":-0.41015625},{"first":89,"second":122,"amount":-0.615234375},{"first":90,"second":65,"amount":0.2666015625},{"first":90,"second":67,"amount":-0.533203125},{"first":90,"second":71,"amount":-0.533203125},{"first":90,"second":79,"amount":-0.533203125},{"first":90,"second":81,"amount":-0.533203125},{"first":90,"second":99,"amount":-0.4306640625},{"first":90,"second":100,"amount":-0.4306640625},{"first":90,"second":101,"amount":-0.4306640625},{"first":90,"second":103,"amount":-0.4306640625},{"first":90,"second":111,"amount":-0.4306640625},{"first":90,"second":113,"amount":-0.4306640625},{"first":90,"second":117,"amount":-0.3896484375},{"first":90,"second":118,"amount":-0.5537109375},{"first":90,"second":121,"amount":-0.5537109375},{"first":91,"second":74,"amount":-0.369140625},{"first":91,"second":85,"amount":-0.369140625},{"first":97,"second":34,"amount":-1.3740234375},{"first":97,"second":39,"amount":-1.3740234375},{"first":97,"second":118,"amount":-0.3076171875},{"first":97,"second":121,"amount":-0.3076171875},{"first":98,"second":34,"amount":-0.5947265625},{"first":98,"second":39,"amount":-0.5947265625},{"first":98,"second":118,"amount":-0.2255859375},{"first":98,"second":120,"amount":-0.3076171875},{"first":98,"second":121,"amount":-0.2255859375},{"first":98,"second":122,"amount":-0.3076171875},{"first":99,"second":34,"amount":-0.2255859375},{"first":99,"second":39,"amount":-0.2255859375},{"first":101,"second":34,"amount":-0.287109375},{"first":101,"second":39,"amount":-0.287109375},{"first":101,"second":118,"amount":-0.2666015625},{"first":101,"second":121,"amount":-0.2666015625},{"first":102,"second":34,"amount":0.328125},{"first":102,"second":39,"amount":0.328125},{"first":102,"second":41,"amount":0.41015625},{"first":102,"second":93,"amount":0.369140625},{"first":102,"second":99,"amount":-0.4921875},{"first":102,"second":100,"amount":-0.4921875},{"first":102,"second":101,"amount":-0.4921875},{"first":102,"second":103,"amount":-0.4921875},{"first":102,"second":113,"amount":-0.4921875},{"first":102,"second":125,"amount":0.3896484375},{"first":104,"second":34,"amount":-2.1328125},{"first":104,"second":39,"amount":-2.1328125},{"first":107,"second":99,"amount":-0.41015625},{"first":107,"second":100,"amount":-0.41015625},{"first":107,"second":101,"amount":-0.41015625},{"first":107,"second":103,"amount":-0.41015625},{"first":107,"second":113,"amount":-0.41015625},{"first":109,"second":34,"amount":-2.1328125},{"first":109,"second":39,"amount":-2.1328125},{"first":110,"second":34,"amount":-2.1328125},{"first":110,"second":39,"amount":-2.1328125},{"first":111,"second":34,"amount":-2.7890625},{"first":111,"second":39,"amount":-2.7890625},{"first":111,"second":118,"amount":-0.3076171875},{"first":111,"second":120,"amount":-0.4306640625},{"first":111,"second":121,"amount":-0.3076171875},{"first":111,"second":122,"amount":-0.328125},{"first":112,"second":34,"amount":-0.5947265625},{"first":112,"second":39,"amount":-0.5947265625},{"first":112,"second":118,"amount":-0.2255859375},{"first":112,"second":120,"amount":-0.3076171875},{"first":112,"second":121,"amount":-0.2255859375},{"first":112,"second":122,"amount":-0.3076171875},{"first":114,"second":34,"amount":0.328125},{"first":114,"second":39,"amount":0.328125},{"first":114,"second":44,"amount":-2.5224609375},{"first":114,"second":46,"amount":-2.5224609375},{"first":114,"second":97,"amount":-0.8203125},{"first":114,"second":99,"amount":-0.3896484375},{"first":114,"second":100,"amount":-0.3896484375},{"first":114,"second":101,"amount":-0.3896484375},{"first":114,"second":103,"amount":-0.3896484375},{"first":114,"second":111,"amount":-0.41015625},{"first":114,"second":113,"amount":-0.3896484375},{"first":114,"second":118,"amount":0.369140625},{"first":114,"second":121,"amount":0.369140625},{"first":116,"second":111,"amount":-0.41015625},{"first":118,"second":34,"amount":0.3076171875},{"first":118,"second":39,"amount":0.3076171875},{"first":118,"second":44,"amount":-2.1943359375},{"first":118,"second":46,"amount":-2.1943359375},{"first":118,"second":97,"amount":-0.3076171875},{"first":118,"second":99,"amount":-0.2666015625},{"first":118,"second":100,"amount":-0.2666015625},{"first":118,"second":101,"amount":-0.2666015625},{"first":118,"second":103,"amount":-0.2666015625},{"first":118,"second":111,"amount":-0.3076171875},{"first":118,"second":113,"amount":-0.2666015625},{"first":119,"second":44,"amount":-2.54296875},{"first":119,"second":46,"amount":-2.54296875},{"first":120,"second":99,"amount":-0.41015625},{"first":120,"second":100,"amount":-0.41015625},{"first":120,"second":101,"amount":-0.41015625},{"first":120,"second":103,"amount":-0.41015625},{"first":120,"second":111,"amount":-0.41015625},{"first":120,"second":113,"amount":-0.41015625},{"first":121,"second":34,"amount":0.3076171875},{"first":121,"second":39,"amount":0.3076171875},{"first":121,"second":44,"amount":-2.1943359375},{"first":121,"second":46,"amount":-2.1943359375},{"first":121,"second":97,"amount":-0.3076171875},{"first":121,"second":99,"amount":-0.2666015625},{"first":121,"second":100,"amount":-0.2666015625},{"first":121,"second":101,"amount":-0.2666015625},{"first":121,"second":103,"amount":-0.2666015625},{"first":121,"second":111,"amount":-0.3076171875},{"first":121,"second":113,"amount":-0.2666015625},{"first":122,"second":99,"amount":-0.328125},{"first":122,"second":100,"amount":-0.328125},{"first":122,"second":101,"amount":-0.328125},{"first":122,"second":103,"amount":-0.328125},{"first":122,"second":111,"amount":-0.328125},{"first":122,"second":113,"amount":-0.328125},{"first":123,"second":74,"amount":-0.41015625},{"first":123,"second":85,"amount":-0.41015625}]}');var d=s.t(h,2);const c=String.fromCharCode(26);function isNewline(e){return!!/[\n\r]/.test(e)}function equalStyle(e,t,s,i){return!e&&!t||(e?t?(e.font||s)===(t.font||s)&&(e.size||i)===(t.size||i)&&e.color===t.color&&!!e.bold==!!t.bold&&!!e.italic==!!t.italic:e.font===s&&e.size===i&&!e.color&&!e.bold&&!e.italic:t.font===s&&t.size===i&&!t.color&&!t.bold&&!t.italic)}class MetricCache{constructor(){this.cache=[new Map],this.maxMaps=4,this.limit=256}makeKey(e,t,s){let i={font:t,size:s,style:e.style,styles:e.styles,text:e.text};return JSON.stringify(i)}lookup(e){for(let t=0;t<this.cache.length;t++){let s=this.cache[t].get(e);if(s)return{...s}}return null}update(e,t){let s=this.cache[this.cache.length-1];if(s.set(e,t),s.size>=this.limit){if(this.cache.length===this.maxMaps){let e=Math.floor(Math.random()*this.cache.length);this.cache.splice(e,1)}this.cache.push(new Map)}}}const u=new class MSDFFontRegistry{constructor(){this.layouts=new Map}hasLayout(e){return this.layouts.get(e)}addLayout(e,t){return this.layouts.set(e,t),t}measureText(e,t,s){let i=this.layouts.get(t);return i?i.measureText(e.text):{ascent:36,height:50,descent:14,width:20*e.text.length}}getInfo(e,t){let s,i=this.layouts.get(e);return i&&(s=i._opt.font),s||{common:{lineHeight:t}}}};class Measurer{constructor(){this.cache=new MetricCache}measureText(e,t,s){let i=this.cache.makeKey(e,t,s),o=this.cache.lookup(i);return o||(o=u.measureText(e,t,s),this.cache.update(i,o),o)}lineHeight(e,t){let s=u.getInfo(e,t);return s.common?s.common.lineHeight:s.atlas.size}}class Wrap{splitWords(e,t,s){const isSpace=e=>!!/[ \f\n\r\t\v\u00A0\u2028\u2029]/.test(e);let i,o,r,push=(e,t,s)=>{s&&s.length>1?a.push(Object.assign(e,{styles:s})):s&&1===s.length?a.push(Object.assign(e,{style:s[0].style})):t?a.push(Object.assign(e,{style:t})):a.push(e)},stylePush=(e,i)=>{if(!e)return[i];let o=e[e.length-1];return equalStyle(o.style,i.style,t,s)?(o.end=i.end,e):(e.push(i),e)},a=[],n=0,l="",h=null;for(let t=0;t<e.length-1;t++){void 0===i&&(i=!isSpace(e[0].text[0]));let s=e[t],a=s.text;o=s.style,i||(i=!isSpace(a[0]));let d=0;for(let e=0;e<a.length;e++)if(0!==n||0!==t||0!==e)if(i){if(isSpace(a[e])){r=a.slice(d,e);let t=l.length>0&&0===r.length;if(l.length>0){if(r.length>0){h=stylePush(h,{start:l.length,end:l.length+r.length,style:o})}r=l+r,l=""}push({start:n,end:n+r.length,text:r},t?null:o,h),n+=r.length,d=e,i=!1,h=null}}else e>0&&(push({start:n,end:n+1,text:a[e-1],style:o,styles:h}),n+=1,d+=1),isSpace(a[e])||(i=!0);if(r=a.slice(d,a.length),1===r.length&&isSpace(r))push({start:n,end:n+1,text:r,style:o,styles:h}),n+=1;else{h=stylePush(h,{start:l.length,end:l.length+r.length,style:o}),l+=r}}let d=n;if(l.length>0){d=n+l.length;let e={start:n,end:d,text:l};h&&1===h.length&&equalStyle(o,h[0].style,t,s)?push(e,o):push(e,null,h)}return push({start:d,end:d+1,text:c}),a}mergeRect(e,t){return e?t?{width:e.width+t.width,height:Math.max(e.height,t.height),ascent:Math.max(e.ascent,t.ascent)}:e:t}wrap(e,t,s,i,o,r){r||(r={left:0,top:0,right:0,bottom:0});const a=t-r.left-r.right;let n=[],l=0,h=0,d=[],c=r.left,u=r.top,p=this.splitWords(e,i,o),pushLine=()=>{0!==n.length&&(n.forEach((e=>{e.ascent=h})),d.push(n),n=[],c=r.left,u+=l,l=0,h=0)};for(let e=0;e<p.length-1;e++){let t,r=p[e];isNewline(r.text)?(t=s.measureText(r,i,o),e===p.length-1?pushLine():(l=Math.max(l,t.height),h=Math.max(h,t.ascent)),t.left=c,t.top=u,Object.assign(r,t),n.push(r),pushLine(),l=0,h=0):(t=s.measureText(r,i,o),l=Math.max(l,t.height),h=Math.max(h,t.ascent),t.width+c>a&&pushLine(),t.left=c,t.top=u,Object.assign(r,t),c+=t.width,n.push(r))}pushLine();let f=p[p.length-1],m=s.measureText(f,i,o);return l=Math.max(l,m.height),h=Math.max(h,m.ascent),m.left=r.left,m.top=u,Object.assign(f,m),n.push(f),pushLine(),[d,p]}}function maybeSelectCommentOrLine(e){var t=e.selection,{row:s,column:i}=t.lead,o=e.selectionOrLineString();if(t.isEmpty()){var r=o.indexOf("//");-1===r||i<r||r>0&&":\"'".indexOf(o[r-1])>=0?e.selectLine(s):t.range={start:{row:s,column:r+2},end:{row:s,column:o.length}}}}function doEval(e,t,s,i){t||(t=e.selection.isEmpty()?e.lineRange():e.selection.range),i||(i=e.textInRange(t))}let p={doit:{doc:"Evaluates the selected code or the current line and report the result",exec:async(e,t,s=1)=>{let i,o;maybeSelectCommentOrLine(e);try{t=Object.assign({},t,{inspect:!0,inspectDepth:s}),i=await doEval(e,void 0),o=i.isError?i.value:null}catch(e){o=e}return o&&console.log("**"+o),i}},printit:{doc:"Evaluates selected code or the current line and inserts the result in a printed representation",exec:async(e,t)=>{let s,i;maybeSelectCommentOrLine(e);try{t=Object.assign({},t,{asString:!0}),s=await doEval(e,void 0),i=s.isError?s.value:null}catch(e){i=e}return e.selection.collapseToEnd(),e.insertTextAndSelect(i?String(i)+(i.stack?"\n"+i.stack:""):String(s.value)),s}}};Object.assign({},{"clipboard copy":{doc:"placeholder for native copy",exec:e=>!1},"clipboard cut":{doc:"placeholder for native cut",exec:e=>!1},"clipboard paste":{doc:"placeholder for native paste",exec:e=>!1}},p);let f=[[""],["shift"],["alt"],["alt","shift"],["ctrl"],["ctrl","shift"],["ctrl","alt"],["ctrl","alt","shift"],["meta"],["meta","shift"],["meta","alt"],["meta","alt","shift"],["meta","ctrl"],["meta","ctrl","shift"],["meta","ctrl","alt"],["meta","shift","alt","shift"]],m={shift:1,alt:2,option:2,control:4,ctrl:4,super:8,win:8,meta:8,command:8,cmd:8},isNumber=function(e){return/^[0-9]+$/.test(e)};function cap(e){return e[0].toUpperCase()+e.slice(1)}function eventToKeyCombo(e,t,s){let i=s.key,o=s.keyIdentifier;if(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].indexOf(s.key)>=0)return s.key;if([10,13,8,46].indexOf(s.keyCode)>=0)return s.key;if(0===e||1===e)return null;if(!i&&o&&(i=function decodeKeyIdentifier(e,t){let s=e&&e.replace(/u\+?([\d\w]{4})/gi,((e,t)=>String.fromCharCode(parseInt(t,16))));return"Command"!==s&&"Cmd"!==s||(s="Meta")," "===s&&(s="Space"),8===t&&(s="Backspace"),s}(o,s.which||s.keyCode),s.key=i=i[s.shiftKey?"toUpperCase":"toLowerCase"](),function isModifier(e){return!isNumber(e)&&(e=e.replace(/-$/,"").toLowerCase(),!!m[e])}(i)))return cap(i[0]);let r=f[e];s.code&&(i=function identifyKeyFromCode(e){let t=e.code;if("string"!=typeof t)return null;if(t.startsWith("Key"))return t.slice(3);if(t.startsWith("Numpad"))return t;if(t.startsWith("Digit"))return t.slice(5);if(t.startsWith("Arrow"))return t.slice(5);if(t.match(/^F[0-9]{1-2}$/))return t;switch(t){case"Insert":case"Home":case"PageUp":case"PageDown":return t;case"Period":return".";case"Comma":return",";case"Help":return"Insert";case"Equal":return"=";case"Backslash":case"IntlBackslash":return"\\";case"Minus":return"-";case"BracketRight":return"]";case"BracketLeft":return"[";case"Quote":return"'";case"Backquote":return"`";case"Semicolon":return";";default:return null}}(s)||i);let a=r.map(cap).join("-");return t||(a+=i?"-"+i:""),a}function canonicalizeKeyboardEvent(e){let t=0,s={keyCombo:"",key:"",shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:e.type,keyCode:e.keyCode};Object.keys(m).forEach((i=>{let o=i+"Key";e[o]&&(t|=m[i],s[o]=!0)})),m[e.key.toLowerCase()]&&(s.onlyModifiers=!0);let i=eventToKeyCombo(t,s.onlyModifiers,e);if(!i)return null;if(0===t||1===t)return s.keyCombo=i,s.key=e.key,1===t&&(s.onlyShiftModifier=!0,s.isModified=!0),s;if(t>1&&(s.isModified=!0),s.onlyModifiers)return s.keyCombo=i,s.key=e.key,s.onlyModifiers=!0,s;let o=function canonicalizeFunctionKey(e){switch(e=e.toLowerCase()){case"space":e="space";break;case"esc":e="escape";break;case"return":e="enter";break;case"arrowleft":e="left";break;case"arrowright":e="right";break;case"arrowup":e="up";break;case"arrowdown":e="down"}return["backspace","tab","enter","pause","escape"," ","pageup","pagedown","end","home","left","up","right","down","print","insert","delete","numpad0","numpad1","numpad2","numpad3","numpad4","numpad5","numpad6","numpad7","numpad8","numpad9","numpadenter","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","numlock","scrolllock"].includes(e)?cap(e):""}(e.key);if(o)s.isFunctionKey=!0,s.key=o;else{if(!s.isModified)return null;s.onlyShiftModifier?s.key=e.key:s.key=e.key[0].toUpperCase()+e.key.slice(1)}return s.keyCombo=i,s}let g=0;function runLength(e){return e.map((e=>e.text)).reduce(((e,t)=>t.length+e),0)}class Doc{constructor(e){this.runs=[],this.intervals=[],this.selections={},this.defaultFont=e.defaultFont||"Roboto",this.defaultSize=e.defaultSize||10}load(e){this.canonicalize(e)}setDefault(e,t){this.defaultFont=e||this.defaultFont,this.defaultSize=t||this.defaultSize}doEvent(e){"insert"===e.type?this.doInsert(e.user,e.runs):"delete"===e.type?this.doDelete(e.user,e.backspace):"select"===e.type?this.doSelect(e.user,e.start,e.end,e.isBol):"setStyle"===e.type&&this.doSetStyle(e.user,e.style,e.merge)}doInsert(e,t){let s=this.ensureSelection(e),i=t.length>0&&"\n"===t[t.length-1].text;if(s.start===s.end){let[o,r]=this.findRun(s.start),a=this.intervals[r];a.end!==s.start&&a.start!==s.start?(this.splitRunAt(r,s.start-a.start),r+=1):a.end===s.start&&(r+=1),this.runs.splice(r,0,...t),this.canonicalize(this.runs,a.start),this.updateSelectionsInsert(e,s.start,runLength(t),i)}else this.doDelete(e,!0),this.doInsert(e,t)}doDelete(e,t){let s,i,o=this.ensureSelection(e),r=this.length();if(o.start===o.end){if(!t&&o.start===r||t&&0===o.start)return;t?(s=o.start-1,i=o.end):(s=o.start,i=o.end+1)}else s=o.start,i=o.end;let[a,n]=this.findRun(s),l=this.intervals[n];l.end!==s&&(this.splitRunAt(n,s-l.start),n+=1);let[h,d]=this.findRun(i),c=this.intervals[d],u=i-c.start;i!==c.end&&0!==u?(this.splitRunAt(d,u),d+=1):i===c.end&&(d+=1),this.runs.splice(n,d-n),this.canonicalize(this.runs),this.updateSelectionsDelete(e,s,i)}doSelect(e,t,s,i){this.selections[e.id]={start:t,end:s,isBol:i,color:e.color}}doSetStyle(e,t,s){let i=this.selections[e.id];if(i.start===i.end)return;let o=i.start,r=i.end,[a,n]=this.findRun(o),l=this.intervals[n];l.start!==o&&this.splitRunAt(n,o-l.start),[a,n]=this.findRun(r),l=this.intervals[n],l.end!==r&&this.splitRunAt(n,r-l.start);let h=o,d=0;for(;h<r&&d<1e4;)if(d++,[a,n]=this.findRun(h),l=this.intervals[n],l.end<=r){let e=s?{...a.style,...t}:{...t};a.style=e,h=l.end}this.canonicalize(this.runs)}length(){return this.intervals[this.intervals.length-1].end-1}copyRun(e){if(!e)return e;let t={};return t.text=e.text,e.style&&(t.style=e.style),t}canonicalize(e){let t=[],s=[],i=0,addEOF=()=>{t.push({text:c}),s.push({start:i,end:i+1})};if(0===e.length)return addEOF(),this.runs=t,void(this.intervals=s);let o=this.copyRun(e[0]),r=1,a=this.copyRun(e[r]);for(;a&&a.text!==c;){if(equalStyle(o.style,a.style))o.text+=a.text;else{let e=i+o.text.length,r={start:i,end:e};i=e,t.push(o),s.push(r),o=a}r++,a=this.copyRun(e[r])}let n=i+o.text.length,l={start:i,end:n};t.push(o),s.push(l),i=n,t[t.length-1].text!==c&&addEOF(),this.runs=t,this.intervals=s}styleAt(e){let[t,s]=this.findRun(e);return t.style}save(e,t){let s,i,o,r,a,n,l,h=this.runs,d=this.intervals,u=void 0!==e?e:0,p=void 0!==t?t:this.length();if([s,i]=this.findRun(u),[o,r]=this.findRun(p),i===r)return l=d[i],n=this.copyRun({text:s.text.slice(u-l.start,p-l.start)}),[n];let f=[];a=s,l=d[i],n=this.copyRun({text:a.text.slice(u-l.start)},!0),f.push(n);for(let e=i+1;e<=r-1;e++)n=this.copyRun(h[e]),f.push(n);return l=d[r],n=this.copyRun({text:o.text.slice(0,p-l.start)}),n.text!==c&&f.push(n),f}plainText(e,t){return this.save(e,t).map((e=>e.text)).join("")}splitRunAt(e,t){let s=this.runs[e],i=this.intervals[e],o=this.copyRun({text:s.text.slice(0,t),style:s.style}),r=this.copyRun({text:s.text.slice(t,s.text.length),style:s.style});this.runs.splice(e,1,o,r),o={start:i.start,end:i.start+t},r={start:i.start+t,end:i.end},this.intervals.splice(e,1,o,r)}findRun(e){let t,s=this.runs,i=this.intervals;for(let o=0;o<s.length;o++)if(t=i[o],t.start<=e&&e<t.end)return[s[o],o];return e===t.end?[s[s.length-1],s.length-1]:[null,null]}updateSelectionsInsert(e,t,s,i){for(let o in this.selections){let r=this.selections[o];o===e.id?this.selections[o]={start:t+s,end:t+s,isBol:i,color:e.color}:t<r.start?this.selections[o]={start:r.start+s,end:r.end+s,isBol:i,color:r.color}:r.start<t&&t<r.end&&(this.selections[o]={start:r.start,end:r.end+s,isBol:i,color:r.color})}}updateSelectionsDelete(e,t,s){let i=s-t;for(let o in this.selections){let r=this.selections[o];o===e.id?this.selections[o]={start:t,end:t,color:e.color}:s<=r.start?this.selections[o]={start:r.start-i,end:r.end-i,color:r.color}:r.end<=t||(t<=r.start&&r.end<=s?this.selections[o]={start:t,end:t,color:r.color}:t<r.start&&s<r.end?this.selections[o]={start:t,end:r.end-i,color:r.color}:r.start<=t&&s<r.end?this.selections[o]={start:r.start,end:r.end-i,color:r.color}:r.start<=t&&t<r.end&&(this.selections[o]={start:r.start,end:t,color:r.color}));let[a,n]=this.findRun(this.selections[o].start-1);this.selections[o].isBol=a&&isNewline(a.text[a.text.length-1])}}setSelections(e){this.selections=JSON.parse(JSON.stringify(e))}getSelections(){return JSON.parse(JSON.stringify(this.selections))}ensureSelection(e){let t=this.selections[e.id];return t||(t={start:0,end:0,color:e.id},this.selections[e.id]=t),t}snapshotFrom(e,t,s){return{type:"snapshot",user:t,content:{runs:e.runs,selections:JSON.parse(JSON.stringify(e.selections))},timezone:s}}undoEvent(e,t,s){let i=t.queue,o=e.user;let r=function findLast(t,s){for(let i=t.length-1;i>=0;i--)if(t[i].user.id===s.user.id&&t[i].timezone===e.timezone&&"snapshot"!==t[i].type)return i;return-1}(i,e);if(r<0)return t.timezone;let a=i[r],n=function findSnapshot(e,t){for(;t>=0;t--)if("snapshot"===e[t].type)return t;return-1}(i,r);if(n<0)return t.timezone;let l=i[n].content;s.load(l.runs),s.setSelections(l.selections);let h=[];for(let e=0;e<=n;e++)h.push(i[e]);for(let e=n+1;e<r;e++)s.doEvent(i[e]),h.push(i[e]);for(let e=r+1;e<i.length;e++)"snapshot"!==i[e].type&&(s.doEvent(i[e]),h.push(i[e]));return t.timezone++,a.timezone=t.timezone,t.undoStacks[o.id]||(t.undoStacks[o.id]=[]),t.undoStacks[o.id].push(a),t.selections=s.getSelections(),t.runs=s.save(),t.queue=h,t.timezone}receiveEditEvents(e,t,s){let i=t.queue,o=e[0].user;if(t.timezone%10==0&&i.push(this.snapshotFrom(t,o,t.timezone)),t.timezone++,i.length>0&&i[i.length-1].timezone>e[0].timezone+60)return[t.timezone,!1];function transform(e,t){if("select"===e.type){if("insert"===t.type)return t.pos<=e.start?{...e,start:e.start+t.length,end:e.end+t.length}:e.start<=t.pos&&t.pos<=e.end?{...e,end:e.end+t.length}:e;if("delete"===t.type){if(e.end<=t.start)return e;if(t.start<=e.start&&e.end<=t.end)return{...e,start:t.start,end:t.start};if(t.end<=e.start)return e;if(e.start<=t.start&&e.end<t.end)return{...e,end:t.start};if(t.start<=e.start&&t.end<e.end)return{...e,start:t.start,end:e.end-t.end}}if("select"===t.type)return e}return e}let r=[],a={...t.selections},n=function findFirst(e,t){if(0===e.length)return 0;if(e[i.length-1].timezone<t.timezone)return e.length;for(let s=e.length-1;s>=0;s--)if(e[s].timezone<t.timezone)return s+1;return 0}(i,e[0]);e.forEach((e=>{let s=e;if(n>=0)for(let e=n;e<i.length;e++)s=transform(s,i[e]);s.timezone=t.timezone,r.push(s)})),i.push(...r),n=i.findIndex((e=>e.timezone>t.timezone-60));for(let e=i.length-1;e>=0;e--){delete a[i[e].user.id]}for(let e in a)delete t.selections[e],delete t.undoStacks[e];i.splice(0,n),s.setSelections(t.selections);let l=!1;return r.forEach((e=>{l=l||"insert"===e.type||"delete"===e.type,s.doEvent(e)})),t.runs=s.save(),t.selections=s.getSelections(),[t.timezone,l]}}class Warota{constructor(e,t){this.doc=t||new Doc,this._width=0,e.margins?this.margins=e.margins:this.margins=e.margins={left:0,top:0,right:0,bottom:0},this.options=e,this.scrollLeft=0,this.scrollTop=0,this.relativeScrollBarWidth=.02,this.showsScrollbar=e.showScrollBar,this.isScrollable=!0,this.resize(e.width,e.height),this.resizeToNumLinesOrFontSize(e),this.events=[],this.timezone=0}resetEvents(){this.events=[]}width(e){return void 0===e?this._width:(this._width=e,null)}setTimezone(e){this.timezone=e}resize(e,t){this.screenWidth=e,this.screenHeight=t}resizeToNumLinesOrFontSize(e){this.defaultMeasurer=new Measurer;let t=this.defaultMeasurer.lineHeight(e.font,e.fontSize),s=e.margins.top+e.margins.bottom,i=e.height-s;e.fontSize?e.numLines=i/e.fontSize:(e.numLines||(e.numLines=10),e.fontSize=i/e.numLines);let o=e.numLines*t+s*(e.fontSize/t);this.pixelY=o;let r=o/this.screenHeight;this.pixelX=this.screenWidth*r,this.pixelX*this.relativeScrollBarWidth<=30&&(this.relativeScrollBarWidth=30/this.pixelX),this.width(this.pixelX*(1-(this.showsScrollbar?this.relativeScrollBarWidth:0))),this.lineHeight=t}resetMeasurer(){this.defaultMeasurer=new Measurer}layout(){(void 0===this.lastFontLoadedTimeChecked||this.lastFontLoadedTimeChecked<g)&&(this.resetMeasurer(),this.lastFontLoadedTimeChecked=g);let e,t=this.options||{},s=t.singleLine?Number.MAX_VALUE:this._width,i=this.margins.left+this.margins.right,o=this.margins.top+this.margins.bottom,[r,a]=(new Wrap).wrap(this.doc.runs,s,this.defaultMeasurer,this.doc.defaultFont,this.doc.defaultSize,this.options.margins);if(this.lines=r,this.words=a,this.hasLastEnter=!1,this.lines.length-2>=0){let e=this.lines[this.lines.length-2],t=e[e.length-1];this.hasLastEnter=isNewline(t.text)}e=t.singleLine?r[0][r[0].length-1]:r[r.length-1][0],t.autoResize?(this.newWidth=e.left+e.width+i,this.newHeight=e.top+e.height+o,this.docHeight=e.top+e.height):this.docHeight=e.top+e.height}visibleBounds(){let e=this.docHeight;return{left:this.scrollLeft*this.pixelX,top:this.scrollTop*e,width:this.pixelX,height:this.pixelY}}visibleTextBounds(){let e=this.visibleBounds(),t=e.width*(1-(this.showsScrollbar?this.relativeScrollBarWidth:0)),s=e.height;return{l:e.left,t:e.top,w:t,h:e.height,b:e.top+s,r:e.left+t}}draw(e,t){let{left:s,top:i,width:o,height:r}=t;this.words.forEach((t=>{if(!(t.left+t.width<s||t.top>i+r||t.top+t.height<i||t.left>s+o))if(t.styles){let s=t.left;t.styles.forEach((i=>{e.fillStyle=i.style?i.style:{color:"black"},e.fillText(t.text.slice(i.start,i.end),s,t.top+t.ascent),s+=i.width}))}else e.fillStyle=t.style||"black",e.fillText(t.text,t.left,t.top+t.ascent)}))}drawSelections(e){e.save();for(let t in this.doc.selections){let s=this.doc.selections[t];if(s.end===s.start){e.fillStyle="barSelection "+s.color;let t=this.barRect(s);e.fillRect(t.left,t.top,t.width,t.height)}else{e.fillStyle="boxSelection "+s.color,this.selectionRects(s).forEach((t=>{e.fillRect(t.left,t.top,t.width,t.height)}))}}e.restore()}drawScrollbar(e){let{l:t,t:s,h:i,w:o}=this.scrollbarBounds();e.save(),e.fillStyle="scrollBar",e.fillRect(t,0,o,this.pixelY),e.fillStyle="scrollKnob",e.fillRect(t+3,s,o-6,i),e.restore()}scrollbarBounds(){let{pixelX:e,pixelY:t,scrollTop:s,relativeScrollBarWidth:i}=this,o=t/this.docHeight,r=e*(this.showsScrollbar?i:0),a=t/100*5;return{l:e-r,t:s*t,w:r,h:o>1?t-3:Math.max(a,t*o-6)}}scrollBy(e,t){this.setScroll(this.scrollLeft=e,this.scrollTop+t)}setScroll(e,t){let{pixelY:s,docHeight:i}=this,o=1-s/i;this.scrollTop=Math.max(0,Math.min(o,t))}findLine(e,t,s){let i=this.lines;if(void 0!==t&&void 0!==s){let e=i.findIndex((e=>{let t=e.reduce(((e,t)=>Math.max(e,t.height)),0),i=e[0];return i.top<=s&&s<i.top+t}));return e<0&&(e=i.length-1),[i[e],e]}let o=i.findIndex((t=>{let s=t[0],i=t[t.length-1];return s.start<=e&&e<i.end}));return o<0&&(o=i.length-1),[i[o],o]}findWord(e,t,s){if(void 0!==t&&void 0!==s){let[i,o]=this.findLine(e,t,s),r=i.findIndex((e=>e.left<=t&&t<e.left+e.width));return r<0&&(r=t<i[0].left?0:i.length-1),i[r]}let[i,o]=this.findLine(e,t,s),r=i.findIndex((t=>t.start<=e&&e<t.end));return r<0&&(r=t<i[0].left?0:i.length-1),i[r]}insert(e,t){let s=Event.insert(e,t,this.timezone);this.events.push(s)}delete(e,t){let s=Event.delete(e,t,this.timezone);this.events.push(s)}select(e,t,s,i){let o=Event.select(e,t,s,i,this.timezone);this.lastSelect={start:t,end:s},this.events.push(o)}setStyle(e,t,s){let i=Event.setStyle(e,t,s);this.events.push(i)}doEvent(e){this.doc.doEvent(e),this.layout()}positionFromIndex(e){let t=this.findWord(e);if(0===e&&t.text===c){let e=this.margins||{};return{left:0+(e.left||0),top:0+(e.top||0),width:0,height:t.height}}let s=e-t.start,i={...t};i.text=t.text.slice(0,s);let o=this.defaultMeasurer.measureText(i,this.doc.defaultFont,this.doc.defaultSize);i.text=t.text.slice(0,s+1);let r=this.defaultMeasurer.measureText(i,this.doc.defaultFont,this.doc.defaultSize);return{left:t.left+o.width,top:t.top,width:r.width-o.width,height:t.height}}indexFromPosition(e,t){let s=this.findWord(null,e,t),i=0,o=e-s.left;if(o<0)return s.start;if(s.text===c)return s.start;if(isNewline(s.text))return s.start;let r={...s};for(let e=0;e<=s.text.length;e++){let t;r.text=s.text.slice(0,0!==e?e:1),t=this.defaultMeasurer.measureText(r,this.doc.defaultFont,this.doc.defaultSize);let a=(t.width-i)/2;if(i<=o&&o<i+a)return s.start+(0===e?0:e-1);if(i+a<=o&&o<t.width)return s.start+e;i=t.width}return s.end}isBol(e,t){let[s,i]=this.findLine(null,e,t),o=s[0];if(e<o.left)return!0;if(o.text===c)return this.hasLastEnter;let r={...o};r.text=o.text.slice(0,1);let a=this.defaultMeasurer.measureText(r,this.doc.defaultFont,this.doc.defaultSize).width/2;return e-o.left<a}changeLine(e,t,s){let[i,o]=this.findLine(t);if(s>0&&o===this.lines.length-2)return this.hasLastEnter?this.lines[this.lines.length-1][0].start:t;let r=this.positionFromIndex(t),a=o+s;if(a<0)return 0;if(a>=this.lines.length)return this.lines[this.lines.length-1][0].start;let n=this.lines[a];return 1!==n.length||1!==n[0].text.length||"\n"!==n[0].text&&"\r"!==n[0].text?this.indexFromPosition(r.left,n[0].top):n[0].start}lineHeightAt(e){if(0===this.doc.length())return this.defaultMeasurer.measureText({text:"x"},this.doc.defaultFont,this.doc.defaultSize).height;let[t,s]=this.findLine(e);return t.reduce(((e,t)=>Math.max(t.height,e)),0)}barRect(e){let t=e.start;if(0===t){let e=this.positionFromIndex(t),s=this.lineHeightAt(t);return{left:e.left-1,top:e.top,width:2,height:s}}if(t===this.doc.length()){if(e.isBol){let e=this.positionFromIndex(t),s=this.lineHeightAt(t);return{left:e.left-1,top:e.top,width:2,height:s}}let[s,i]=this.findLine(t-1);t=s[s.length-1].end-1;let o=this.positionFromIndex(t),r=this.lineHeightAt(t);return{left:o.left+o.width-1,top:o.top,width:2,height:r}}let s=this.positionFromIndex(t),i=this.lineHeightAt(t);return e.isBol,{left:s.left-1,top:s.top,width:2,height:i}}selectionRects(e){let{start:t,end:s}=e,[i,o]=this.findLine(t),[r,a]=this.findLine(s);if(void 0===i||void 0===r)return[];if(o===a){let e=this.positionFromIndex(t),i=this.positionFromIndex(s),o=this.lineHeightAt(t);return[{left:e.left,top:e.top,width:i.left-e.left,height:o}]}let n,l,h=[],d=this.positionFromIndex(t),c=this.lineHeightAt(t);if(s===this.doc.length()){let e=this.findWord(s-1);if(isNewline(e.text[e.length-1])){s--;let[e,t]=this.findLine(s);r=e,a=t}}let u=this.options.margins.right+this.options.margins.left;return n=this.positionFromIndex(s),l=this.lineHeightAt(s),h.push({left:d.left,top:d.top,width:this.width()-d.left-u,height:c}),a-o>=2&&(d=this.lines[o+1][0],h.push({left:this.options.margins.left,top:d.top,width:this.width()-u,height:n.top-d.top})),d=this.lines[a][0],l=this.lineHeightAt(s),h.push({left:this.options.margins.left,top:n.top,width:n.left-this.options.margins.left,height:l}),h}isScrollbarClick(e,t){if(!this.showsScrollbar)return!1;let s=this.relativeScrollBarWidth*this.pixelX;return e>=this.pixelX-s-3}mouseDown(e,t,s,i){if(this.isScrollbarClick(e,t))this.scrollBarClick={type:"clicked",scrollBarVOffset:t-this.scrollbarBounds().t,scrollBarTopOnDown:this.scrollTop,realStartY:s,startX:e,startY:t};else{let s=this.indexFromPosition(e,t),o=this.isBol(e,t);this.extendingSelection=null,this.selectDragStart=s,this.select(i,s,s,o)}this.keyboardX=null}mouseMove(e,t,s,i){if(null!==this.selectDragStart){let s,o,r=this.indexFromPosition(e,t);if(r||0===r){this.focusChar=r,this.selectDragStart>r?(this.extendingSelection="top",s=r,o=this.selectDragStart):(this.extendingSelection="bottom",s=this.selectDragStart,o=r);let e=this.lastSelect;if(e&&(e.start!==s||e.end!==o))return this.select(i,s,o),"selectionChanged"}return null}if(this.scrollBarClick){let{realStartY:e,scrollBarTopOnDown:t}=this.scrollBarClick,i=this.docHeight,o=(s-e)*Math.max(1,i/this.pixelY)/i+t;return this.scrollBarClick.type="move",this.setScroll(0,o),"scrollChanged"}return null}mouseUp(e,t,s,i){this.scrollBarClick?(this.scrollBarClick.type,this.scrollBarClick=null,this.wasScrollBarClick=!0):this.wasScrollBarClick=!1,this.selectDragStart=null,this.keyboardX=null,this.lastSelect=null}backspace(e){this.delete(e,!0)}handleKey(e,t,s,i){let o,r,a=this.doc.selections[e.id]||{start:0,end:0,color:e.color},{start:n,end:l,isBol:h}=a,d=this.doc.length(),c=!1;if(s){if(!this.keyboardSelect)switch(t){case 37:case 38:case 36:case 33:this.keyboardSelect=-1;break;case 39:case 40:case 35:case 34:this.keyboardSelect=1}}else this.keyboardSelect=0;let u,p=1===this.keyboardSelect?l:n,f=p,m=!1;switch(t){case 37:s||n===l?p>0&&p--:p=n,h=!1,m=!0;break;case 39:if(s||n===l){if(p<d){let[e,t]=this.findLine(p);o=e,r=t,p++}}else p=l;m=!0;break;case 40:{let[t,s]=this.findLine(p);o=t,r=s,p=this.changeLine(e,p,1),u=f===p,m=!0}break;case 38:p=this.changeLine(e,p,-1),h=!1,m=!0;break;case 8:case 46:this.backspace(e),c=!0}if(m){switch(this.keyboardSelect){case 0:n=l=p;break;case-1:n=p;break;case 1:l=p}if(n===l&&(this.keyboardSelect=0),n>l){this.keyboardSelect=-this.keyboardSelect;let e=l;l=n,n=e}let t;if(o){let[e,s]=this.findLine(p);t=s,h=r!==t&&this.hasLastEnter||u}this.select(e,n,l,h),c=!0}if(i&&65===t)this.select(e,0,d),window.editor=this,c=!0;return c}selectionText(e){let t=this.doc.selections[e.id];return t?this.doc.plainText(t.start,t.end):""}}class Event{static insert(e,t,s){return{type:"insert",user:e,runs:t,length:runLength(t),timezone:s}}static delete(e,t,s){return{type:"delete",backspace:t,user:e,timezone:s}}static select(e,t,s,i,o){return{type:"select",user:e,start:t,end:s,isBol:i,timezone:o}}static setStyle(e,t,s){return{type:"setStyle",user:e,style:t,merge:s}}}const y=new((0,r.y7)(o.THREE))({font:d});class KeyFocusManager extends i.ViewService{constructor(e){super(e||"KeyFocusManager"),this.setKeyboardInput(null),this.hiddenInput=document.querySelector("#hiddenInput"),this.copyElement=document.querySelector("#copyElement"),this.hiddenInput||(this.hiddenInput=document.createElement("input"),this.hiddenInput.id="hiddenInput",this.hiddenInput.style.setProperty("position","absolute"),this.hiddenInput.style.setProperty("left","-120px"),this.hiddenInput.style.setProperty("top","-120px"),this.hiddenInput.style.setProperty("transform","scale(0)"),this.hiddenInput.style.setProperty("width","100px"),this.hiddenInput.style.setProperty("height","100px"),document.body.appendChild(this.hiddenInput),this.hiddenInput.addEventListener("input",(e=>{e.stopPropagation(),this.keyboardInput&&this.keyboardInput.input(e)}),!0),this.hiddenInput.addEventListener("keydown",(e=>{e.stopPropagation(),this.keyboardInput&&this.keyboardInput.keyDown(e)}),!0),this.hiddenInput.addEventListener("copy",(e=>{this.keyboardInput&&this.keyboardInput.copy(e)})),this.hiddenInput.addEventListener("paste",(e=>{this.keyboardInput&&this.keyboardInput.paste(e)}))),this.copyElement||(this.copyElement=document.createElement("input"),this.copyElement.id="copyElement",this.copyElement.style.setProperty("position","absolute"),this.copyElement.style.setProperty("left","-120px"),this.copyElement.style.setProperty("top","-120px"),this.copyElement.style.setProperty("transform","scale(0)"),this.copyElement.style.setProperty("width","100px"),this.copyElement.style.setProperty("height","100px"),document.body.appendChild(this.copyElement))}setKeyboardInput(e){this.hiddenInput&&!e&&this.hiddenInput.blur(),this.keyboardInput=e,e&&setTimeout((()=>this.hiddenInput.focus()),0)}destroy(){this.keyboardInput=null,this.hiddenInput=document.querySelector("#hiddenInput"),this.hiddenInput&&this.hiddenInput.remove(),super.destroy()}}class SyncedStateManager extends i.ViewService{constructor(e){super(e||"SyncedStateManager"),this.isSynced=!1,this.subscribe(this.viewId,"synced","synced")}synced(e){console.log("synced manager",e),this.isSynced=e}}class FontModelManager extends i.ModelService{static defaultFont(){return"Roboto"}init(e){super.init(e||"FontModelManager"),this.fonts=new Map;let{chars:t,common:s,info:i,kernings:o,pages:r}=d;this.askFont({name:i.face,font:{chars:t,common:s,info:i,kernings:o,pages:r}}),this.subscribe(this.id,"askFont",this.askFont),this.loading=new Map,this.subscribe(this.id,"fontLoadStart","fontLoadStart"),this.subscribe(this.id,"fontLoadOne","fontLoadOne"),this.subscribe(this.id,"fontLoadDone","fontLoadDone")}get(e){return this.fonts.get(e)}keys(){return this.fonts.keys()}askFont(e){e.font&&this.fonts.set(e.name,e.font),this.publish(this.id,"fontAsked",e.name)}fontLoadStart({key:e,name:t}){this.loading.set(e,{name:t,array:[]})}fontLoadOne({key:e,buf:t}){let s=this.loading.get(e);s?s.array.push(t):console.log("inconsistent message")}fontLoadDone(e){let t=this.loading.get(e);if(!t)return void console.log("inconsistent message");let s=t.array,i=s.reduce(((e,t)=>e+t.length),0),o=new Uint8Array(i),r=0;for(let e=0;e<s.length;e++)o.set(s[e],r),r+=s[e].length;let a=new TextDecoder("utf-8").decode(o),n=JSON.parse(a);this.askFont({name:t.name,font:n}),this.loading.delete(e)}}FontModelManager.register("FontModelManager");class FontViewManager extends i.ViewService{constructor(e,t){super(t||"FontViewManager"),this.fonts=new Map,this.isLoading={},this.fudgeFactors=new Map,this.fudgeFactors.set("Roboto",{yoffset:30})}setModel(e){this.model=e;for(let[e,t]of this.model.fonts.entries())this.askFont(e,t)}get(e){return this.fonts.get(e)}askFont(e,t){if(this.fonts.get(e))return Promise.resolve(this.fonts.get(e));if(this.isLoading[e])return this.isLoading[e];let s=(window.microverseDir?window.microverseDir:"./")+"assets/fonts",i=`${s}/${e}.png`;return this.isLoading[e]=t?Promise.resolve(t):new Promise(((t,i)=>{l()(`${s}/${e}.json`,((e,s)=>{e&&i(e),t(s)}))})),this.isLoading[e]=this.isLoading[e].then((t=>{let s=new o.THREE.TextureLoader;return new Promise(((a,n)=>{s.load(i,(s=>{let i=new r.sP,n=t.common?t.common.scaleW:t.atlas.width,l=t.common?t.common.scaleH:t.atlas.height,h=new Image(n,l),d=document.createElement("canvas");d.width=n,d.height=l;let c=d.getContext("2d");c.drawImage(s.image,0,0);let u=c.getImageData(0,0,d.width,d.height),p=i.process(t,u.data);c.putImageData(p,0,0);let f=new o.THREE.Texture(p);f.minFilter=o.THREE.LinearMipMapLinearFilter,f.magFilter=o.THREE.LinearFilter,f.generateMipmaps=!0,f.anisotropy=1,h.src=d.toDataURL("image/png"),h.onload=()=>{f.needsUpdate=!0},this.fonts.set(e,{font:t,texture:f}),delete this.isLoading[e],(this.model.fonts.get(e)?null:t)?this.sendLargeFont(e,t):this.publish(this.model.id,"askFont",{name:e}),a(this.fonts.get(e))}),null,(()=>{this.isLoading[e]=!1,n(new Error(`failed to load font: ${e}`))}))}))})),this.isLoading[e]}sendLargeFont(e,t){let s=JSON.stringify(t),i=(new TextEncoder).encode(s),o=0,r=Math.random();for(this.publish(this.model.id,"fontLoadStart",{key:r,name:e});o<i.length;){let e=i.slice(o,o+2880);this.publish(this.model.id,"fontLoadOne",{key:r,buf:e}),o+=2880}this.publish(this.model.id,"fontLoadDone",r)}destroy(){this.fonts.forEach(((e,t)=>{e.material&&(e.material.dispose(),e.material=null)}))}}class TextFieldActor extends a.Z4{init(e){this.fonts=this.service("FontModelManager"),this.doc=new Doc({defaultFont:this.fonts.constructor.defaultFont(),defaultSize:10}),this.doc.load(e.runs||[]),this.content={runs:[],selections:{},undoStacks:{},timezone:0,queue:[],editable:!0},e.textScale||(e.textScale=.0025),super.init(e),this.subscribe(this.id,"load","loadAndReset"),this.subscribe(this.id,"editEvents","receiveEditEvents"),this.subscribe(this.id,"accept","publishAccept"),this.subscribe(this.id,"undoRequest","undoRequest"),this.subscribe(this.id,"setExtent","setExtent"),this.subscribe(this.sessionId,"view-exit","viewExit"),this.listen("dismiss","dismiss");let t=e.width/e.textScale,s=e.height/e.textScale;if(this.setExtent({width:t,height:s}),this.depth=e.depth||0,e.noDismissButton||this.setupDismissButton(),e.scrollBar&&this.setupScrollBar(e),e.readOnly){let t=e.margins,s=(t&&void 0!==t.left?t.left:0)+(t&&void 0!==t.right?t.right:0),i=y.measureText(this.value);this.measurement={width:(i.width+s)*e.textScale,height:i.height*e.textScale}}}get pawn(){return TextFieldPawn}static defaultMeasurement(e){return y.measureText(e)}static types(){return{"Warota.Doc":Doc}}load(e){let t;t="string"==typeof e?[{text:e}]:e,this.doc.load(t),this.publishChanged(),this.needsUpdate()}save(){return{runs:this.doc.runs,defaultFont:this.doc.defaultFont,defaultSize:this.doc.defaultSize}}setExtent(e){this.extent=e}loadAndReset(e){let t;t="string"==typeof e?[{text:e}]:e,this.content={runs:t,selections:{},undoStacks:{},timezone:0,queue:[],editable:!0},this.doc.load(t),this.publishAccept(),this.needsUpdate()}receiveEditEvents(e){let[t,s]=this.doc.receiveEditEvents(e,this.content,this.doc);s&&this.publishChanged(),this.needsUpdate()}publishAccept(){this.publish(this.id,"text",{id:this.id,text:this.doc.plainText()})}publishChanged(){this.publish(this.id,"changed",{id:this.id})}viewExit(e){delete this.content.selections[e],this.needsUpdate()}needsUpdate(){this.say("screenUpdate",this.content.timezone)}undoRequest(e){let t,s=this.content.queue;for(let i=s.length-1;i>=0;i--){let o=s[i];if(o.user.id===e.id&&"snapshot"!==o.type&&"select"!==o.type){t=s[i];break}}t&&(this.doc.undoEvent(t,this.content,this.doc),this.needsUpdate())}setDefault(e,t){return this.doc.setDefault(e,t)}styleAt(e){return this.doc.styleAt(e)}updateOptions(e){super.updateOptions(e);let t=e.width/e.textScale,s=e.height/e.textScale;this.setExtent({width:t,height:s}),this.dismissButton&&this.dismissButton.destroy(),e.noDismissButton||this.setupDismissButton(),e.scrollBar&&this.setupScrollBar(e)}get value(){return this.doc.plainText()}set value(e){return this.load(e)}setupDismissButton(){this.dismissButton=DismissButtonActor.create({type:"object",backgroundColor:this._cardData.backgroundColor,parent:this,translation:this.dismissButtonPosition(),noSave:!0,color:2236962}),this.subscribe(this.dismissButton.id,"dismiss","dismiss")}setupScrollBar(e){this.scrollBar&&this.scrollBar.destroy(),e.scrollBar&&(this.scrollBar=TextScrollBarActor.create({type:"object",name:"scroll bar",noSave:!0,parent:this,barColor:e.barColor,knobColor:e.knobColor,barWidth:e.barWidth}))}dismissButtonPosition(){let e=void 0===this._cardData.barWidth?.1:this._cardData.barWidth,t=this._cardData.scrollBar?e:0;return[this._cardData.width/2-.072+t,this._cardData.height/2-.072,.06]}dismiss(){this.destroy()}}TextFieldActor.register("TextFieldActor");class TextFieldPawn extends a.Df{constructor(e){super(e),this.addToLayers("pointer"),this.widgets={},this.setupEditor(),this.setupMesh(),this.fonts=this.service("FontViewManager"),this.listen("fontAsked","fontAsked"),this.listen("screenUpdate","screenUpdate"),this.setupFonts(),this.actor._cardData.readOnly||(this.addEventListener("pointerDown","onPointerDown"),this.addEventListener("pointerMove","onPointerMove"),this.addEventListener("pointerUp","onPointerUp"),this.addEventListener("keyDown","keyDown")),this.subscribe(this.id,"scroll","scroll"),this.listen("cardDataSet","cardDataUpdated"),this.scrollBarRatio=0}destroy(){["geometry","material","textGeometry","textMaterial"].forEach((e=>{this[e]&&this[e].dispose(),this[e]=null})),super.destroy()}textScale(){return this.actor._cardData.textScale}test(){}needsUpdate(){this.screenUpdate(this.warota.timezone)}randomColor(e){return`hsl(${Math.floor(parseInt(e,36)/(36**10/360))}, 40%, 40%)`}cardDataUpdated(e){if(e.o.backgroundColor!==e.v.backgroundColor||e.o.frameColor!==e.v.frameColor||e.o.fullBright!==e.v.fullBright){let{depth:t,backgroundColor:s,frameColor:i,fullBright:o}=e.v;this.material=this.makePlaneMaterial(t,s,i,o),this.plane.material=this.material}}changeMaterial(e,t){let s;if(this.textMaterial&&this.textMaterial.dispose(),!this.fonts.get(e))return;let i=this.fonts.get(e).texture;return this.textMaterial=new o.THREE.RawShaderMaterial((0,r.N8)({map:i,textureSize:i.image.width,side:o.THREE.BackSide,transparent:!0},o.THREE)),t&&(s=new o.THREE.Mesh(this.textGeometry,this.textMaterial),s.name="text"),s}setupFonts(){let e=this.actor.doc.defaultFont;this.fontAsked(e).then((()=>{let e=Array.from(this.actor.fonts.keys()).map((e=>this.fonts.askFont(e)));return Promise.all(e)})).then((()=>{this.warota.resetMeasurer(),this.needsUpdate()}))}setupTextMesh(e,t,s){if(!this.textGeometry){let t=(0,r.aB)(o.THREE);this.textGeometry=new t({defaultColor:new o.THREE.Color(s)}),this.textMesh=this.changeMaterial(e,!0),this.textMesh.renderOrder=123,this.plane.add(this.textMesh)}let i=u.hasLayout(e);if(!i){i=new((0,r.y7)(o.THREE))({font:t}),u.addLayout(e,i)}}updateMesh(e){let{fontName:t,drawnStrings:s}=e;if(!this.fonts.get(t))return;let i=this.fonts.get(t).font,o=this.fonts.fudgeFactors.get(t),r=u.hasLayout(t);if(!r)return;let a=r.computeGlyphs({font:i,drawnStrings:s,fudgeFactor:o});this.textMesh.scale.x=this.textScale(),this.textMesh.scale.y=-this.textScale(),this.textGeometry.update({font:i,glyphs:a})}updateShape(e){super.updateShape(e),["geometry","material","textGeometry","textMaterial"].forEach((e=>{this[e]&&this[e].dispose(),this[e]=null})),this.setupMesh(),this.setupFonts()}setupMesh(){let{depth:e,opacity:t}=this.actor._cardData;void 0===e&&(e=.01);let s=this.actor._cardData.cornerRadius;void 0===s&&(s=.05);let{backgroundColor:i,frameColor:r,fullBright:a}=this.actor._cardData;i||(i=16777215),r||(r=6710886),void 0===a&&(a=!1),this.geometry=0===e?new o.THREE.PlaneGeometry(0,0):this.roundedCornerGeometry(0,0,e,s);let n=this.makePlaneMaterial(e,i,r,a);void 0!==t&&1!==t&&(Array.isArray(n)?n:[n]).forEach((e=>{e.transparent=!0,e.opacity=t})),this.material=n,this.plane=new o.THREE.Mesh(this.geometry,this.material),this.plane.castShadow=!0,this.plane.name=this.actor.name,this.shape.add(this.plane),this.clippingPlanes=[new o.THREE.Plane(new o.THREE.Vector3(0,1,0),0),new o.THREE.Plane(new o.THREE.Vector3(0,-1,0),0),new o.THREE.Plane(new o.THREE.Vector3(-1,0,0),0),new o.THREE.Plane(new o.THREE.Vector3(1,0,0),0)]}setupEditor(){let e=this.actor.doc.defaultFont,t=this.actor.doc.defaultSize,s=this.actor.extent,i=this.actor._cardData.autoResize,o=this.actor._cardData.singleLine,r=this.actor._cardData.margins,a={width:s.width,height:s.height,font:e,fontSize:t,autoResize:i,singleLine:o,margins:r};this.warota=new Warota(a,this.actor.doc),this.warota.width(s.width),this.options=a,this.user={id:this.viewId,color:this.randomColor(this.viewId)},this.selections={},this.subscribe(this.viewId,"synced","synced")}fontAsked(e){return this.fonts.askFont(e).then((t=>this.setupTextMesh(e,t.font,this.actor._cardData.color||0))).then((()=>(this.warota.resetMeasurer(),this.screenUpdate(this.warota.timezone))))}computeClippingPlanes(){let e=this.plane.geometry.parameters.height,t=this.plane.geometry.parameters.width,s=[],i=this.plane;if(Number.isNaN(i.matrixWorld.elements[0]))return[];for(let r=0;r<4;r++)s[r]=new o.THREE.Plane,s[r].copy(this.clippingPlanes[r]),s[r].constant=r<2?e/2:t/2,s[r].applyMatrix4(i.matrixWorld);return s._width=t,s._height=e,s}setWidth(e){this.publish(this.actor.id,"setWidth",e),this.width(e)}width(e){this.warota.width(e),this.screenUpdate(this.warota.timezone)}synced(e){this.isSynced=e,this.isSynced&&(this.warota.resetMeasurer(),this.screenUpdate(this.warota.timezone))}getSynced(){let e=this.service("SyncedStateManager");return e?e.isSynced:this.isSynced}accept(){this.publish(this.actor.id,"accept")}cookEvent(e){if(!e.xyz)return;let t=new o.THREE.Vector3(...e.xyz),s=this.renderObject.matrixWorld.clone().invert(),i=t.applyMatrix4(s),r=this.plane.geometry.parameters.width,a=this.plane.geometry.parameters.height;return{x:(r/2+i.x)/this.textScale(),y:(a/2-i.y+this.getScrollTop(a))/this.textScale()}}onPointerDown(e){if(this.actor._cardData.readOnly)return;this.service("KeyFocusManager").setKeyboardInput(this);let t=this.cookEvent(e);t&&this.warota.mouseDown(t.x,t.y,t.y,this.user)}onPointerMove(e){if(this.actor._cardData.readOnly)return;let t=this.cookEvent(e);t&&(this.warota.mouseMove(Math.max(t.x,0),t.y,t.y,this.user),this.changed())}onPointerUp(e){if(this.actor._cardData.readOnly)return;let t=this.cookEvent(e);t&&(this.warota.mouseUp(t.x,t.y,t.y,this.user),this.changed())}newCanonicalizeEvent(e){if("input"===e.type&&"insertText"===e.inputType&&!e.isComposing){let t=this.service("KeyFocusManager"),s=t.hiddenInput.value;return t.hiddenInput.value="",{keyCombo:"",key:s,shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:e.type,keyCode:e.keyCode}}return null}eventFromField(){let e=this.service("KeyFocusManager"),t=e.hiddenInput.value;return e.hiddenInput.value="",{keyCombo:"",key:t,shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:"",keyCode:0}}simpleInput(e,t){let s=this.user,i=this.actor.content.selections[this.viewId],o=this.actor.styleAt(Math.max(i?i.start-1:0,0));return this.warota.insert(s,[{text:e,style:o}]),this.changed(!0),t.preventDefault(),!0}input(e){if(this.actor._cardData.readOnly)return;let t=this.newCanonicalizeEvent(e);if(!t)return!1;let s=this.user,i=this.actor.content.selections[this.viewId],o=this.actor.styleAt(Math.max(i?i.start-1:0,0));return this.warota.insert(s,[{text:t.key,style:o}]),this.changed(!0),e.preventDefault(),!0}keyDown(e){let t;if("Enter"===e.key){let s=this.service("KeyFocusManager").hiddenInput;""!==s.value?(s.value="",t=this.eventFromField()):t=canonicalizeKeyboardEvent(e)}else t=canonicalizeKeyboardEvent(e);let s=this.user;if(!t)return!0;if(t.onlyModifiers)return!0;if(["Meta-S","Ctrl-S","Alt-S"].includes(t.keyCombo))return this.accept(),e.preventDefault(),!0;if(["Meta-Z","Ctrl-Z","Alt-Z"].includes(t.keyCombo))return this.undo(),e.preventDefault(),!0;if(["Meta-C","Ctrl-C","Alt-C"].includes(t.keyCombo))return this.copy(),e.preventDefault(),!0;if(["Meta-X","Ctrl-X","Alt-X"].includes(t.keyCombo))return this.cut(),e.preventDefault(),!0;if(["Meta-V","Ctrl-V","Alt-V"].includes(t.keyCombo))return this.paste(),e.preventDefault(),!0;if(13===t.keyCode)return this.actor.enterToAccept?(e.preventDefault(),this.accept(),!0):this.simpleInput("\n",e);if(32===t.keyCode)return this.simpleInput(" ",e);if(9===t.keyCode)return this.simpleInput("\t",e);const i=this.warota.handleKey(s,t.keyCode,t.shiftKey,t.ctrlKey||t.metaKey);return i||t.ctrlKey||t.metaKey?(i&&(e.preventDefault(),this.changed(!0)),!1):(this.warota.insert(s,[{text:t.key}]),this.changed(!0),e.preventDefault(),!0)}copy(e){let t=navigator.userAgent.match(/ipad|iphone/i),s=this.warota.selectionText(this.user);(navigator.clipboard?navigator.clipboard.writeText(s).then((()=>!0),(()=>!1)):Promise.resolve(!1)).then((e=>{if(!e){let{copyElement:e}=this.service("KeyFocusManager");if(!t)return e.value=s,e.select(),e.setSelectionRange(0,99999),void document.execCommand("copy");let i=document.createRange();i.selectNodeContents(e),e.textContent=s;let o=window.getSelection();o.removeAllRanges(),o.addRange(i),e.setSelectionRange(0,1e5),document.execCommand("copy")}}))}cut(e){return this.copy(e),this.warota.insert(this.user,[{text:""}]),this.changed(!0),!0}paste(e){return(navigator.clipboard?navigator.clipboard.readText().then((e=>e),(()=>null)):Promise.resolve(null)).then((e=>{if(null===e){let{copyElement:e}=this.service("KeyFocusManager");return e.focus(),e.textContent="",document.execCommand("paste"),e.textContent}return e})).then((e=>{this.warota.insert(this.user,[{text:e}]),this.changed(!0)}))}undo(){this.publish(this.actor.id,"undoRequest",this.user)}changed(e){let t=this.warota.events;this.warota.resetEvents(),t.length>0&&(this.scrollNeeded=!this.singleLine&&e,this.publish(this.actor.id,"editEvents",t))}screenUpdate(e){this.warota.timezone=e,this.getSynced()&&(this.warota.layout(),this.showText(),this.setExtent(),this.showSelections(),this.scrollNeeded&&(this.scrollNeeded=!1))}showText(){let e=[];for(let t=0;t<this.warota.words.length-1;t++){let s=this.warota.words[t],i={x:s.left,y:s.top,string:s.text,style:s.style&&s.style.color};e.push(i)}let t=this.actor.extent;this.updateMesh({fontName:this.warota.doc.defaultFont,extent:t,drawnStrings:e})}setStyle(e){this.warota.setStyle(this.user,e,!1),this.changed()}mergeStyle(e){this.warota.setStyle(this.user,e,!0),this.changed()}getScrollTop(e){let t=this.warota.docHeight*this.textScale();return t<=e?0:(t-e+.1)*this.scrollBarRatio}setExtent(){let e=this.actor.extent,t=this.actor.depth,s=this.actor._cardData.cornerRadius||.05,i=this.actor._cardData.autoResize;if(!this.textMesh)return;let r=(i?this.warota.newWidth:e.width)*this.textScale(),a=(i?this.warota.docHeight:e.height)*this.textScale();if(r!==this.plane.geometry.parameters.width||a!==this.plane.geometry.parameters.height||t!==this.plane.geometry.parameters.depth){let e=0===t?new o.THREE.PlaneGeometry(r,a):this.roundedCornerGeometry(r,a,t,s);this.plane.geometry=e,this.geometry&&(this.geometry.dispose(),this.geometry=null),this.geometry=e}let n=this.getScrollTop(a);this.textMesh.position.x=-r/2,this.textMesh.position.y=a/2+n,this.textMesh.position.z=t+.005,this.setScrollBarExtent(e,{width:r,height:a});let l={left:0,top:n/this.textScale(),bottom:(a+n)/this.textScale(),right:r/this.textScale()};this.textMesh.material.uniforms.corners.value=new o.THREE.Vector4(l.left,l.top,l.right,l.bottom)}setTextRenderingBounds(e){this.textMesh?.material?.uniforms?.corners&&(this.textMesh.material.uniforms.corners.value=new o.THREE.Vector4(e.left,e.top,e.right,e.bottom))}setScrollBarExtent(e,t){let s=(0,i.GetPawn)(this.actor.scrollBar?.id);if(s){let e=this.plane.geometry.parameters.height,i=this.warota.docHeight*this.textScale(),o=this.getScrollTop(e),r=.1/e;i>e&&(e-=.1);let a=o/i,n=Math.min(e/i,1);n=Math.max(r,n),s.setExtent(t,a,n)}}scroll(e){this.scrollBarRatio=e,this.needsUpdate()}ensureSelection(e){let t=this.selections[e],s=this.actor.content.selections[e].color;if(s||(s="blue"),!t){let e=new o.THREE.Mesh(new o.THREE.PlaneGeometry(.1,.1),new o.THREE.MeshBasicMaterial({color:s}));e.visible=!1,this.plane.add(e),e.name="caret",e.onBeforeRender=()=>this.selectionBeforeRender(e);let i=[];for(let e=0;e<3;e++){let t=new o.THREE.Mesh(new o.THREE.PlaneGeometry(0,0),new o.THREE.MeshBasicMaterial({color:s}));t.visible=!1,t.name=`box${e}`,t.onBeforeRender=()=>this.selectionBeforeRender(t),this.plane.add(t),i.push(t)}t={bar:e,boxes:i}}return this.selections[e]=t,t}selectionBeforeRender(e){e.material.clippingPlanes=this.computeClippingPlanes()}showSelections(){let e=this.actor.depth||0,t={};for(let e in this.selections)t[e]=this.selections[e];let s=this.textScale(),i=this.plane.geometry.parameters.width,r=this.plane.geometry.parameters.height,a=this.getScrollTop(r);for(let n in this.actor.content.selections){delete t[n];let l=this.ensureSelection(n);l.boxes.forEach((e=>e.visible=!1));let h=this.actor.content.selections[n];if(h.end===h.start){let t=l.bar;t.visible=!0;let n=this.warota.barRect(h);n.width=s<=.001?5:2;let d=new o.THREE.PlaneGeometry(n.width*s,n.height*s),c=t.geometry;t.geometry=d,c&&c.dispose();let u=-i/2+(n.left+6)*s,p=r/2-(n.top+n.height/2+4)*s+a;t.position.set(u,p,e+.001)}else{let t=this.warota.selectionRects(h),n=l.boxes;for(let l=0;l<3;l++){let h=n[l],d=t[l];if(h.visible=!1,d){let t=-i/2+(d.width/2+d.left+8)*s,n=r/2-(d.top+d.height/2+4)*s+a,l=d.width*s,c=d.height*s,u=new o.THREE.PlaneGeometry(l,c,2,2);h.geometry=u,h.position.set(t,n,e+.001),h.visible=!0}}}}for(let e in t)this.selections[e].bar.removeFromParent(),this.selections[e].boxes.forEach((e=>e.removeFromParent())),delete this.selections[e];this.publish(this.id,"selectionUpdated")}addWidget(e,t){this.widgets[e]&&this.removeWidget(e,t),this.widgets[e]=t,this.selectionPane.appendChild(t)}removeWidget(e,t){delete this.widgets[e],t.remove()}get hitNormal(){return[0,0,1]}}class DismissButtonActor extends a.Z4{get pawn(){return DismissButtonPawn}}DismissButtonActor.register("DismissButtonActor");class DismissButtonPawn extends a.Df{constructor(e){super(e),this.addToLayers("pointer"),this.back&&(this.shape.remove(this.back),this.shape.children=[]);let t=void 0!==this.actor._cardData.backgroundColor?this.actor._cardData.backgroundColor:13421772,s=void 0!==this.actor._cardData.color?this.actor._cardData.color:2236962,i=new o.THREE.BoxGeometry(.08,.08,1e-5),r=new o.THREE.MeshStandardMaterial({color:t,side:o.THREE.DoubleSide});this.back=new o.THREE.Mesh(i,r);let a=new o.THREE.BoxGeometry(.07,.02,.001),n=new o.THREE.MeshStandardMaterial({color:s,side:o.THREE.DoubleSide}),l=new o.THREE.Mesh(a,n);l.position.set(0,0,1e-5),this.back.add(l),this.shape.add(this.back),this.addEventListener("pointerDown","dismiss")}dismiss(e){this.publish(this.actor.id,"dismiss")}}class TextScrollBarActor extends a.Z4{get pawn(){return TextScrollBarPawn}}TextScrollBarActor.register("TextScrollBarActor");class TextScrollBarPawn extends a.Df{constructor(e){super(e);let t=void 0===e._cardData.barColor?6710886:e._cardData.barColor,s=void 0===e._cardData.knobColor?13421772:e._cardData.knobColor,i=void 0===e._cardData.barWidth?.1:e._cardData.barWidth,r=new o.THREE.PlaneGeometry(i,0),a=new o.THREE.MeshBasicMaterial({color:t,side:o.THREE.DoubleSide});this.scrollMesh=new o.THREE.Mesh(r,a),this.scrollMesh.name="scroll";let n=new o.THREE.PlaneGeometry(i,0),l=new o.THREE.MeshBasicMaterial({color:s,side:o.THREE.DoubleSide});this.scrollKnobMesh=new o.THREE.Mesh(n,l),this.scrollKnobMesh.name="scrollKnob",this.scrollKnobMesh.position.set(0,0,.001),this.scrollMesh.add(this.scrollKnobMesh),this.shape.add(this.scrollMesh),this.addEventListener("pointerDown","pointerDown"),this.addEventListener("pointerMove","pointerMove"),this.addEventListener("pointerUp","pointerUp")}pointerDown(e){this.interactionPlane=new o.THREE.Plane;let t=(0,i.v3_transform)([0,0,1],this.global);this.interactionPlane.setFromNormalAndCoplanarPoint(new o.THREE.Vector3(...t),new o.THREE.Vector3(...e.xyz)),this.getMyAvatar().addFirstResponder("pointerMove",{},this)}pointerMove(e){let t=new o.THREE.Vector3(...e.ray.origin),s=new o.THREE.Vector3(...e.ray.direction),i=new o.THREE.Ray(t,s).intersectPlane(this.interactionPlane,new o.THREE.Vector3),r=this.cookEvent(i.toArray());this.parent&&this.publish(this.parent.id,"scroll",r)}pointerUp(e){this.getMyAvatar().removeFirstResponder("pointerMove",{},this)}cookEvent(e){if(!e)return;let t=new o.THREE.Vector3(...e),s=this.shape.matrixWorld.clone().invert(),i=t.applyMatrix4(s),r=this.scrollMesh.geometry.parameters.height,a=r/2-i.y;return Math.max(Math.min(a/r,1),0)}setExtent(e,t,s){let i=void 0===this.actor._cardData.barWidth?.1:this.actor._cardData.barWidth;if(this.scrollMesh.geometry.parameters.height!==e.height){let t=new o.THREE.PlaneGeometry(i,e.height);this.scrollMesh.geometry.dispose(),this.scrollMesh.geometry=t}let r=e.height*s;if(this.scrollKnobMesh.geometry.parameters.height!==r){let e=new o.THREE.PlaneGeometry(i,r);this.scrollKnobMesh.geometry.dispose(),this.scrollKnobMesh.geometry=e}let a=e.height/2-e.height*t;a-=r/2,this.scrollKnobMesh.position.set(0,a,.0015),this.set({translation:[e.width/2+i/2,0,.001]})}}},8335:(e,t,s)=>{"use strict";s.d(t,{R:()=>WalkManager});var i=s(4200);class WalkManager extends i.ViewService{constructor(e){super(e||"WalkManager"),this.walkers=[]}setupDefaultWalkers(){[["BuiltinWalker","WalkerPawn","checkPortal"],["BuiltinWalker","WalkerPawn","backoutFromFall"],["BuiltinWalker","WalkerPawn","bvh"]].forEach((e=>this.append(e)))}append(e){if(3!==e.length)throw new Error('walker spec should be in the form of "[ModuleName, BehaviorName, methodName]"');this.walkers.push(e)}insertBefore(e,t){if(!t)return this.append(e);let s=this.findIndex(t);if(s>=0){if(3!==e.length)throw new Error('walker spec should be in the form of "[ModuleName, BehaviorName, methodName]"');this.walkers.splice(s,0,e)}}remove(e){let t=this.findIndex(e);t>=0&&this.walkers.splice(t,1)}findIndex(e){return this.walkers.findIndex((t=>t[0]==`${e[0]}$${e[1]}`&&t[2]===e[2]))}removeAll(){this.walkers=[]}walk(e,t,s,i){for(let o=0;o<this.walkers.length;o++){let r=this.walkers[o],a=e.actor.behaviorManager.lookup(r[0],r[1]),[n,l]=a.invoke(e,r[2],t,s,i);if(l)return n;t=n}return t}}},9087:(e,t,s)=>{"use strict";s.d(t,{m:()=>AssetManager});var i=s(3782),o=s(4200);class AssetManager extends o.ViewService{constructor(e){super(e||"AssetManager"),this.assetManager=new i.me}}},3986:(e,t,s)=>{"use strict";s.d(t,{TV:()=>setupWorldMenuButton,_s:()=>updateWorldMenu,aP:()=>hideShellControls,gA:()=>filterDomEventsOn,ts:()=>closeAllDialogs});var i=s(3917);let o=null,r=!1,a=null,n=!!("ontouchstart"in window);function connectFeedback(e){let t=document.getElementById("connectBtn"),s=document.getElementById("connectIcon");e?(t.textContent="Connected",t.classList.add("connected"),s.classList.remove("connect-icon"),s.classList.add("connected-icon")):(t.textContent="Connect",t.classList.remove("connected"),s.classList.add("connect-icon"),s.classList.remove("connected-icon"))}function setMenuItems(e){let t,s=o.querySelector("#worldMenu-gather"),l=s.querySelector("span");e.actor.service("PlayerManager").presentationMode?l.textContent="Stop Gathering":l.textContent="Gather",t=o.querySelector("#worldMenu-qr"),t.onclick=e=>{e.preventDefault(),e.stopPropagation(),e.shiftKey||n?function switchQRView(e){let t=o.querySelector("#qrDiv"),s=o.querySelector("#statsDiv"),i=s.querySelector("#innerDiv").childNodes[1],r="statsHidden";i&&i.classList.add(r),s.style.height="176px",t.classList.contains(r)?(t.classList.toggle(r,!1),s.classList.toggle(r,!0)):(t.classList.toggle(r,!0),s.classList.toggle(r,!1))}():function qrPressed(e,t){let s=document.createElement("div");s.innerHTML=`<a id="link" target="_blank" rel="noopener noreferrer" href="${t}"></a>`,document.getElementById("hud").appendChild(s),s.querySelector("#link").click(),s.remove()}(0,window.location)},t=o.querySelector("#worldMenu-load"),t.onclick=t=>{t.preventDefault(),t.stopPropagation(),function loadPressed(e){if(!a){let t=document.createElement("div");t.innerHTML='<input id="imageinput" type="file" accept="application/json,image/*,.glb,.obj,.fbx,.wrl,.zip,.svg,.vrse,.exr,.pdf,.mp3,.wav">',a=t.firstChild;let getFileType=e=>{let t=e.lastIndexOf(".");return t>=0?e.slice(t+1).toLowerCase():null};a.onchange=()=>{for(const t of a.files){let s=getFileType(t.name);new Promise((e=>{let s=new FileReader;s.onload=()=>e(s.result),s.readAsArrayBuffer(t)})).then((i=>{"vrse"===s?e.loadvrse(i):e.analyzeAndUploadFile(i,t.name,s)}))}a.value=""}}document.getElementById("hud").appendChild(a),a.click(),r&&toggleMenu()}(e)},t=o.querySelector("#worldMenu-connect"),t.onclick=()=>function connectPressed(e){let t=e.service("BehaviorViewManager");t&&t.setURL("ws://localhost:9011",connectFeedback)}(e),t=o.querySelector("#worldMenu-settings"),t&&(t.onclick=()=>function settingsPressed(e){e&&(e.showSettingsMenu(),(0,i.sendToShell)("hud",{joystick:!1,fullscreen:!1})),toggleMenu()}(e)),t=o.querySelector("#worldMenu-shareButton"),t&&(t.onclick=()=>{!function sharePressed(e){e&&(e.showShareMenu(),(0,i.sendToShell)("hud",{joystick:!1,fullscreen:!1})),toggleMenu()}(e)}),t=o.querySelector("#worldMenu-helpButton"),t&&(t.onclick=()=>function helpPressed(e){e&&(e.showHelpMenu(),(0,i.sendToShell)("hud",{joystick:!1,fullscreen:!1})),toggleMenu()}(e)),t=s,t&&(t.onclick=()=>{e.actor.service("PlayerManager").presentationMode?function forceStop(e){e.say("stopPresentation")}(e):e.comeToMe()})}function toggleMenu(e){if(r)return o.classList.remove("menuVisible"),void(r=!1);setMenuItems(e),r=!0,o.classList.add("menuVisible")}function updateWorldMenu(e){r&&setMenuItems(e)}function setupWorldMenuButton(e,t,s){if(!o){let e=document.createElement("div"),i=document.createElement("div");i.id="statsDiv";let a=document.createElement("div");a.id="qrDiv",i.classList.add("statsHidden"),e.appendChild(a),e.appendChild(i),t.root=e,t.badge=!1,t.qrcode=a,t.stats=i,t.makeSessionWidgets(s),a.onclick=null,function initWorldMenu(e){let t=document.createElement("div");t.id="worldMenu",t.classList.add("worldMenu");let s='\n<div id="worldMenu-load" class="menu-label menu-item">\n    <div class="menu-icon import-icon"></div>\n    <span class="menu-label-text">Import</span>\n</div>\n<div id="worldMenu-connect" class="menu-label menu-item">\n    <div class="menu-icon connect-icon" id="connectIcon"></div>\n    <span class="menu-label-text" id="connectBtn">Connect</span>\n</div>\n<div id="worldMenu-gather" class="menu-label menu-item">\n    <div class="menu-icon presentationMode-icon"></div>\n    <span class="menu-label-text">Gather</span>\n</div>\n<div id="worldMenu-shareButton" class="menu-label menu-item">\n    <div class="menu-icon share-icon"></div>\n    <span class="menu-label-text">Invite</span>\n</div>\n<div id="worldMenu-settings" class="menu-label menu-item">\n    <div class="menu-icon settings-icon"></div>\n    <span class="menu-label-text">Settings</span>\n</div>\n<div id="worldMenu-helpButton" class="menu-label menu-item">\n    <div class="menu-icon help-icon"></div>\n    <span class="menu-label-text">Help</span>\n</div>\n'.trim(),i=document.createElement("div");i.innerHTML=s;let a=i.querySelector("#worldMenu-load"),n=i.querySelector("#worldMenu-connect"),l=i.querySelector("#worldMenu-settings"),h=i.querySelector("#worldMenu-shareButton"),d=i.querySelector("#worldMenu-helpButton"),c=i.querySelector("#worldMenu-gather");t.appendChild(e),e.id="worldMenu-qr",e.classList.add("menu-qr","menu-item"),t.appendChild(a),t.appendChild(n),t.appendChild(c),t.appendChild(h),t.appendChild(l),t.appendChild(d),o=t,filterDomEventsOn(o),r=!1,document.getElementById("hud").appendChild(o)}(e)}let i=document.querySelector("#worldMenuBtn");i.onclick=()=>toggleMenu(e),filterDomEventsOn(i)}function filterDomEventsOn(e){e.onpointerdown=e=>e.stopPropagation(),e.onpointerup=e=>e.stopPropagation(),e.onpointermove=e=>e.stopPropagation(),e.onwheel=e=>e.stopPropagation()}function closeAllDialogs(){document.querySelectorAll(".dialogPanel").forEach((e=>e.remove())),(0,i.sendToShell)("hud",{joystick:!0,fullscreen:!0});let e=document.querySelector("#homeBtn");e&&(e.style.display="flex")}function hideShellControls(){(0,i.sendToShell)("hud",{joystick:!1,fullscreen:!1});let e=document.querySelector("#homeBtn");e&&(e.style.display="none")}!function loadCSS(){return document.head.querySelector("#settings-css")?Promise.resolve(!0):new Promise(((e,t)=>{let s=window.microverseDir?window.microverseDir:"./",i=document.createElement("link");i.rel="stylesheet",i.type="text/css",i.id="settings-css",i.href=s+"assets/css/settings.css",i.onload=e,i.onerror=t,document.head.appendChild(i)}))}()},4072:(e,t,s)=>{"use strict";s.d(t,{H:()=>WorldSaver});var i=s(3654);s(4200);class WorldSaver{constructor(e){this.map=new Map,this.id=0,this.defaultClass=e}newId(){return(++this.id).toString().padStart(4,"0")}save(e){let t=[];for(let[s,i]of e.service("ActorManager").actors)i.isCard&&!i.noSave&&t.push(i);let s=this.topologicalSort(t),i=this.collectData(s);return{behaviorModules:e.service("BehaviorModelManager").save(),cards:i}}topologicalSort(e){let t=new Map,s=[...e],i=new Map;for(;s.length>0;){let e=s.shift();if(!e._parent||t.get(e._parent.id))t.set(e.id,e);else{if(i.get(e))throw new Error("actors make a cycle");s.push(e),i.set(e,!0)}}return t}collectData(e){let t=[];for(let[s,i]of e){let e={id:this.newId()};this.map.set(i,e);let s=this.collectCardData(i);e.card=s,t.push(e)}return t}collectCardData(e,t){let s={};if(e.constructor!==this.defaultClass&&(s.className=e.constructor.name),i.Wh.forEach((i=>{if(e[`_${i}`])if("parent"===i)if(t){let t=e[i];if(!t)throw new Error("undefined parent used");s[i]=t.id}else{let t=this.map.get(e[i]);if(!t)throw new Error("undefined parent used");s[i]=t.id}else s[i]=e[`_${i}`]})),e._cardData){let t=Object.keys(e._cardData);t.sort(),t.forEach((t=>{s[t]=e._cardData[t]}))}return s}stringifyInner(e,t){if(void 0===e)return;if("number"==typeof e)return Number.isFinite(e)?`${e}`:"null";if("object"!=typeof e)return JSON.stringify(e);let s;if(Array.isArray(e)){s="[";for(let i=0;i<e.length;i++)i>0&&(s+=","),s+=this.stringifyInner(e[i],t)||"null";return s+"]"}if(null===e)return"null";if(t.has(e))throw new TypeError("Converting circular structure to JSON");if(t.add(e),e.constructor===window.Map){let s={__map:!0,values:[...e]};return this.stringifyInner(s,t)}let i=Object.keys(e).sort();s="";for(let o=0;o<i.length;o++){let r=i[o],a=this.stringifyInner(e[r],t,s);a&&(""!==s&&(s+=","),s+=JSON.stringify(r)+":"+a)}return t.delete(e),"{"+s+"}"}stringify(e){let t=new Set;return this.stringifyInner(e,t)}parse(e){return JSON.parse(e,((e,t)=>"object"==typeof t&&null!==t&&t.__map?new Map(t.values):t))}}},3700:()=>{}}]);