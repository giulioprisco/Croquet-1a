(globalThis.webpackChunk_croquet_microverse=globalThis.webpackChunk_croquet_microverse||[]).push([[506],{1478:(e,t,r)=>{"use strict";r.d(t,{startShell:()=>startShell});var a=r(4200);const s="croquet:microverse:";let o;const{searchParams:i}=new URL(window.location),n=i.has("showSettings"),l=i.has("voiceChat"),c=l||n;let m=(c?function loadLocalStorage(){if(!window.localStorage)return null;try{let e=JSON.parse(window.localStorage.getItem("microverse-settings"));if(!e||"1"!==e.version)throw new Error("different version of data");return e}catch(e){return null}}():null)||{};function startShell(){o=new Shell}m.voice=l,m.showSettings=c;class Shell{constructor(){const e=shellToCanonicalURL(location.href);e!==location.href&&(console.log("shell: redirecting to canonical URL",e),location.href=e),this.frames=new Map,this.portalData=new Map,this.awaitedFrameTypes={},this.awaitedRenders={},a.App.autoSession(),a.App.autoPassword();const t=this.primaryFrameId=this.addFrame(null,a.App.sessionURL),r=frameToPortalURL(this.primaryFrame.src);window.history.replaceState({portalId:t},null,r),setTitle(r);document.getElementById("hud").remove();if(document.getElementById("shell-hud").classList.toggle("is-shell",!0),window.addEventListener("message",(e=>{if(e.data?.message?.startsWith?.(s)){const t=e.data.message.substring(19);for(const[r,{frame:a}]of this.frames)if(e.source===a.contentWindow)return void this.receiveFromPortal(r,a,t,e.data);console.warn(`shell: ignoring ${t} from removed frame`)}})),window.addEventListener("popstate",(e=>{let{portalId:t}=e.state,r=this.frameEntry(t)?.frame;if(!r){const e=frameToPortalURL(shellToCanonicalURL(location.href));for(const[a,{frame:s}]of this.frames)if(frameToPortalURL(s.src)===e){r=s,t=a;break}}r||location.reload();const a=frameToPortalURL(r.src);a===shellToCanonicalURL(location.href)?(this.activateFrame(t,!1),setTitle(a)):console.warn(`shell: popstate location=${location}\ndoes not match portal-${t} frame.src=${r.src}`)})),this.fullscreenBtn=document.getElementById("fullscreenBtn"),this.fullscreenBtn&&(this.fullscreenBtn.onclick=e=>{e.stopPropagation(),e.preventDefault(),e.shiftKey?document.body.classList.toggle("tilt"):document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.body.requestFullscreen()}),this.capturedPointers={},this.joystick=document.getElementById("joystick"),this.knob=document.getElementById("knob"),this.trackingknob=document.getElementById("trackingknob"),this.adjustJoystickKnob(),window.onresize=()=>this.adjustJoystickKnob(),!document.head.querySelector("#joystick-css")){let e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.id="joystick-css",e.onload=()=>{this.adjustJoystickKnob(),this._hudFlags&&(this.setButtonsVisibility(this._hudFlags),delete this._hudFlags)};let t=window.microverseDir?window.microverseDir:"./";e.href=t+"assets/css/joystick.css",document.head.appendChild(e)}this.releaseHandler=e=>{for(let e in this.capturedPointers)this.joystick.releasePointerCapture(e);this.capturedPointers={},this.endMMotion(e)},this.joystick.onpointerdown=e=>{void 0!==e.pointerId&&(this.capturedPointers[e.pointerId]="hiddenKnob",this.joystick.setPointerCapture(e.pointerId)),this.startMMotion(e)},this.joystick.onpointermove=e=>this.updateMMotion(e),this.joystick.onpointerup=e=>this.releaseHandler(e),this.joystick.onpointercancel=e=>this.releaseHandler(e),this.joystick.onlostpointercapture=e=>this.releaseHandler(e)}adjustJoystickKnob(){let e=window.getComputedStyle(this.joystick),t=window.getComputedStyle(this.knob),r=(parseFloat(e.width)||120)/2,a=(parseFloat(t.width)||60)/2,s=r-a;this.joystickLayout={center:r,radius:s},this.trackingknob.style.transform="translate(0px, 0px)",this.knob.style.transform=`translate(${r-a}px, ${r-a}px)`}frameEntry(e){return this.frames.get(e)}frameFromId(e){return this.frameEntry(e)?.frame}portalId(e){for(const[t,{frame:r}]of this.frames)if(r===e)return t;return null}get primaryFrame(){return this.frameFromId(this.primaryFrameId)}addFrame(e,t){if(this.frames.size>=4)throw Error("shell: refusing to create more than 4 frames (this indicates a portal bug)");let r;do{r=Math.random().toString(36).substring(2,15)}while(this.frames.has(r));const a=document.createElement("iframe");a.src=portalToFrameURL(t,r),a.style.zIndex=-this.frames.size,a.style.setProperty("--tilt-z",-200*this.frames.size+"px");const s={frame:a,owningFrame:e,ownedFrames:new Set};return e&&this.frameEntry(e)?.ownedFrames.add(r),this.frames.set(r,s),document.body.appendChild(a),this.sendFrameType(r),r}removeFrame(e){const t=this.frameEntry(e);if(!t)return;const{frame:r,owningFrame:a,ownedFrames:s}=t;if(a&&(this.frameEntry(a)?.ownedFrames.delete(e),t.owningFrame=null),r!==this.primaryFrame){console.log(`shell: removing frame ${e}`),r.remove(),this.frames.delete(e);for(const e of s.values())this.removeFrame(e);this.sortFrames(this.primaryFrame)}else console.log(`shell: primary frame ${e} is no longer owned`)}sortFrames(e,t){const r=Array.from(this.frames.values()).map((e=>e.frame)).sort(((r,a)=>r===e?-1:a===e?1:r===t?-1:a===t?1:r.zIndex-a.zIndex));for(let e=0;e<r.length;e++){const{style:t}=r[e];t.zIndex=-e,t.display="",t.setProperty("--tilt-z",-200*e+"px")}}receiveFromPortal(e,t,r,a){switch(r){case"frame-ready":{const t=e===this.primaryFrameId?"primary":"secondary";if(a.frameType!==t)return void console.log(`ignoring ${e} frame-ready (${a.frameType}) when expecting ${t}`);const r=this.frameEntry(e);if(!r)return;r.isMicroverse=!0;break}case"avatar-ready":{const t=e===this.primaryFrameId?"primary":"secondary";if(a.frameType!==t)return void console.log(`ignoring ${e} avatar-ready (${a.frameType}) when expecting ${t}`);const r=this.frameEntry(e);if(!r)return;return r.isMicroverse=!0,clearInterval(r.frameTypeInterval),r.frameTypeInterval=null,void(this.awaitedFrameTypes[e]&&(delete this.awaitedFrameTypes[e],0===Object.keys(this.awaitedFrameTypes).length&&this.sendToPortal(this.primaryFrameId,"release-freeze")))}case"portal-open":if(a.portalId){const e=portalToFrameURL(a.portalURL,a.portalId),t=this.frameEntry(a.portalId)?.frame;return void(t&&portalToFrameURL(t.src,a.portalId)!==e&&(console.warn("shell: portal-open",a.portalId,"replacing",t.src,"with",e),t.src=e))}let t=this.findFrame(a.portalURL,(e=>!e.owningFrame));return t?(this.frameEntry(t).owningFrame=e,this.frameEntry(e).ownedFrames.add(t)):t=this.addFrame(e,a.portalURL),this.sendToPortal(e,"portal-opened",{portalId:t}),void(e===this.primaryFrameId&&this.sortFrames(this.primaryFrame,this.frameFromId(t)));case"portal-close":return void this.removeFrame(a.portalId);case"portal-update":return e!==this.primaryFrameId?void console.log(`ignoring ${e} portal-update because it's no longer primary`):(this.awaitedRenders={},a.portalSpecs.forEach((e=>{const{portalId:t,cameraMatrix:r}=e;this.sendToPortal(t,"portal-camera-update",{cameraMatrix:r});const a=this.frameEntry(t);a&&!a.frameTypeInterval&&null!==r&&(this.awaitedRenders[t]=!0),this.portalData.set(t,r)})),void(!this.portalRenderTimeout&&Object.keys(this.awaitedRenders).length&&(this.portalRenderTimeout=setTimeout((()=>{console.log("shell: portal render timed out"),delete this.portalRenderTimeout,this.awaitedRenders={},this.manuallyRenderPrimaryFrame()}),200))));case"portal-world-rendered":return void(this.portalRenderTimeout&&this.awaitedRenders[e]&&(delete this.awaitedRenders[e],0===Object.keys(this.awaitedRenders).length&&(clearTimeout(this.portalRenderTimeout),delete this.portalRenderTimeout,this.manuallyRenderPrimaryFrame())));case"primary-rendered":return void(e===this.primaryFrameId?this.pendingSortFrames&&this.pendingSortFrames&&(this.sortFrames(...this.pendingSortFrames),delete this.pendingSortFrames):console.warn(`shell: ignoring primary-rendered from non-primary ${e}`));case"portal-enter":return void(e===this.primaryFrameId?this.activateFrame(a.portalId,!0,a.transferData):console.warn("shell: ignoring portal-enter from non-primary portal-"+e));case"world-enter":if(e===this.primaryFrameId){let e=this.findFrame(a.portalURL);e||(console.log("shell: world-enter creating frame for",a.portalURL),e=this.addFrame(this.primaryFrameId,a.portalURL)),this.activateFrame(e,!0,a.transferData)}else console.warn("shell: ignoring world-enter from non-primary portal-"+e);return;case"world-replace":if(e===this.primaryFrameId){console.log("shell: world-replace to "+a.targetURL),this.primaryFrame.style.background="black",this.primaryFrame.src="",this.primaryFrame.style.transition="opacity 1s",this.primaryFrame.style.opacity=0,this.removeFrame(this.primaryFrameId);let e=this.findFrame(a.targetURL);e||(console.log("shell: world-replace creating frame for",a.targetURL),e=this.addFrame(null,a.targetURL)),setTimeout((()=>{this.frameEntry(e).isMicroverse=!0,this.activateFrame(e,!0,a.transferData)}),1e3)}else console.warn("shell: ignoring world-replace from non-primary portal-"+e);return;case"hud":return void this.setButtonsVisibility(a);case"send-configuration":return void this.sendToPortal(e,"local-configuration",{localConfig:m});case"update-configuration":return console.log("updated config",a.localConfig),m=a.localConfig,m.userHasSet=!0,void function saveLocalStorage(e){if(!window.localStorage)return;try{let{nickname:t,type:r,avatarURL:a,handedness:s}=e,o={version:"1",nickname:t,type:r,avatarURL:a,handedness:s};window.localStorage.setItem("microverse-settings",JSON.stringify(o))}catch(e){}}(a.localConfig);default:console.warn(`shell: received unknown command "${r}" from portal-${e}`,a)}}setButtonsVisibility(e){let t=e.joystick,r=e.fullscreen;document.head.querySelector("#joystick-css")||(this._hudFlags={joystick:e.joystick,fullscreen:e.fullscreen}),-1!==navigator.userAgent.indexOf("OculusBrowser")&&(t=!1,r=!1),void 0!==t&&this.joystick&&(t?this.joystick.style.removeProperty("display"):this.joystick.style.setProperty("display","none")),void 0!==r&&this.fullscreenBtn&&(r?this.fullscreenBtn.style.removeProperty("display"):this.fullscreenBtn.style.setProperty("display","none"))}manuallyRenderPrimaryFrame(){const e=!!this.pendingSortFrames;this.sendToPortal(this.primaryFrameId,"sync-render-now",{acknowledgeReceipt:e})}findFrame(e,t=null){e=portalToFrameURL(e,"");const r=["debug"];e:for(const[a,s]of this.frames){if(t&&!t(s))continue;const{frame:o}=s;if(o.src===e)return a;const i=new URL(e,o.src);if(o.src===i.href)return a;const n=new URL(o.src);if(n.origin!==i.origin)continue;if(n.pathname!==i.pathname)continue;r.forEach((e=>n.searchParams.delete(e)));for(const[e,t]of i.searchParams){if(r.includes(e))continue;const a=n.searchParams.get(e);if(n.searchParams.delete(e),("portal"!==e&&"anchor"!==e||t&&a)&&a!==t)continue e}if(""!==n.searchParams.toString())continue;const l=new URLSearchParams(i.hash.slice(1)),c=new URLSearchParams(n.hash.slice(1));if(l.sort(),c.sort(),l.toString()===c.toString())return a}return null}sendToPortal(e,t,r={}){const a=this.frameFromId(e);a?(r.message=`${s}${t}`,a.contentWindow?.postMessage(r,"*")):console.warn(`shell: sending "${t}" to portal-${e} failed: portal not found`)}sendFrameType(e,t=null){const r=this.primaryFrameId&&this.primaryFrameId!==e?"secondary":"primary",a=this.frameEntry(e);if(a.frameTypeArgs={frameType:r,spec:t},a.frameTypeInterval)return;const s=Date.now();a.frameTypeInterval=setInterval((()=>{if(!this.frameEntry(e))return console.log(`shell: abandoning "frame-type" send for removed portal-${e}`),void clearInterval(a.frameTypeInterval);if(Date.now()-s>2e4&&!a.isMicroverse)return console.log(`shell: abandoning "frame-type" send for timed-out portal-${e}`),void clearInterval(a.frameTypeInterval);const t=a.frameTypeArgs;if("secondary"===t.frameType){const r=this.portalData.get(e);r&&(t.cameraMatrix=r)}this.sendToPortal(e,"frame-type",t)}),200)}activateFrame(e,t=!0,r=null){const a=this.frameEntry(e);if(!a.isMicroverse)return void(window.location.href=a.frame.src);const s=this.primaryFrameId,o=this.primaryFrame,i=this.frameFromId(e),n=frameToPortalURL(i.src);if(this.pendingSortFrames=[i,o],this.pendingSortTimeout&&clearTimeout(this.pendingSortTimeout),this.pendingSortTimeout=setTimeout((()=>{this.pendingSortFrames&&(console.warn("sorting frames after timeout"),this.sortFrames(...this.pendingSortFrames),delete this.pendingSortFrames)}),2e3),r&&!r.crossingBackwards&&(o.style.display="none"),t)try{window.history.pushState({portalId:e},null,n)}catch(t){new URL(n,location.href).origin===window.location.origin&&console.error(t),window.history.pushState({portalId:e},null,function portalToShellURL(e){const t=new URL(e,location.href),r=new URL(location.href);for(const[e,a]of t.searchParams)r.searchParams.set(e,a);return t.search="",r.hash=t.hash,t.hash="",r.searchParams.set("canonical",t.href),r.toString()}(n))}if(setTitle(n),this.primaryFrameId=e,this.portalData.delete(e),this.awaitedRenders={},this.awaitedFrameTypes={},this.frameEntry(s).owningFrame?(console.log(`shell: sending frame-type "secondary" to portal-${s}`,{portalURL:n}),this.sendFrameType(s,{portalURL:n}),this.awaitedFrameTypes[s]=!0):(console.log(`shell: removing unowned secondary frame ${s}`),this.removeFrame(s)),console.log(`shell: sending frame-type "primary" to portal-${e}`,r),this.primaryFrame.focus(),this.sendFrameType(e,r),this.awaitedFrameTypes[e]=!0,this.awaitedFramesTimeout&&clearTimeout(this.awaitedFramesTimeout),this.awaitedFramesTimeout=setTimeout((()=>{Object.keys(this.awaitedFrameTypes).length&&(console.warn("releasing freeze after timeout"),this.awaitedFrameTypes={},this.sendToPortal(this.primaryFrameId,"release-freeze"))}),2e3),this.activeMMotion){const{dx:e,dy:t}=this.activeMMotion;this.sendToPortal(this.primaryFrameId,"motion-start",{dx:e,dy:t})}}startMMotion(e){this.activeMMotion={},this.updateMMotion(e,"motion-start")}endMMotion(e){e.preventDefault(),e.stopPropagation(),this.activeMMotion=null;let{radius:t}=this.joystickLayout;this.trackingknob.style.transform="translate(0px, 0px)",this.knob.style.transform=`translate(${t}px, ${t}px)`,this.sendToPortal(this.primaryFrameId,"motion-end")}updateMMotion(e,t="motion-update"){if(e.preventDefault(),e.stopPropagation(),this.activeMMotion){let{center:r,radius:a}=this.joystickLayout,s=e.offsetX-r,o=e.offsetY-r;this.sendToPortal(this.primaryFrameId,t,{dx:s,dy:o}),this.activeMMotion.dx=s,this.activeMMotion.dy=o,this.trackingknob.style.transform=`translate(${s}px, ${o}px)`;let i=s**2+o**2;if(i>a**2){let e=Math.sqrt(i);s=a*s/e,o=a*o/e}this.knob.style.transform=`translate(${a+s}px, ${a+o}px)`}}}function portalToFrameURL(e,t){const r=new URL(e,location.href);r.searchParams.set("portal",t);"default"===r.searchParams.get("world")&&r.searchParams.delete("world");"index.html"===r.pathname.split("/").pop()&&(r.pathname=r.pathname.slice(0,-10));const a=[...r.searchParams.entries()].sort(((e,t)=>"world"===e[0]?-1:"world"===t[0]||"portal"===e[0]?1:"portal"===t[0]?-1:"q"===e[0]?1:"q"===t[0]||e[0]<t[0]?-1:1));return r.search=new URLSearchParams(a).toString(),r.toString()}function frameToPortalURL(e){const t=new URL(e,location.href);t.searchParams.delete("portal");"default"===t.searchParams.get("world")&&t.searchParams.delete("world");return"index.html"===t.pathname.split("/").pop()&&(t.pathname=t.pathname.slice(0,-10)),t.toString()}function shellToCanonicalURL(e){const t=new URL(e),r=t.searchParams.get("canonical");if(!r)return e;t.searchParams.delete("canonical");const a=new URL(r);return a.search=t.search,a.hash=t.hash,a.toString()}function setTitle(e){e=e.startsWith(location.origin)?e.substr(location.origin.length+1):e.substr(e.indexOf("://")+3),document.title=e}},3700:()=>{}}]);